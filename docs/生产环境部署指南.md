# 生产环境部署指南

## 维护管理

### 日常管理命令

```bash
# 查看服务状态
docker-compose ps

# 重启所有服务
docker-compose restart

# 重启单个服务
docker-compose restart backend

# 停止所有服务
docker-compose stop

# 启动所有服务
docker-compose start

# 完全停止并删除容器
docker-compose down

# 停止并删除所有数据(包括数据库)
docker-compose down -v
```

### 日志管理

```bash
# 查看最新100行日志
docker-compose logs --tail=100

# 实时查看日志
docker-compose logs -f

# 查看特定时间的日志
docker-compose logs --since 2025-10-28T10:00:00
```

### 数据库备份

```bash
# 创建备份目录
mkdir -p /opt/backups

# 备份数据库
docker exec mr_game_ops_db pg_dump -U mr_admin mr_game_ops > /opt/backups/backup_$(date +%Y%m%d_%H%M%S).sql

# 自动备份脚本
cat > /opt/backup_db.sh << 'BACKUP_EOF'
#!/bin/bash
BACKUP_DIR="/opt/backups"
RETENTION_DAYS=7

# 创建备份
docker exec mr_game_ops_db pg_dump -U mr_admin mr_game_ops | gzip > "$BACKUP_DIR/backup_$(date +%Y%m%d_%H%M%S).sql.gz"

# 删除旧备份
find "$BACKUP_DIR" -name "backup_*.sql.gz" -mtime +$RETENTION_DAYS -delete

echo "Backup completed: $(date)"
BACKUP_EOF

chmod +x /opt/backup_db.sh

# 添加到crontab (每天凌晨2点备份)
(crontab -l 2>/dev/null; echo "0 2 * * * /opt/backup_db.sh >> /var/log/db_backup.log 2>&1") | crontab -
```

### 数据库恢复

```bash
# 从备份恢复
gunzip < /opt/backups/backup_20251028_020000.sql.gz | docker exec -i mr_game_ops_db psql -U mr_admin -d mr_game_ops
```

### 更新部署

```bash
cd /opt/mr_gunking_user_system_spec

# 拉取最新代码
git pull origin main

# 切换到新版本
git checkout v1.0.1

# 重新构建并启动
docker-compose up -d --build

# 查看启动状态
docker-compose logs -f
```

### 资源监控

```bash
# 查看容器资源使用
docker stats

# 查看磁盘使用
docker system df

# 清理未使用的资源
docker system prune -a
```
