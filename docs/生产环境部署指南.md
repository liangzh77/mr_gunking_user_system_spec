# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

**ç‰ˆæœ¬**: v1.0.0-mvp
**æ›´æ–°æ—¥æœŸ**: 2025-10-28
**é€‚ç”¨ç³»ç»Ÿ**: Linux (Ubuntu 20.04+, CentOS 7+, Debian 10+)

---

## ğŸ“‹ ç›®å½•

1. [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
2. [æ¸…ç†æ—§ç¯å¢ƒ](#æ¸…ç†æ—§ç¯å¢ƒ)
3. [éƒ¨ç½²æ–°ç¯å¢ƒ](#éƒ¨ç½²æ–°ç¯å¢ƒ)
   - [åœ¨çº¿éƒ¨ç½²](#åœ¨çº¿éƒ¨ç½²-æ¨è)
   - [ç¦»çº¿éƒ¨ç½²](#ç¦»çº¿éƒ¨ç½²-é€‚ç”¨äºé˜¿é‡Œäº‘ç­‰ç½‘ç»œå—é™ç¯å¢ƒ)
4. [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
5. [å¯åŠ¨æœåŠ¡](#å¯åŠ¨æœåŠ¡)
6. [éªŒè¯éƒ¨ç½²](#éªŒè¯éƒ¨ç½²)
7. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
8. [ç»´æŠ¤ç®¡ç†](#ç»´æŠ¤ç®¡ç†)

---

## ç¯å¢ƒå‡†å¤‡

### ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Linux (æ¨è Ubuntu 20.04+ æˆ– CentOS 7+)
- **CPU**: 2æ ¸å¿ƒä»¥ä¸Š
- **å†…å­˜**: 4GBä»¥ä¸Š (æ¨è8GB)
- **ç£ç›˜**: 20GBä»¥ä¸Šå¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: å…¬ç½‘IPæˆ–åŸŸå

### å¿…éœ€è½¯ä»¶

1. **Docker** (ç‰ˆæœ¬ 20.10+)
2. **Docker Compose** (ç‰ˆæœ¬ 2.0+)
3. **Git**
4. **OpenSSL** (ç”¨äºç”Ÿæˆå¯†é’¥)

### å®‰è£…Dockerå’ŒDocker Compose

```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# å®‰è£… Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# éªŒè¯å®‰è£…
docker --version
docker-compose --version
```

### ç«¯å£è¦æ±‚

ç¡®ä¿ä»¥ä¸‹ç«¯å£å¼€æ”¾:

- **80**: HTTPè®¿é—® (å‰ç«¯)
- **443**: HTTPSè®¿é—® (å¦‚ä½¿ç”¨SSL)
- **8000**: åç«¯API (å¯é€‰,å¦‚éœ€å¤–éƒ¨è®¿é—®)
- **5432**: PostgreSQL (å†…éƒ¨ä½¿ç”¨,ä¸å»ºè®®å¯¹å¤–å¼€æ”¾)
- **6379**: Redis (å†…éƒ¨ä½¿ç”¨,ä¸å»ºè®®å¯¹å¤–å¼€æ”¾)

---

## æ¸…ç†æ—§ç¯å¢ƒ

å¦‚æœæœåŠ¡å™¨ä¸Šå·²æœ‰æ—§çš„éƒ¨ç½²,éœ€è¦å…ˆæ¸…ç†ã€‚

### æ–¹æ³•1: ä½¿ç”¨æ¸…ç†è„šæœ¬ (æ¨è)

```bash
# åˆ›å»ºæ¸…ç†è„šæœ¬
cat > /tmp/cleanup_production.sh << 'CLEANUP_EOF'
#!/bin/bash
# =============================================================================
# ç”Ÿäº§æœåŠ¡å™¨å®Œå…¨æ¸…ç†è„šæœ¬
# =============================================================================
# è­¦å‘Šï¼šæ­¤è„šæœ¬ä¼šåˆ é™¤æ‰€æœ‰Dockerå®¹å™¨ã€é•œåƒã€å·å’Œé¡¹ç›®æ–‡ä»¶
# ä½¿ç”¨å‰è¯·ç¡®è®¤å·²å¤‡ä»½é‡è¦æ•°æ®ï¼
# =============================================================================

set -e

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}========================================"
echo -e "  ç”Ÿäº§æœåŠ¡å™¨æ¸…ç†è„šæœ¬"
echo -e "========================================${NC}"
echo ""

# ç¡®è®¤æ“ä½œ
echo -e "${RED}è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤ä»¥ä¸‹å†…å®¹ï¼š${NC}"
echo "  1. æ‰€æœ‰Dockerå®¹å™¨ï¼ˆåŒ…æ‹¬è¿è¡Œä¸­çš„ï¼‰"
echo "  2. æ‰€æœ‰Dockeré•œåƒ"
echo "  3. æ‰€æœ‰Dockerå·ï¼ˆåŒ…æ‹¬æ•°æ®åº“æ•°æ®ï¼‰"
echo "  4. æ‰€æœ‰Dockerç½‘ç»œ"
echo "  5. é¡¹ç›®æºä»£ç ç›®å½•"
echo ""
echo -e "${YELLOW}å»ºè®®ï¼šåœ¨ç»§ç»­å‰å…ˆå¤‡ä»½æ•°æ®åº“${NC}"
echo ""
read -p "ç¡®å®šè¦ç»§ç»­å—ï¼Ÿè¾“å…¥ YES ç¡®è®¤ï¼š" confirm

if [ "$confirm" != "YES" ]; then
    echo -e "${GREEN}æ“ä½œå·²å–æ¶ˆ${NC}"
    exit 0
fi

echo ""
echo -e "${YELLOW}å¼€å§‹æ¸…ç†...${NC}"
echo ""

# 1. åœæ­¢æ‰€æœ‰å®¹å™¨
echo -e "${BLUE}[1/7] åœæ­¢æ‰€æœ‰Dockerå®¹å™¨...${NC}"
if [ "$(docker ps -q)" ]; then
    docker stop $(docker ps -q)
    echo -e "${GREEN}âœ“ å·²åœæ­¢æ‰€æœ‰å®¹å™¨${NC}"
else
    echo -e "${YELLOW}æ²¡æœ‰è¿è¡Œä¸­çš„å®¹å™¨${NC}"
fi

# 2. åˆ é™¤æ‰€æœ‰å®¹å™¨
echo -e "${BLUE}[2/7] åˆ é™¤æ‰€æœ‰Dockerå®¹å™¨...${NC}"
if [ "$(docker ps -aq)" ]; then
    docker rm -f $(docker ps -aq)
    echo -e "${GREEN}âœ“ å·²åˆ é™¤æ‰€æœ‰å®¹å™¨${NC}"
else
    echo -e "${YELLOW}æ²¡æœ‰å®¹å™¨éœ€è¦åˆ é™¤${NC}"
fi

# 3. åˆ é™¤æ‰€æœ‰é•œåƒ
echo -e "${BLUE}[3/7] åˆ é™¤æ‰€æœ‰Dockeré•œåƒ...${NC}"
if [ "$(docker images -q)" ]; then
    docker rmi -f $(docker images -q)
    echo -e "${GREEN}âœ“ å·²åˆ é™¤æ‰€æœ‰é•œåƒ${NC}"
else
    echo -e "${YELLOW}æ²¡æœ‰é•œåƒéœ€è¦åˆ é™¤${NC}"
fi

# 4. åˆ é™¤æ‰€æœ‰å·
echo -e "${BLUE}[4/7] åˆ é™¤æ‰€æœ‰Dockerå·...${NC}"
if [ "$(docker volume ls -q)" ]; then
    docker volume rm -f $(docker volume ls -q)
    echo -e "${GREEN}âœ“ å·²åˆ é™¤æ‰€æœ‰å·${NC}"
else
    echo -e "${YELLOW}æ²¡æœ‰å·éœ€è¦åˆ é™¤${NC}"
fi

# 5. åˆ é™¤æ‰€æœ‰ç½‘ç»œï¼ˆä¿ç•™é»˜è®¤ç½‘ç»œï¼‰
echo -e "${BLUE}[5/7] åˆ é™¤æ‰€æœ‰è‡ªå®šä¹‰Dockerç½‘ç»œ...${NC}"
if [ "$(docker network ls -q -f type=custom)" ]; then
    docker network rm $(docker network ls -q -f type=custom) 2>/dev/null || true
    echo -e "${GREEN}âœ“ å·²åˆ é™¤æ‰€æœ‰è‡ªå®šä¹‰ç½‘ç»œ${NC}"
else
    echo -e "${YELLOW}æ²¡æœ‰è‡ªå®šä¹‰ç½‘ç»œéœ€è¦åˆ é™¤${NC}"
fi

# 6. æ¸…ç†Dockerç³»ç»Ÿ
echo -e "${BLUE}[6/7] æ¸…ç†Dockerç³»ç»Ÿç¼“å­˜...${NC}"
docker system prune -af --volumes
echo -e "${GREEN}âœ“ å·²æ¸…ç†Dockerç³»ç»Ÿ${NC}"

# 7. åˆ é™¤é¡¹ç›®ä»£ç ç›®å½•
echo -e "${BLUE}[7/7] åˆ é™¤é¡¹ç›®ä»£ç ç›®å½•...${NC}"
if [ -d "$HOME/mr_gunking_user_system_spec" ]; then
    rm -rf "$HOME/mr_gunking_user_system_spec"
    echo -e "${GREEN}âœ“ å·²åˆ é™¤ ~/mr_gunking_user_system_spec${NC}"
fi

if [ -d "/opt/mr_gunking_user_system_spec" ]; then
    sudo rm -rf "/opt/mr_gunking_user_system_spec"
    echo -e "${GREEN}âœ“ å·²åˆ é™¤ /opt/mr_gunking_user_system_spec${NC}"
fi

# æŸ¥æ‰¾å¹¶åˆ é™¤æ‰€æœ‰å¯èƒ½çš„é¡¹ç›®ç›®å½•
echo -e "${YELLOW}æŸ¥æ‰¾å…¶ä»–å¯èƒ½çš„é¡¹ç›®ç›®å½•...${NC}"
find ~ -maxdepth 2 -name "mr_gunking_user_system_spec" -type d 2>/dev/null | while read dir; do
    echo -e "${YELLOW}æ‰¾åˆ°: $dir${NC}"
    read -p "æ˜¯å¦åˆ é™¤ $dir? (y/n): " del_confirm
    if [ "$del_confirm" = "y" ]; then
        rm -rf "$dir"
        echo -e "${GREEN}âœ“ å·²åˆ é™¤ $dir${NC}"
    fi
done

echo ""
echo -e "${BLUE}========================================"
echo -e "  æ¸…ç†å®Œæˆï¼"
echo -e "========================================${NC}"
echo ""
echo -e "${GREEN}å·²æ¸…ç†å†…å®¹ï¼š${NC}"
echo "  âœ“ Dockerå®¹å™¨"
echo "  âœ“ Dockeré•œåƒ"
echo "  âœ“ Dockerå·ï¼ˆåŒ…æ‹¬æ•°æ®ï¼‰"
echo "  âœ“ Dockerç½‘ç»œ"
echo "  âœ“ é¡¹ç›®æºä»£ç "
echo ""
echo -e "${YELLOW}éªŒè¯æ¸…ç†ç»“æœï¼š${NC}"
echo "  docker ps -a        # åº”è¯¥ä¸ºç©º"
echo "  docker images       # åº”è¯¥ä¸ºç©º"
echo "  docker volume ls    # åº”è¯¥ä¸ºç©º"
echo "  docker network ls   # åªæœ‰é»˜è®¤ç½‘ç»œ"
echo ""
echo -e "${GREEN}æœåŠ¡å™¨å·²æ¸…ç†å¹²å‡€ï¼Œå¯ä»¥é‡æ–°éƒ¨ç½²ï¼${NC}"
echo ""
CLEANUP_EOF

# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x /tmp/cleanup_production.sh

# æ‰§è¡Œæ¸…ç†è„šæœ¬
/tmp/cleanup_production.sh
```

### æ–¹æ³•2: æ‰‹åŠ¨æ¸…ç†

```bash
# åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰å®¹å™¨
docker stop $(docker ps -aq)
docker rm -f $(docker ps -aq)

# åˆ é™¤æ‰€æœ‰é•œåƒ
docker rmi -f $(docker images -q)

# åˆ é™¤æ‰€æœ‰å·
docker volume rm -f $(docker volume ls -q)

# åˆ é™¤è‡ªå®šä¹‰ç½‘ç»œ
docker network prune -f

# æ¸…ç†ç³»ç»Ÿ
docker system prune -af --volumes

# åˆ é™¤é¡¹ç›®ç›®å½•
sudo rm -rf /opt/mr_gunking_user_system_spec
```

### éªŒè¯æ¸…ç†ç»“æœ

```bash
docker ps -a        # åº”è¯¥ä¸ºç©º
docker images       # åº”è¯¥ä¸ºç©º
docker volume ls    # åº”è¯¥ä¸ºç©º
docker network ls   # åªæœ‰é»˜è®¤ç½‘ç»œ (bridge, host, none)
```

---

## éƒ¨ç½²æ–°ç¯å¢ƒ

### 1. å…‹éš†ä»£ç 

**æ¨èä½ç½®**: `/opt/mr_gunking_user_system_spec`

```bash
# è¿›å…¥/optç›®å½•
cd /opt

# å…‹éš†ä»£ç 
git clone https://github.com/liangzh77/mr_gunking_user_system_spec.git

# è¿›å…¥é¡¹ç›®ç›®å½•
cd mr_gunking_user_system_spec

# åˆ‡æ¢åˆ°MVPç‰ˆæœ¬
git checkout v1.0.0-mvp

# è®¾ç½®æƒé™
chown -R root:root /opt/mr_gunking_user_system_spec
chmod -R 755 /opt/mr_gunking_user_system_spec
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

#### æ–¹æ³•A: ä½¿ç”¨è‡ªåŠ¨é…ç½®è„šæœ¬ (æ¨è)

```bash
cd /opt/mr_gunking_user_system_spec

# åˆ›å»ºè‡ªåŠ¨é…ç½®è„šæœ¬
cat > configure_env.sh << 'EOF'
#!/bin/bash
set -e

echo "=========================================="
echo "  ç”Ÿäº§ç¯å¢ƒé…ç½®ç”Ÿæˆå™¨"
echo "=========================================="
echo ""

# ç”Ÿæˆéšæœºå¯†é’¥
echo "æ­£åœ¨ç”Ÿæˆå®‰å…¨å¯†é’¥..."
DB_PASSWORD=$(openssl rand -base64 24 | tr -d '/+=' | head -c 32)
REDIS_PASSWORD=$(openssl rand -base64 18 | tr -d '/+=' | head -c 24)
SECRET_KEY=$(openssl rand -hex 32)
JWT_SECRET_KEY=$(openssl rand -hex 32)
ENCRYPTION_KEY=$(openssl rand -base64 32)

echo "âœ“ å¯†é’¥ç”Ÿæˆå®Œæˆ"
echo ""

# è¯¢é—®æœåŠ¡å™¨ä¿¡æ¯
read -p "è¯·è¾“å…¥æœåŠ¡å™¨IPåœ°å€æˆ–åŸŸå: " SERVER_HOST
read -p "æ˜¯å¦ä½¿ç”¨HTTPS? (y/n, é»˜è®¤n): " USE_HTTPS
USE_HTTPS=${USE_HTTPS:-n}

if [ "$USE_HTTPS" = "y" ]; then
    PROTOCOL="https"
else
    PROTOCOL="http"
fi

# ç”Ÿæˆé…ç½®æ–‡ä»¶
echo "æ­£åœ¨ç”Ÿæˆ .env.production ..."

cp .env.production.template .env.production

# æ›¿æ¢å¯†é’¥
sed -i "s|DB_PASSWORD=CHANGE_THIS_TO_STRONG_PASSWORD_32CHARS|DB_PASSWORD=$DB_PASSWORD|g" .env.production
sed -i "s|REDIS_PASSWORD=CHANGE_THIS_TO_STRONG_REDIS_PASSWORD|REDIS_PASSWORD=$REDIS_PASSWORD|g" .env.production
sed -i "s|SECRET_KEY=CHANGE_THIS_TO_RANDOM_SECRET_KEY_64_CHARS|SECRET_KEY=$SECRET_KEY|g" .env.production
sed -i "s|JWT_SECRET_KEY=CHANGE_THIS_TO_RANDOM_JWT_SECRET_KEY_64_CHARS|JWT_SECRET_KEY=$JWT_SECRET_KEY|g" .env.production
sed -i "s|ENCRYPTION_KEY=CHANGE_THIS_TO_32_BYTES_ENCRYPTION_KEY|ENCRYPTION_KEY=$ENCRYPTION_KEY|g" .env.production

# æ›´æ–°DATABASE_URL
sed -i "s|postgresql+asyncpg://mr_admin:CHANGE_THIS_TO_STRONG_PASSWORD_32CHARS@|postgresql+asyncpg://mr_admin:$DB_PASSWORD@|g" .env.production
sed -i "s|redis://:CHANGE_THIS_TO_STRONG_REDIS_PASSWORD@|redis://:$REDIS_PASSWORD@|g" .env.production

# æ›´æ–°åŸŸå/IP
sed -i "s|BACKEND_CORS_ORIGINS=https://yourdomain.com,https://www.yourdomain.com|BACKEND_CORS_ORIGINS=$PROTOCOL://$SERVER_HOST,$PROTOCOL://www.$SERVER_HOST|g" .env.production
sed -i "s|VITE_API_BASE_URL=https://yourdomain.com/api/v1|VITE_API_BASE_URL=$PROTOCOL://$SERVER_HOST/api/v1|g" .env.production

echo "âœ“ é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
echo ""

# ä¿å­˜å¯†é’¥åˆ°æ–‡ä»¶
CREDENTIALS_FILE="production_credentials_$(date +%Y%m%d_%H%M%S).txt"
cat > "$CREDENTIALS_FILE" << CRED_EOF
========================================
  MRæ¸¸æˆè¿è¥ç®¡ç†ç³»ç»Ÿ - ç”Ÿäº§ç¯å¢ƒå‡­æ®
========================================
ç”Ÿæˆæ—¶é—´: $(date)
æœåŠ¡å™¨: $PROTOCOL://$SERVER_HOST

æ•°æ®åº“å‡­æ®:
-----------
ç”¨æˆ·å: mr_admin
å¯†ç : $DB_PASSWORD

Rediså‡­æ®:
-----------
å¯†ç : $REDIS_PASSWORD

åº”ç”¨å¯†é’¥:
-----------
SECRET_KEY: $SECRET_KEY
JWT_SECRET_KEY: $JWT_SECRET_KEY
ENCRYPTION_KEY: $ENCRYPTION_KEY

========================================
âš ï¸ é‡è¦æç¤º:
1. è¯·å¦¥å–„ä¿ç®¡æ­¤æ–‡ä»¶
2. ä¸è¦å°†æ­¤æ–‡ä»¶ä¸Šä¼ åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ
3. å»ºè®®å°†æ­¤æ–‡ä»¶ä¿å­˜åˆ°å®‰å…¨çš„å¯†ç ç®¡ç†å™¨
4. é…ç½®å®Œæˆåå¯åˆ é™¤æ­¤æ–‡ä»¶
========================================
CRED_EOF

chmod 600 "$CREDENTIALS_FILE"

echo "=========================================="
echo "  é…ç½®æ‘˜è¦"
echo "=========================================="
echo "æœåŠ¡å™¨åœ°å€: $PROTOCOL://$SERVER_HOST"
echo "é…ç½®æ–‡ä»¶: .env.production"
echo "å‡­æ®æ–‡ä»¶: $CREDENTIALS_FILE"
echo ""
echo "âš ï¸ é‡è¦: å‡­æ®å·²ä¿å­˜åˆ° $CREDENTIALS_FILE"
echo "   è¯·å¦¥å–„ä¿ç®¡æ­¤æ–‡ä»¶ï¼"
echo ""
EOF

chmod +x configure_env.sh

# æ‰§è¡Œé…ç½®è„šæœ¬
./configure_env.sh
```

#### æ–¹æ³•B: æ‰‹åŠ¨é…ç½®

```bash
cd /opt/mr_gunking_user_system_spec

# 1. ç”Ÿæˆå¯†é’¥
DB_PASSWORD=$(openssl rand -base64 24 | tr -d '/+=' | head -c 32)
REDIS_PASSWORD=$(openssl rand -base64 18 | tr -d '/+=' | head -c 24)
SECRET_KEY=$(openssl rand -hex 32)
JWT_SECRET_KEY=$(openssl rand -hex 32)
ENCRYPTION_KEY=$(openssl rand -base64 32)

# 2. æ˜¾ç¤ºç”Ÿæˆçš„å¯†é’¥ï¼ˆè¯·ä¿å­˜ï¼‰
echo "æ•°æ®åº“å¯†ç : $DB_PASSWORD"
echo "Rediså¯†ç : $REDIS_PASSWORD"
echo "SECRET_KEY: $SECRET_KEY"
echo "JWT_SECRET_KEY: $JWT_SECRET_KEY"
echo "ENCRYPTION_KEY: $ENCRYPTION_KEY"

# 3. å¤åˆ¶æ¨¡æ¿æ–‡ä»¶
cp .env.production.template .env.production

# 4. ç¼–è¾‘é…ç½®æ–‡ä»¶
nano .env.production
```

**æ‰‹åŠ¨ç¼–è¾‘æ—¶éœ€è¦ä¿®æ”¹çš„å†…å®¹**:

```bash
# æ•°æ®åº“é…ç½®
DB_PASSWORD=<ç²˜è´´ä¸Šé¢ç”Ÿæˆçš„DB_PASSWORD>
DATABASE_URL=postgresql+asyncpg://mr_admin:<DB_PASSWORD>@postgres:5432/mr_game_ops

# Redisé…ç½®
REDIS_PASSWORD=<ç²˜è´´ä¸Šé¢ç”Ÿæˆçš„REDIS_PASSWORD>
REDIS_URL=redis://:<REDIS_PASSWORD>@redis:6379/0

# å®‰å…¨é…ç½®
SECRET_KEY=<ç²˜è´´ä¸Šé¢ç”Ÿæˆçš„SECRET_KEY>
JWT_SECRET_KEY=<ç²˜è´´ä¸Šé¢ç”Ÿæˆçš„JWT_SECRET_KEY>
ENCRYPTION_KEY=<ç²˜è´´ä¸Šé¢ç”Ÿæˆçš„ENCRYPTION_KEY>

# CORSé…ç½®ï¼ˆä¿®æ”¹ä¸ºå®é™…åŸŸåæˆ–IPï¼‰
BACKEND_CORS_ORIGINS=http://ä½ çš„æœåŠ¡å™¨IP,http://www.ä½ çš„æœåŠ¡å™¨IP

# å‰ç«¯APIåœ°å€ï¼ˆä¿®æ”¹ä¸ºå®é™…åŸŸåæˆ–IPï¼‰
VITE_API_BASE_URL=http://ä½ çš„æœåŠ¡å™¨IP/api/v1
```

---

## é…ç½®è¯´æ˜

### æ ¸å¿ƒé…ç½®é¡¹

| é…ç½®é¡¹ | è¯´æ˜ | ç¤ºä¾‹å€¼ | æ˜¯å¦å¿…æ”¹ |
|--------|------|--------|----------|
| `DB_PASSWORD` | æ•°æ®åº“å¯†ç  | éšæœºç”Ÿæˆçš„32å­—ç¬¦å¯†ç  | âœ… æ˜¯ |
| `REDIS_PASSWORD` | Rediså¯†ç  | éšæœºç”Ÿæˆçš„24å­—ç¬¦å¯†ç  | âœ… æ˜¯ |
| `SECRET_KEY` | åº”ç”¨å¯†é’¥ | 64å­—ç¬¦åå…­è¿›åˆ¶ | âœ… æ˜¯ |
| `JWT_SECRET_KEY` | JWTå¯†é’¥ | 64å­—ç¬¦åå…­è¿›åˆ¶ | âœ… æ˜¯ |
| `ENCRYPTION_KEY` | åŠ å¯†å¯†é’¥ | 32å­—èŠ‚base64 | âœ… æ˜¯ |
| `BACKEND_CORS_ORIGINS` | å…è®¸çš„å‰ç«¯åŸŸå | `http://192.168.1.100` | âœ… æ˜¯ |
| `VITE_API_BASE_URL` | å‰ç«¯APIåœ°å€ | `http://192.168.1.100/api/v1` | âœ… æ˜¯ |
| `DEBUG` | è°ƒè¯•æ¨¡å¼ | `false` | âŒ ä¿æŒ |
| `ENVIRONMENT` | ç¯å¢ƒæ ‡è¯† | `production` | âŒ ä¿æŒ |
| `LOG_LEVEL` | æ—¥å¿—çº§åˆ« | `WARNING` | âŒ ä¿æŒ |

### å¯é€‰é…ç½®é¡¹

**æ”¯ä»˜å¹³å°é…ç½®** (å¦‚æš‚æ—¶ä¸éœ€è¦æ”¯ä»˜åŠŸèƒ½,å¯ç•™ç©º):

```bash
WECHAT_PAY_APP_ID=
WECHAT_PAY_MCH_ID=
WECHAT_PAY_API_KEY=

ALIPAY_APP_ID=
ALIPAY_PRIVATE_KEY=
ALIPAY_PUBLIC_KEY=
```

---

## å¯åŠ¨æœåŠ¡

### ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒé…ç½®å¯åŠ¨

```bash
cd /opt/mr_gunking_user_system_spec

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml up -d --build
```

### æŸ¥çœ‹å¯åŠ¨æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f backend
docker-compose -f docker-compose.prod.yml logs -f frontend
docker-compose -f docker-compose.prod.yml logs -f postgres
```

### æŸ¥çœ‹å®¹å™¨çŠ¶æ€

```bash
docker-compose -f docker-compose.prod.yml ps
```

é¢„æœŸè¾“å‡º:
```
NAME                        STATUS         PORTS
mr_game_ops_backend        Up (healthy)   0.0.0.0:8000->8000/tcp
mr_game_ops_db             Up (healthy)   0.0.0.0:5432->5432/tcp
mr_game_ops_frontend       Up             0.0.0.0:80->80/tcp
mr_game_ops_redis          Up (healthy)   0.0.0.0:6379->6379/tcp
mr_game_ops_pgadmin        Up             0.0.0.0:5050->80/tcp
mr_game_ops_redis_commander Up (healthy)  0.0.0.0:8081->8081/tcp
```

---

## éªŒè¯éƒ¨ç½²

### 1. å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€
curl http://localhost:8000/health

# é¢„æœŸè¾“å‡º
{"status":"healthy","version":"1.0.0","environment":"production"}
```

### 2. è®¿é—®å‰ç«¯

åœ¨æµè§ˆå™¨ä¸­è®¿é—®:
```
http://ä½ çš„æœåŠ¡å™¨IP
```

### 3. è®¿é—®APIæ–‡æ¡£

```
http://ä½ çš„æœåŠ¡å™¨IP:8000/docs
```

### 4. æ•°æ®åº“è¿æ¥æµ‹è¯•

```bash
# è¿›å…¥æ•°æ®åº“å®¹å™¨
docker exec -it mr_game_ops_db psql -U mr_admin -d mr_game_ops

# æŸ¥çœ‹è¡¨
\dt

# é€€å‡º
\q
```

### 5. Redisè¿æ¥æµ‹è¯•

```bash
# è¿›å…¥Rediså®¹å™¨
docker exec -it mr_game_ops_redis redis-cli -a ä½ çš„REDIS_PASSWORD

# æµ‹è¯•
PING
# é¢„æœŸè¾“å‡º: PONG

# é€€å‡º
exit
```

---

## å¸¸è§é—®é¢˜

### Q1: å®¹å™¨å¯åŠ¨å¤±è´¥

**ç—‡çŠ¶**: `docker-compose ps` æ˜¾ç¤ºå®¹å™¨çŠ¶æ€ä¸º `Exit` æˆ– `Restarting`

**è§£å†³æ–¹æ³•**:
```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs backend
docker-compose -f docker-compose.prod.yml logs postgres

# å¸¸è§åŸå› :
# 1. æ•°æ®åº“å¯†ç é…ç½®ä¸ä¸€è‡´
# 2. ç«¯å£è¢«å ç”¨
# 3. å†…å­˜ä¸è¶³
```

### Q2: æ•°æ®åº“è¿æ¥å¤±è´¥

**ç—‡çŠ¶**: åç«¯æ—¥å¿—æ˜¾ç¤º `could not connect to server`

**è§£å†³æ–¹æ³•**:
```bash
# æ£€æŸ¥æ•°æ®åº“å¯†ç æ˜¯å¦ä¸€è‡´
grep DB_PASSWORD .env.production
grep DATABASE_URL .env.production

# ç¡®ä¿ä¸¤å¤„å¯†ç ä¸€è‡´
```

### Q3: CORSé”™è¯¯

**ç—‡çŠ¶**: å‰ç«¯è®¿é—®APIæ—¶æŠ¥CORSé”™è¯¯

**è§£å†³æ–¹æ³•**:
```bash
# æ£€æŸ¥CORSé…ç½®
grep BACKEND_CORS_ORIGINS .env.production

# ç¡®ä¿åŒ…å«å‰ç«¯è®¿é—®åœ°å€
# ä¾‹å¦‚: BACKEND_CORS_ORIGINS=http://192.168.1.100,http://localhost
```

### Q4: å‰ç«¯æ— æ³•è¿æ¥åç«¯

**ç—‡çŠ¶**: å‰ç«¯é¡µé¢åŠ è½½æ­£å¸¸,ä½†APIè¯·æ±‚å¤±è´¥

**è§£å†³æ–¹æ³•**:
```bash
# æ£€æŸ¥å‰ç«¯APIé…ç½®
grep VITE_API_BASE_URL .env.production

# ç¡®ä¿åœ°å€æ­£ç¡®
# ä¾‹å¦‚: VITE_API_BASE_URL=http://192.168.1.100/api/v1

# é‡æ–°æ„å»ºå‰ç«¯
docker-compose -f docker-compose.prod.yml up -d --build frontend
```

### Q5: ç«¯å£è¢«å ç”¨

**ç—‡çŠ¶**: `Error: Bind for 0.0.0.0:80 failed: port is already allocated`

**è§£å†³æ–¹æ³•**:
```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
sudo netstat -tlnp | grep :80

# åœæ­¢å ç”¨ç«¯å£çš„æœåŠ¡
sudo systemctl stop nginx  # å¦‚æœæ˜¯nginx
sudo systemctl stop apache2  # å¦‚æœæ˜¯apache

# æˆ–ä¿®æ”¹docker-compose.prod.ymlä¸­çš„ç«¯å£æ˜ å°„
```

---

## ç»´æŠ¤ç®¡ç†

### æ—¥å¸¸ç®¡ç†å‘½ä»¤

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml restart

# é‡å¯å•ä¸ªæœåŠ¡
docker-compose -f docker-compose.prod.yml restart backend

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml stop

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml start

# å®Œå…¨åœæ­¢å¹¶åˆ é™¤å®¹å™¨
docker-compose -f docker-compose.prod.yml down

# åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰æ•°æ®(åŒ…æ‹¬æ•°æ®åº“)
docker-compose -f docker-compose.prod.yml down -v
```

### æ—¥å¿—ç®¡ç†

```bash
# æŸ¥çœ‹æœ€æ–°100è¡Œæ—¥å¿—
docker-compose -f docker-compose.prod.yml logs --tail=100

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f

# æŸ¥çœ‹ç‰¹å®šæ—¶é—´çš„æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs --since 2025-10-28T10:00:00
```

### æ•°æ®åº“å¤‡ä»½

```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p /opt/backups

# å¤‡ä»½æ•°æ®åº“
docker exec mr_game_ops_db pg_dump -U mr_admin mr_game_ops > /opt/backups/backup_$(date +%Y%m%d_%H%M%S).sql

# è‡ªåŠ¨å¤‡ä»½è„šæœ¬
cat > /opt/backup_db.sh << 'BACKUP_EOF'
#!/bin/bash
BACKUP_DIR="/opt/backups"
RETENTION_DAYS=7

# åˆ›å»ºå¤‡ä»½
docker exec mr_game_ops_db pg_dump -U mr_admin mr_game_ops | gzip > "$BACKUP_DIR/backup_$(date +%Y%m%d_%H%M%S).sql.gz"

# åˆ é™¤æ—§å¤‡ä»½
find "$BACKUP_DIR" -name "backup_*.sql.gz" -mtime +$RETENTION_DAYS -delete

echo "Backup completed: $(date)"
BACKUP_EOF

chmod +x /opt/backup_db.sh

# æ·»åŠ åˆ°crontab (æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½)
(crontab -l 2>/dev/null; echo "0 2 * * * /opt/backup_db.sh >> /var/log/db_backup.log 2>&1") | crontab -
```

### æ•°æ®åº“æ¢å¤

```bash
# ä»å¤‡ä»½æ¢å¤
gunzip < /opt/backups/backup_20251028_020000.sql.gz | docker exec -i mr_game_ops_db psql -U mr_admin -d mr_game_ops
```

### æ›´æ–°éƒ¨ç½²

```bash
cd /opt/mr_gunking_user_system_spec

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# åˆ‡æ¢åˆ°æ–°ç‰ˆæœ¬
git checkout v1.0.1

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose -f docker-compose.prod.yml up -d --build

# æŸ¥çœ‹å¯åŠ¨çŠ¶æ€
docker-compose -f docker-compose.prod.yml logs -f
```

### èµ„æºç›‘æ§

```bash
# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
docker system df

# æ¸…ç†æœªä½¿ç”¨çš„èµ„æº
docker system prune -a
```

---

## å®‰å…¨å»ºè®®

### 1. é˜²ç«å¢™é…ç½®

```bash
# Ubuntu/Debian
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# CentOS/RHEL
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 2. SSL/TLSé…ç½®

æ¨èä½¿ç”¨ Let's Encrypt å…è´¹è¯ä¹¦:

```bash
# å®‰è£… certbot
sudo apt-get install certbot

# è·å–è¯ä¹¦
sudo certbot certonly --standalone -d yourdomain.com

# è¯ä¹¦ä½ç½®
# /etc/letsencrypt/live/yourdomain.com/fullchain.pem
# /etc/letsencrypt/live/yourdomain.com/privkey.pem

# è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

### 3. å¯†ç ç®¡ç†

- å®šæœŸæ›´æ¢æ•°æ®åº“å’ŒRediså¯†ç 
- ä½¿ç”¨å¼ºå¯†ç (è‡³å°‘32å­—ç¬¦,åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦)
- ä¸è¦åœ¨æ—¥å¿—ä¸­è®°å½•å¯†ç 
- ä½¿ç”¨ç¯å¢ƒå˜é‡è€Œä¸æ˜¯ç¡¬ç¼–ç 

### 4. è®¿é—®æ§åˆ¶

```bash
# é™åˆ¶æ•°æ®åº“å’ŒRedisä»…å†…éƒ¨è®¿é—®
# åœ¨ docker-compose.prod.yml ä¸­ç§»é™¤ç«¯å£æ˜ å°„
# æˆ–ä½¿ç”¨é˜²ç«å¢™è§„åˆ™é™åˆ¶å¤–éƒ¨è®¿é—®
```

---

## é™„å½•

### A. ç›®å½•ç»“æ„

```
/opt/mr_gunking_user_system_spec/
â”œâ”€â”€ backend/                # åç«¯ä»£ç 
â”œâ”€â”€ frontend/              # å‰ç«¯ä»£ç 
â”œâ”€â”€ docker-compose.prod.yml # ç”Ÿäº§ç¯å¢ƒDockeré…ç½®
â”œâ”€â”€ .env.production        # ç”Ÿäº§ç¯å¢ƒå˜é‡(ä¸æäº¤åˆ°Git)
â”œâ”€â”€ .env.production.template # ç¯å¢ƒå˜é‡æ¨¡æ¿
â””â”€â”€ configure_env.sh       # è‡ªåŠ¨é…ç½®è„šæœ¬
```

### B. ç¯å¢ƒå˜é‡å®Œæ•´åˆ—è¡¨

å‚è€ƒ `.env.production.template` æ–‡ä»¶ä¸­çš„è¯¦ç»†è¯´æ˜ã€‚

### C. APIç«¯ç‚¹

| ç«¯ç‚¹ | è¯´æ˜ |
|------|------|
| `/health` | å¥åº·æ£€æŸ¥ |
| `/api/v1/docs` | APIæ–‡æ¡£ |
| `/api/v1/admins/*` | ç®¡ç†å‘˜API |
| `/api/v1/finance/*` | è´¢åŠ¡API |
| `/api/v1/operators/*` | è¿è¥å•†API |

### D. è”ç³»æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜,è¯·è®¿é—®:
- GitHub Issues: https://github.com/liangzh77/mr_gunking_user_system_spec/issues
- é¡¹ç›®æ–‡æ¡£: https://github.com/liangzh77/mr_gunking_user_system_spec/tree/main/docs

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0
**æœ€åæ›´æ–°**: 2025-10-28
**ç»´æŠ¤è€…**: liangzh77
