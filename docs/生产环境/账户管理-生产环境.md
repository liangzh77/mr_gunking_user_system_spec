# MR游戏运营管理系统 - 生产环境账户管理手册

## 目录
- [概述](#概述)
- [初始管理员账户](#初始管理员账户)
- [查看所有账户](#查看所有账户)
- [创建管理员账户](#创建管理员账户)
- [修改管理员密码](#修改管理员密码)
- [创建运营商账户](#创建运营商账户)
- [账户权限管理](#账户权限管理)
- [常见问题](#常见问题)

---

## 概述

本手册适用于**生产环境（Docker部署）**的账户管理。系统包含两类账户：
- **管理员账户（Admin）**: 系统管理员，负责运营商管理、应用授权等
- **运营商账户（Operator）**: 游戏厅运营商，使用系统进行日常运营

---

## 初始管理员账户

### 默认账户信息

系统首次启动时会自动创建两个管理员账户：

| 用户名 | 密码 | 角色 | 说明 |
|--------|------|------|------|
| `superadmin` | `Admin123!@#` | super_admin | 超级管理员，拥有所有权限 |
| `testadmin` | `Test123!@#` | admin | 测试管理员，用于测试 |

### 首次登录

1. 打开浏览器，访问：`http://服务器IP地址`
2. 使用超级管理员账户登录：
   - 用户名：`superadmin`
   - 密码：`Admin123!@#`
3. **强烈建议首次登录后立即修改密码！**

---

## 查看所有账户

### 方法1：通过数据库直接查询

进入后端容器查询数据库：

```bash
# 1. 进入后端容器
docker exec -it mr_game_ops_backend_prod /bin/bash

# 2. 启动 Python REPL
python3

# 3. 执行查询脚本
```

```python
import asyncio
from sqlalchemy import select, text
from src.db.session import init_db, get_db_context
from src.models.admin import AdminAccount
from src.models.operator import OperatorAccount

async def list_accounts():
    init_db()
    async with get_db_context() as session:
        # 查询管理员账户
        print("=" * 80)
        print("管理员账户列表")
        print("=" * 80)
        result = await session.execute(select(AdminAccount))
        admins = result.scalars().all()

        for admin in admins:
            status = "✅ 激活" if admin.is_active else "❌ 禁用"
            print(f"\n用户名: {admin.username}")
            print(f"  姓名: {admin.full_name}")
            print(f"  邮箱: {admin.email}")
            print(f"  角色: {admin.role}")
            print(f"  状态: {status}")
            print(f"  创建时间: {admin.created_at}")

        # 查询运营商账户
        print("\n" + "=" * 80)
        print("运营商账户列表")
        print("=" * 80)
        result = await session.execute(select(OperatorAccount))
        operators = result.scalars().all()

        for op in operators:
            status = "✅ 激活" if op.is_active else "❌ 禁用"
            print(f"\n用户名: {op.username}")
            print(f"  姓名: {op.full_name}")
            print(f"  邮箱: {op.email}")
            print(f"  电话: {op.phone}")
            print(f"  余额: ¥{op.balance}")
            print(f"  状态: {status}")
            print(f"  创建时间: {op.created_at}")

# 运行查询
asyncio.run(list_accounts())
```

按 `Ctrl+D` 退出 Python，然后 `exit` 退出容器。

### 方法2：使用SQL直接查询

```bash
# 进入 postgres 容器
docker exec -it mr_game_ops_db_prod psql -U mr_admin -d mr_game_ops

# 查询管理员账户
SELECT username, full_name, email, role, is_active, created_at
FROM admin_accounts
ORDER BY created_at DESC;

# 查询运营商账户
SELECT username, full_name, email, phone, balance, is_active, created_at
FROM operator_accounts
ORDER BY created_at DESC;

# 退出
\q
```

---

## 创建管理员账户

### 方法1：使用 Python 脚本（推荐）

创建一个临时脚本文件：

```bash
# 在服务器上创建脚本
cat > /tmp/create_admin.py << 'EOF'
#!/usr/bin/env python3
"""创建新的管理员账户"""

import asyncio
import sys
from pathlib import Path

sys.path.insert(0, '/app')

from sqlalchemy import select
from src.db.session import init_db, get_db_context
from src.models.admin import AdminAccount
from src.core.utils.password import hash_password

async def create_admin_account(username, password, full_name, email, phone, role='admin'):
    init_db()
    async with get_db_context() as session:
        # 检查用户名是否已存在
        result = await session.execute(
            select(AdminAccount).where(AdminAccount.username == username)
        )
        if result.scalar_one_or_none():
            print(f"❌ 用户名 '{username}' 已存在！")
            return False

        # 创建新管理员
        admin = AdminAccount(
            username=username,
            password_hash=hash_password(password),
            full_name=full_name,
            email=email,
            phone=phone,
            role=role,
            permissions={},
            is_active=True,
        )

        session.add(admin)
        await session.commit()

        print("✅ 管理员账户创建成功！")
        print(f"  用户名: {username}")
        print(f"  密码: {password}")
        print(f"  姓名: {full_name}")
        print(f"  角色: {role}")
        return True

if __name__ == "__main__":
    # 交互式输入
    print("=== 创建新管理员账户 ===\n")
    username = input("用户名: ").strip()
    password = input("密码: ").strip()
    full_name = input("姓名: ").strip()
    email = input("邮箱: ").strip()
    phone = input("电话: ").strip()

    print("\n角色选择:")
    print("  1. super_admin (超级管理员)")
    print("  2. admin (普通管理员)")
    role_choice = input("请选择 [1/2]: ").strip()
    role = "super_admin" if role_choice == "1" else "admin"

    success = asyncio.run(create_admin_account(username, password, full_name, email, phone, role))
    sys.exit(0 if success else 1)
EOF

# 复制脚本到容器并执行
docker cp /tmp/create_admin.py mr_game_ops_backend_prod:/tmp/
docker exec -it mr_game_ops_backend_prod python3 /tmp/create_admin.py
```

### 方法2：使用SQL直接插入

```bash
# 进入 postgres 容器
docker exec -it mr_game_ops_db_prod psql -U mr_admin -d mr_game_ops
```

```sql
-- 创建新管理员（需要先在后端容器生成密码哈希）
-- 1. 先在后端生成密码哈希
-- docker exec -it mr_game_ops_backend_prod python3 -c "from src.core.utils.password import hash_password; print(hash_password('你的密码'))"

-- 2. 插入管理员账户
INSERT INTO admin_accounts (
    id, username, password_hash, full_name, email, phone,
    role, permissions, is_active, created_at, updated_at
) VALUES (
    gen_random_uuid(),
    '新用户名',
    '上一步生成的密码哈希',
    '管理员姓名',
    'admin@example.com',
    '13800138000',
    'admin',
    '{}',
    true,
    NOW(),
    NOW()
);
```

---

## 修改管理员密码

### 方法1：通过前端页面修改

1. 使用管理员账户登录系统
2. 点击右上角用户头像
3. 选择"修改密码"
4. 输入旧密码和新密码
5. 点击"确认修改"

### 方法2：通过命令行重置密码

```bash
# 创建重置密码脚本
cat > /tmp/reset_password.py << 'EOF'
#!/usr/bin/env python3
"""重置管理员密码"""

import asyncio
import sys
sys.path.insert(0, '/app')

from sqlalchemy import select, update
from src.db.session import init_db, get_db_context
from src.models.admin import AdminAccount
from src.core.utils.password import hash_password

async def reset_password(username, new_password):
    init_db()
    async with get_db_context() as session:
        result = await session.execute(
            select(AdminAccount).where(AdminAccount.username == username)
        )
        admin = result.scalar_one_or_none()

        if not admin:
            print(f"❌ 用户 '{username}' 不存在！")
            return False

        # 更新密码
        admin.password_hash = hash_password(new_password)
        await session.commit()

        print(f"✅ 密码重置成功！")
        print(f"  用户名: {username}")
        print(f"  新密码: {new_password}")
        return True

if __name__ == "__main__":
    username = input("请输入用户名: ").strip()
    new_password = input("请输入新密码: ").strip()

    success = asyncio.run(reset_password(username, new_password))
    sys.exit(0 if success else 1)
EOF

# 执行脚本
docker cp /tmp/reset_password.py mr_game_ops_backend_prod:/tmp/
docker exec -it mr_game_ops_backend_prod python3 /tmp/reset_password.py
```

---

## 创建运营商账户

### 方法1：通过管理员后台创建（推荐）

1. 使用管理员账户登录系统
2. 进入"运营商管理"页面
3. 点击"创建运营商"按钮
4. 填写运营商信息：
   - 用户名（登录使用）
   - 密码
   - 运营商名称
   - 联系人
   - 邮箱
   - 电话
5. 点击"确认创建"
6. 系统会自动发送账户信息到运营商邮箱

### 方法2：使用 Python 脚本

```bash
cat > /tmp/create_operator.py << 'EOF'
#!/usr/bin/env python3
"""创建新的运营商账户"""

import asyncio
import sys
sys.path.insert(0, '/app')

from decimal import Decimal
from sqlalchemy import select
from src.db.session import init_db, get_db_context
from src.models.operator import OperatorAccount
from src.core.utils.password import hash_password

async def create_operator(username, password, full_name, email, phone, initial_balance=1000.0):
    init_db()
    async with get_db_context() as session:
        # 检查用户名是否存在
        result = await session.execute(
            select(OperatorAccount).where(OperatorAccount.username == username)
        )
        if result.scalar_one_or_none():
            print(f"❌ 用户名 '{username}' 已存在！")
            return False

        # 创建运营商账户
        operator = OperatorAccount(
            username=username,
            password_hash=hash_password(password),
            full_name=full_name,
            email=email,
            phone=phone,
            balance=Decimal(str(initial_balance)),
            is_active=True,
        )

        session.add(operator)
        await session.commit()

        print("✅ 运营商账户创建成功！")
        print(f"  用户名: {username}")
        print(f"  密码: {password}")
        print(f"  姓名: {full_name}")
        print(f"  初始余额: ¥{initial_balance}")
        return True

if __name__ == "__main__":
    print("=== 创建新运营商账户 ===\n")
    username = input("用户名: ").strip()
    password = input("密码: ").strip()
    full_name = input("运营商名称: ").strip()
    email = input("邮箱: ").strip()
    phone = input("电话: ").strip()
    initial_balance = input("初始余额 [默认1000]: ").strip() or "1000"

    success = asyncio.run(create_operator(username, password, full_name, email, phone, float(initial_balance)))
    sys.exit(0 if success else 1)
EOF

# 执行脚本
docker cp /tmp/create_operator.py mr_game_ops_backend_prod:/tmp/
docker exec -it mr_game_ops_backend_prod python3 /tmp/create_operator.py
```

---

## 账户权限管理

### 管理员角色说明

系统支持两种管理员角色：

| 角色 | 权限描述 |
|------|----------|
| `super_admin` | 超级管理员，拥有所有权限，包括创建其他管理员 |
| `admin` | 普通管理员，可以管理运营商和应用，但不能管理其他管理员 |

### 修改管理员角色

```bash
# 进入 postgres 容器
docker exec -it mr_game_ops_db_prod psql -U mr_admin -d mr_game_ops
```

```sql
-- 将普通管理员提升为超级管理员
UPDATE admin_accounts
SET role = 'super_admin', updated_at = NOW()
WHERE username = '用户名';

-- 将超级管理员降级为普通管理员
UPDATE admin_accounts
SET role = 'admin', updated_at = NOW()
WHERE username = '用户名';
```

### 禁用/启用账户

```sql
-- 禁用账户
UPDATE admin_accounts
SET is_active = false, updated_at = NOW()
WHERE username = '用户名';

-- 启用账户
UPDATE admin_accounts
SET is_active = true, updated_at = NOW()
WHERE username = '用户名';
```

---

## 常见问题

### Q1: 忘记了超级管理员密码怎么办？

使用密码重置脚本重置 `superadmin` 账户密码：

```bash
docker exec -it mr_game_ops_backend_prod python3 << 'EOF'
import asyncio
import sys
sys.path.insert(0, '/app')
from sqlalchemy import select
from src.db.session import init_db, get_db_context
from src.models.admin import AdminAccount
from src.core.utils.password import hash_password

async def reset_superadmin():
    init_db()
    async with get_db_context() as session:
        result = await session.execute(
            select(AdminAccount).where(AdminAccount.username == 'superadmin')
        )
        admin = result.scalar_one_or_none()
        if admin:
            admin.password_hash = hash_password('Admin123!@#')
            await session.commit()
            print("✅ superadmin 密码已重置为: Admin123!@#")
        else:
            print("❌ superadmin 账户不存在")

asyncio.run(reset_superadmin())
EOF
```

### Q2: 如何查看运营商的登录记录？

```sql
-- 进入数据库
docker exec -it mr_game_ops_db_prod psql -U mr_admin -d mr_game_ops

-- 查询运营商登录记录
SELECT operator_id, login_time, ip_address, user_agent
FROM operator_login_logs
ORDER BY login_time DESC
LIMIT 50;
```

### Q3: 如何批量创建运营商账户？

创建 CSV 文件（operators.csv）：

```csv
username,password,full_name,email,phone,initial_balance
operator1,Pass123!,运营商一,op1@example.com,13800000001,1000
operator2,Pass123!,运营商二,op2@example.com,13800000002,2000
operator3,Pass123!,运营商三,op3@example.com,13800000003,1500
```

然后使用脚本批量导入：

```bash
cat > /tmp/batch_create_operators.py << 'EOF'
#!/usr/bin/env python3
import asyncio
import sys
import csv
sys.path.insert(0, '/app')

from decimal import Decimal
from src.db.session import init_db, get_db_context
from src.models.operator import OperatorAccount
from src.core.utils.password import hash_password

async def batch_create(csv_file):
    init_db()
    async with get_db_context() as session:
        with open(csv_file, 'r', encoding='utf-8') as f:
            reader = csv.DictReader(f)
            for row in reader:
                operator = OperatorAccount(
                    username=row['username'],
                    password_hash=hash_password(row['password']),
                    full_name=row['full_name'],
                    email=row['email'],
                    phone=row['phone'],
                    balance=Decimal(row['initial_balance']),
                    is_active=True,
                )
                session.add(operator)
                print(f"✅ 创建: {row['username']}")

        await session.commit()
        print("\n所有账户创建完成！")

asyncio.run(batch_create('/tmp/operators.csv'))
EOF

# 上传 CSV 和脚本到容器
docker cp operators.csv mr_game_ops_backend_prod:/tmp/
docker cp /tmp/batch_create_operators.py mr_game_ops_backend_prod:/tmp/
docker exec -it mr_game_ops_backend_prod python3 /tmp/batch_create_operators.py
```

### Q4: 如何导出所有账户信息？

```bash
# 导出管理员账户
docker exec mr_game_ops_db_prod psql -U mr_admin -d mr_game_ops -c "\COPY (SELECT username, full_name, email, phone, role, is_active, created_at FROM admin_accounts ORDER BY created_at) TO '/tmp/admins.csv' WITH CSV HEADER"

# 导出运营商账户
docker exec mr_game_ops_db_prod psql -U mr_admin -d mr_game_ops -c "\COPY (SELECT username, full_name, email, phone, balance, is_active, created_at FROM operator_accounts ORDER BY created_at) TO '/tmp/operators.csv' WITH CSV HEADER"

# 从容器复制到主机
docker cp mr_game_ops_db_prod:/tmp/admins.csv ./admins.csv
docker cp mr_game_ops_db_prod:/tmp/operators.csv ./operators.csv
```

---

## 安全建议

1. ✅ **首次部署后立即修改所有默认密码**
2. ✅ **使用强密码**：至少12位，包含大小写字母、数字和特殊字符
3. ✅ **定期更换密码**：建议每3个月更换一次
4. ✅ **限制超级管理员数量**：建议不超过2个
5. ✅ **定期审计账户**：检查不活跃账户并禁用
6. ✅ **监控登录日志**：定期检查异常登录
7. ✅ **备份数据库**：定期备份账户数据

---

## 联系支持

如遇到账户管理相关问题，请联系技术支持团队。
