## ğŸ“Š ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“æ›´æ”¹æ–¹æ¡ˆ

### ğŸ¯ æ–¹æ¡ˆ1ï¼šå¢é‡è¿ç§»ï¼ˆæ¨èï¼‰

å¯¹äºå·²æœ‰æ•°æ®çš„ç”Ÿäº§ç¯å¢ƒï¼Œåº”è¯¥ä½¿ç”¨æ•°æ®åº“è¿ç§»ï¼š

1.  **æ£€æŸ¥å½“å‰è¿ç§»çŠ¶æ€**

    ```bash
    docker exec mr_game_ops_backend_prod python -m alembic current
    ```

2.  **åˆ›å»ºæ–°çš„è¿ç§»æ–‡ä»¶ï¼ˆåœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒï¼‰**

    ```bash
    cd /opt/mr_gunking_user_system_spec/backend
    python -m alembic revision -m "Add finance role constraint"
    ```

3.  **ç¼–è¾‘ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶ï¼Œæ·»åŠ çº¦æŸä¿®æ”¹**
    æ–‡ä»¶ä½ç½®ï¼š`alembic/versions/xxxxx_add_finance_role_constraint.py`

4.  **åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œè¿ç§»**

    ```bash
    docker exec mr_game_ops_backend_prod python -m alembic upgrade head
    ```

**è¿ç§»æ–‡ä»¶ç¤ºä¾‹å†…å®¹ï¼š**

```python
"""Add finance role constraint

Revision ID: abc123def456
Revises: 20251011_001_initial_schema
Create Date: 2025-10-27 01:45:00.000000

"""
from alembic import op
import sqlalchemy as sa

# revision identifiers
revision = 'abc123def456'
down_revision = '20251011_001_initial_schema'
branch_labels = None
depends_on = None

def upgrade():
    # åˆ é™¤æ—§çº¦æŸ
    op.drop_constraint('chk_admin_role', 'admin_accounts', type_='check')

    # æ·»åŠ æ–°çº¦æŸï¼ŒåŒ…å«financeè§’è‰²
    op.create_check_constraint(
        'chk_admin_role',
        'admin_accounts',
        sa.text("role IN ('super_admin', 'admin', 'operator', 'finance')")
    )

def downgrade():
    # æ¢å¤åŸå§‹çº¦æŸ
    op.drop_constraint('chk_admin_role', 'admin_accounts', type_='check')
    op.create_check_constraint(
        'chk_admin_role',
        'admin_accounts',
        sa.text("role IN ('super_admin', 'admin', 'operator')")
    )
```

-----

### ğŸ”„ æ–¹æ¡ˆ2ï¼šå¤‡ä»½æ•°æ®åé‡ç½®ï¼ˆå¦‚æœå¯ä»¥æ¥å—æ•°æ®ä¸¢å¤±ï¼‰

1.  **å¤‡ä»½å½“å‰æ•°æ®**

    ```bash
    docker exec mr_game_ops_db pg_dump -U mr_admin mr_game_ops > backup_$(date +%Y%m%d_%H%M%S).sql
    ```

2.  **åœæ­¢æ‰€æœ‰æœåŠ¡**

    ```bash
    docker-compose down
    ```

3.  **åˆ é™¤æ•°æ®åº“å·ï¼ˆæ³¨æ„ï¼šè¿™ä¼šåˆ é™¤æ‰€æœ‰æ•°æ®ï¼ï¼‰**

    ```bash
    docker volume rm mr_gunking_user_system_spec_postgres_data
    ```

4.  **é‡æ–°å¯åŠ¨æœåŠ¡ï¼ˆä¼šåˆ›å»ºæ–°çš„æ•°æ®åº“ï¼‰**

    ```bash
    docker-compose up -d
    ```

5.  **ç­‰å¾…æ•°æ®åº“åˆå§‹åŒ–å®Œæˆåè¿è¡Œè¿ç§»**

    ```bash
    docker exec mr_game_ops_backend_prod python -m alembic upgrade head
    ```

6.  **é‡æ–°åˆ›å»ºè´¢åŠ¡ç”¨æˆ·**

    ```bash
    docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance001 Pass@2024! å¼ å‘è´¢
    ```

-----

### ğŸ›¡ï¸ æ–¹æ¡ˆ3ï¼šå®‰å…¨çš„æ‰‹åŠ¨ä¿®æ”¹ï¼ˆæ¨èç”¨äºç´§æ€¥ä¿®å¤ï¼‰

1.  **è¿æ¥åˆ°æ•°æ®åº“**

    ```bash
    docker exec -it mr_game_ops_backend_prod psql -U mr_admin -d mr_game_ops
    ```

2.  **åœ¨psqlä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆäº¤äº’å¼ï¼‰**

    ```sql
    -- æŸ¥çœ‹å½“å‰çº¦æŸ
    SELECT conname, pg_get_constraintdef(oid)
    FROM pg_constraint
    WHERE conrelid = 'admin_accounts'::regclass AND contype = 'c';

    -- åˆ é™¤æ—§çº¦æŸ
    ALTER TABLE admin_accounts DROP CONSTRAINT IF EXISTS chk_admin_role;

    -- æ·»åŠ æ–°çº¦æŸ
    ALTER TABLE admin_accounts
    ADD CONSTRAINT chk_admin_role
    CHECK (role IN ('super_admin', 'admin', 'operator', 'finance'));

    -- éªŒè¯çº¦æŸ
    \d admin_accounts

    -- é€€å‡ºpsql
    \q
    ```

-----

### ğŸ“‹ é’ˆå¯¹å½“å‰æƒ…å†µçš„æ¨èæ­¥éª¤

**ç«‹å³æ‰§è¡Œçš„å¿«é€Ÿä¿®å¤ï¼š**

1.  **å®‰å…¨åœ°ä¿®æ”¹çº¦æŸï¼ˆæ¨èï¼‰**

    ```bash
    docker exec mr_game_ops_backend_prod psql -U mr_admin -d mr_game_ops -c "
    ALTER TABLE admin_accounts DROP CONSTRAINT IF EXISTS chk_admin_role;
    ALTER TABLE admin_accounts
    ADD CONSTRAINT chk_admin_role
    CHECK (role IN ('super_admin', 'admin', 'operator', 'finance'));
    "
    ```

2.  **éªŒè¯ä¿®æ”¹**

    ```bash
    docker exec mr_game_ops_backend_prod psql -U mr_admin -d mr_game_ops -c "
    SELECT conname, pg_get_constraintdef(oid)
    FROM pg_constraint
    WHERE conrelid = 'admin_accounts'::regclass AND contype = 'c';
    "
    ```

3.  **æ£€æŸ¥ç”¨æˆ·**

    ```bash
    docker exec mr_game_ops_backend_prod python -c "
    import asyncio, asyncpg
    async def check():
        conn = await asyncpg.connect('postgresql://mr_admin:CHANGE_THIS_PASSWORD@postgres:5432/mr_game_ops')
        user = await conn.fetchrow('SELECT username, role, is_active FROM admin_accounts WHERE username = \$1', 'finance001')
        if user:
            print(f'ç”¨æˆ·å­˜åœ¨: {user[\"username\"]}, è§’è‰²: {user[\"role\"]}, æ¿€æ´»: {user[\"is_active\"]}')
        else:
            print('ç”¨æˆ·ä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»º')
        await conn.close()
    asyncio.run(check())
    "
    ```

-----

### ğŸ”§ å®Œæ•´é‡ç½®æ•°æ®åº“çš„æ–¹æ³•

**æ–¹æ³•1ï¼šå®Œå…¨é‡ç½®ï¼ˆåˆ é™¤æ‰€æœ‰æ•°æ®ï¼‰**

```bash
# åœæ­¢æœåŠ¡
docker-compose down

# åˆ é™¤æ•°æ®åº“å·
docker volume ls | grep mr_gunking
docker volume rm mr_gunking_user_system_spec_postgres_data

# é‡æ–°å¯åŠ¨
docker-compose up -d

# ç­‰å¾…å¯åŠ¨å®Œæˆåè¿è¡Œè¿ç§»
sleep 30
docker exec mr_game_ops_backend_prod python -m alembic upgrade head

# åˆ›å»ºè´¢åŠ¡ç”¨æˆ·
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance001 Pass@2024! å¼ å‘è´¢
```

**æ–¹æ³•2ï¼šä¿ç•™æ•°æ®çš„é‡ç½®**

1.  **å¤‡ä»½**

    ```bash
    docker exec mr_game_ops_db pg_dump -U mr_admin mr_game_ops > full_backup.sql
    ```

2.  **æ¸…ç©ºæ•°æ®ä½†ä¿ç•™ç»“æ„**

    ```bash
    docker exec mr_game_ops_backend_prod psql -U mr_admin -d mr_game_ops -c "
    TRUNCATE TABLE transaction_records CASCADE;
    TRUNCATE TABLE usage_records CASCADE;
    TRUNCATE TABLE refund_records CASCADE;
    TRUNCATE TABLE invoice_records CASCADE;
    TRUNCATE TABLE operator_app_authorizations CASCADE;
    TRUNCATE TABLE operator_accounts CASCADE;
    TRUNCATE TABLE admin_accounts CASCADE;
    TRUNCATE TABLE applications CASCADE;
    TRUNCATE TABLE operation_sites CASCADE;
    "
    ```

3.  **é‡æ–°è¿è¡Œè¿ç§»ï¼ˆç¡®ä¿çº¦æŸæ­£ç¡®ï¼‰**

    ```bash
    docker exec mr_game_ops_backend_prod python -m alembic upgrade head
    ```

4.  **é‡æ–°åˆ›å»ºç”¨æˆ·**

    ```bash
    docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance001 Pass@2024! å¼ å‘è´¢
    ```

-----

### âš ï¸ é‡è¦æé†’

1.  ç”Ÿäº§ç¯å¢ƒä¼˜å…ˆä½¿ç”¨æ–¹æ¡ˆ1ï¼ˆå¢é‡è¿ç§»ï¼‰
2.  ä»»ä½•é‡ç½®æ“ä½œå‰å¿…é¡»å¤‡ä»½æ•°æ®
3.  æµ‹è¯•ç¯å¢ƒéªŒè¯åå†åœ¨ç”Ÿäº§æ‰§è¡Œ
4.  å»ºè®®åœ¨ä½å³°æœŸè¿›è¡Œæ•°æ®åº“æ“ä½œ

### ğŸ¯ æ¨èåšæ³•

å¯¹äºä½ å½“å‰çš„æƒ…å†µï¼Œæˆ‘å»ºè®®ï¼š

1.  \*\*ç«‹å³ä½¿ç”¨æ–¹æ¡ˆ3ï¼ˆå®‰å…¨æ‰‹åŠ¨ä¿®æ”¹ï¼‰\*\*ä¿®å¤çº¦æŸé—®é¢˜
2.  è®¾ç½®Alembicè¿ç§»ç”¨äºæœªæ¥çš„æ•°æ®åº“æ›´æ”¹
3.  å»ºç«‹å®šæœŸå¤‡ä»½ç­–ç•¥

è¿™æ ·æ—¢è§£å†³äº†å½“å‰é—®é¢˜ï¼Œåˆä¸ºæœªæ¥çš„æ•°æ®åº“ç®¡ç†å»ºç«‹äº†è§„èŒƒçš„æµç¨‹ã€‚

-----

> Background Bash 1eab46 (container mr\_gunking\_user\_system\_spec-backend) has exited with code 0, indicating successful completion.

å¥½çš„ï¼çœ‹èµ·æ¥æœ¬åœ°çš„Dockeråç«¯å®¹å™¨å·²ç»å®Œæˆäº†æ„å»ºå¹¶é€€å‡ºäº†ã€‚ç°åœ¨ä½ æœ‰å®Œæ•´çš„éƒ¨ç½²æ–¹æ¡ˆå¯ä»¥åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒäº†ã€‚

## ğŸ“‹ æ€»ç»“éƒ¨ç½²è¦ç‚¹

### æ ¸å¿ƒä¿®å¤å†…å®¹

1.  **ä»£ç ä¿®å¤ï¼š**
      * è´¢åŠ¡ç™»å½•APIä½¿ç”¨æ­£ç¡®çš„`AdminAuthService`æŸ¥æ‰¾`admin_accounts`è¡¨
      * JSONåºåˆ—åŒ–ä½¿ç”¨`json.dumps()`æ›¿ä»£`str()`
      * æ·»åŠ è§’è‰²éªŒè¯ç¡®ä¿åªæœ‰`finance`è§’è‰²èƒ½ç™»å½•
2.  **æ•°æ®åº“ä¿®å¤ï¼š**
      * ä¿®æ”¹`admin_accounts`è¡¨çš„è§’è‰²çº¦æŸï¼ŒåŒ…å«`finance`è§’è‰²

### ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œæ­¥éª¤

1.  **æ‹‰å–æœ€æ–°ä»£ç **

    ```bash
    git pull origin 001-mr
    ```

2.  **é‡æ–°æ„å»ºå¹¶å¯åŠ¨åç«¯**

    ```bash
    docker-compose up -d --build backend
    ```

3.  **ä¿®å¤æ•°æ®åº“çº¦æŸï¼ˆå…³é”®æ­¥éª¤ï¼‰**

    ```bash
    docker exec mr_game_ops_backend_prod psql -U mr_admin -d mr_game_ops -c "
    ALTER TABLE admin_accounts DROP CONSTRAINT IF EXISTS chk_admin_role;
    ALTER TABLE admin_accounts
    ADD CONSTRAINT chk_admin_role
    CHECK (role IN ('super_admin', 'admin', 'operator', 'finance'));
    "
    ```

4.  **éªŒè¯ç”¨æˆ·å­˜åœ¨æˆ–é‡æ–°åˆ›å»º**

    ```bash
    docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance001 Pass@2024! å¼ å‘è´¢
    ```

5.  **æµ‹è¯•ç™»å½•**

    ```bash
    curl -X POST "http://localhost:8000/api/v1/auth/finance/login" \
      -H "Content-Type: application/json" \
      -d '{"username": "finance001", "password": "Pass@2024!"}'
    ```

### æ•°æ®åº“ç®¡ç†å»ºè®®

  * **ç´§æ€¥æƒ…å†µï¼š** ä½¿ç”¨å®‰å…¨çš„æ‰‹åŠ¨ä¿®æ”¹ï¼ˆæ–¹æ¡ˆ3ï¼‰
  * **æœªæ¥æ›´æ”¹ï¼š** è®¾ç½®Alembicè¿ç§»ï¼ˆæ–¹æ¡ˆ1ï¼‰
  * **å®Œå…¨é‡ç½®ï¼š** å¤‡ä»½æ•°æ®åé‡ç½®ï¼ˆæ–¹æ¡ˆ2ï¼‰