## 📊 生产环境数据库更改方案

### 🎯 方案1：增量迁移（推荐）

对于已有数据的生产环境，应该使用数据库迁移：

1.  **检查当前迁移状态**

    ```bash
    docker exec mr_game_ops_backend_prod python -m alembic current
    ```

2.  **创建新的迁移文件（在本地开发环境）**

    ```bash
    cd /opt/mr_gunking_user_system_spec/backend
    python -m alembic revision -m "Add finance role constraint"
    ```

3.  **编辑生成的迁移文件，添加约束修改**
    文件位置：`alembic/versions/xxxxx_add_finance_role_constraint.py`

4.  **在生产环境执行迁移**

    ```bash
    docker exec mr_game_ops_backend_prod python -m alembic upgrade head
    ```

**迁移文件示例内容：**

```python
"""Add finance role constraint

Revision ID: abc123def456
Revises: 20251011_001_initial_schema
Create Date: 2025-10-27 01:45:00.000000

"""
from alembic import op
import sqlalchemy as sa

# revision identifiers
revision = 'abc123def456'
down_revision = '20251011_001_initial_schema'
branch_labels = None
depends_on = None

def upgrade():
    # 删除旧约束
    op.drop_constraint('chk_admin_role', 'admin_accounts', type_='check')

    # 添加新约束，包含finance角色
    op.create_check_constraint(
        'chk_admin_role',
        'admin_accounts',
        sa.text("role IN ('super_admin', 'admin', 'operator', 'finance')")
    )

def downgrade():
    # 恢复原始约束
    op.drop_constraint('chk_admin_role', 'admin_accounts', type_='check')
    op.create_check_constraint(
        'chk_admin_role',
        'admin_accounts',
        sa.text("role IN ('super_admin', 'admin', 'operator')")
    )
```

-----

### 🔄 方案2：备份数据后重置（如果可以接受数据丢失）

1.  **备份当前数据**

    ```bash
    docker exec mr_game_ops_db pg_dump -U mr_admin mr_game_ops > backup_$(date +%Y%m%d_%H%M%S).sql
    ```

2.  **停止所有服务**

    ```bash
    docker-compose down
    ```

3.  **删除数据库卷（注意：这会删除所有数据！）**

    ```bash
    docker volume rm mr_gunking_user_system_spec_postgres_data
    ```

4.  **重新启动服务（会创建新的数据库）**

    ```bash
    docker-compose up -d
    ```

5.  **等待数据库初始化完成后运行迁移**

    ```bash
    docker exec mr_game_ops_backend_prod python -m alembic upgrade head
    ```

6.  **重新创建财务用户**

    ```bash
    docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance001 Pass@2024! 张发财
    ```

-----

### 🛡️ 方案3：安全的手动修改（推荐用于紧急修复）

1.  **连接到数据库**

    ```bash
    docker exec -it mr_game_ops_backend_prod psql -U mr_admin -d mr_game_ops
    ```

2.  **在psql中执行以下命令（交互式）**

    ```sql
    -- 查看当前约束
    SELECT conname, pg_get_constraintdef(oid)
    FROM pg_constraint
    WHERE conrelid = 'admin_accounts'::regclass AND contype = 'c';

    -- 删除旧约束
    ALTER TABLE admin_accounts DROP CONSTRAINT IF EXISTS chk_admin_role;

    -- 添加新约束
    ALTER TABLE admin_accounts
    ADD CONSTRAINT chk_admin_role
    CHECK (role IN ('super_admin', 'admin', 'operator', 'finance'));

    -- 验证约束
    \d admin_accounts

    -- 退出psql
    \q
    ```

-----

### 📋 针对当前情况的推荐步骤

**立即执行的快速修复：**

1.  **安全地修改约束（推荐）**

    ```bash
    docker exec mr_game_ops_backend_prod psql -U mr_admin -d mr_game_ops -c "
    ALTER TABLE admin_accounts DROP CONSTRAINT IF EXISTS chk_admin_role;
    ALTER TABLE admin_accounts
    ADD CONSTRAINT chk_admin_role
    CHECK (role IN ('super_admin', 'admin', 'operator', 'finance'));
    "
    ```

2.  **验证修改**

    ```bash
    docker exec mr_game_ops_backend_prod psql -U mr_admin -d mr_game_ops -c "
    SELECT conname, pg_get_constraintdef(oid)
    FROM pg_constraint
    WHERE conrelid = 'admin_accounts'::regclass AND contype = 'c';
    "
    ```

3.  **检查用户**

    ```bash
    docker exec mr_game_ops_backend_prod python -c "
    import asyncio, asyncpg
    async def check():
        conn = await asyncpg.connect('postgresql://mr_admin:CHANGE_THIS_PASSWORD@postgres:5432/mr_game_ops')
        user = await conn.fetchrow('SELECT username, role, is_active FROM admin_accounts WHERE username = \$1', 'finance001')
        if user:
            print(f'用户存在: {user[\"username\"]}, 角色: {user[\"role\"]}, 激活: {user[\"is_active\"]}')
        else:
            print('用户不存在，需要创建')
        await conn.close()
    asyncio.run(check())
    "
    ```

-----

### 🔧 完整重置数据库的方法

**方法1：完全重置（删除所有数据）**

```bash
# 停止服务
docker-compose down

# 删除数据库卷
docker volume ls | grep mr_gunking
docker volume rm mr_gunking_user_system_spec_postgres_data

# 重新启动
docker-compose up -d

# 等待启动完成后运行迁移
sleep 30
docker exec mr_game_ops_backend_prod python -m alembic upgrade head

# 创建财务用户
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance001 Pass@2024! 张发财
```

**方法2：保留数据的重置**

1.  **备份**

    ```bash
    docker exec mr_game_ops_db pg_dump -U mr_admin mr_game_ops > full_backup.sql
    ```

2.  **清空数据但保留结构**

    ```bash
    docker exec mr_game_ops_backend_prod psql -U mr_admin -d mr_game_ops -c "
    TRUNCATE TABLE transaction_records CASCADE;
    TRUNCATE TABLE usage_records CASCADE;
    TRUNCATE TABLE refund_records CASCADE;
    TRUNCATE TABLE invoice_records CASCADE;
    TRUNCATE TABLE operator_app_authorizations CASCADE;
    TRUNCATE TABLE operator_accounts CASCADE;
    TRUNCATE TABLE admin_accounts CASCADE;
    TRUNCATE TABLE applications CASCADE;
    TRUNCATE TABLE operation_sites CASCADE;
    "
    ```

3.  **重新运行迁移（确保约束正确）**

    ```bash
    docker exec mr_game_ops_backend_prod python -m alembic upgrade head
    ```

4.  **重新创建用户**

    ```bash
    docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance001 Pass@2024! 张发财
    ```

-----

### ⚠️ 重要提醒

1.  生产环境优先使用方案1（增量迁移）
2.  任何重置操作前必须备份数据
3.  测试环境验证后再在生产执行
4.  建议在低峰期进行数据库操作

### 🎯 推荐做法

对于你当前的情况，我建议：

1.  \*\*立即使用方案3（安全手动修改）\*\*修复约束问题
2.  设置Alembic迁移用于未来的数据库更改
3.  建立定期备份策略

这样既解决了当前问题，又为未来的数据库管理建立了规范的流程。

-----

> Background Bash 1eab46 (container mr\_gunking\_user\_system\_spec-backend) has exited with code 0, indicating successful completion.

好的！看起来本地的Docker后端容器已经完成了构建并退出了。现在你有完整的部署方案可以应用到生产环境了。

## 📋 总结部署要点

### 核心修复内容

1.  **代码修复：**
      * 财务登录API使用正确的`AdminAuthService`查找`admin_accounts`表
      * JSON序列化使用`json.dumps()`替代`str()`
      * 添加角色验证确保只有`finance`角色能登录
2.  **数据库修复：**
      * 修改`admin_accounts`表的角色约束，包含`finance`角色

### 生产环境执行步骤

1.  **拉取最新代码**

    ```bash
    git pull origin 001-mr
    ```

2.  **重新构建并启动后端**

    ```bash
    docker-compose up -d --build backend
    ```

3.  **修复数据库约束（关键步骤）**

    ```bash
    docker exec mr_game_ops_backend_prod psql -U mr_admin -d mr_game_ops -c "
    ALTER TABLE admin_accounts DROP CONSTRAINT IF EXISTS chk_admin_role;
    ALTER TABLE admin_accounts
    ADD CONSTRAINT chk_admin_role
    CHECK (role IN ('super_admin', 'admin', 'operator', 'finance'));
    "
    ```

4.  **验证用户存在或重新创建**

    ```bash
    docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance001 Pass@2024! 张发财
    ```

5.  **测试登录**

    ```bash
    curl -X POST "http://localhost:8000/api/v1/auth/finance/login" \
      -H "Content-Type: application/json" \
      -d '{"username": "finance001", "password": "Pass@2024!"}'
    ```

### 数据库管理建议

  * **紧急情况：** 使用安全的手动修改（方案3）
  * **未来更改：** 设置Alembic迁移（方案1）
  * **完全重置：** 备份数据后重置（方案2）