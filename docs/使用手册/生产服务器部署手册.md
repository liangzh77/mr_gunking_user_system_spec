## 🚀 生产服务器部署步骤

### 1. 拉取最新代码

```shell
cd /opt/mr_gunking_user_system_spec
git pull origin 001-mr
````

### 2\. 重新构建并启动后端容器

```shell
# 停止当前后端容器
docker-compose stop backend

# 重新构建并启动（这会包含我们的修复）
docker-compose up -d --build backend

# 等待容器启动完成
docker-compose logs -f backend
```

### 3\. 修复数据库约束（关键步骤）

```shell
# 连接到PostgreSQL容器
docker exec -it mr_game_ops_backend_prod psql -U mr_admin -d mr_game_ops -c "
-- 修改admin_accounts表的角色约束，允许finance角色
ALTER TABLE admin_accounts DROP CONSTRAINT IF EXISTS chk_admin_role;

-- 添加新的检查约束，包含finance角色
ALTER TABLE admin_accounts
ADD CONSTRAINT chk_admin_role
CHECK (role IN ('super_admin', 'admin', 'operator', 'finance'));
"
```

### 4\. 验证用户是否存在

```shell
docker exec mr_game_ops_backend_prod python -c "
import asyncio, asyncpg
async def check():
    conn = await asyncpg.connect('postgresql://mr_admin:CHANGE_THIS_PASSWORD@postgres:5432/mr_game_ops')
    user = await conn.fetchrow('SELECT username, role, is_active FROM admin_accounts WHERE username = \$1', 'finance001')
    if user:
        print(f'用户存在: {user[\"username\"]}, 角色: {user[\"role\"]}, 激活: {user[\"is_active\"]}')
    else:
        print('用户不存在')
    await conn.close()
asyncio.run(check())
"
```

### 5\. 如果用户不存在，重新创建

```shell
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance001 Pass@2024! 张发财
```

### 6\. 测试财务登录API

```shell
# 测试登录
curl -X POST "http://localhost:8000/api/v1/auth/finance/login" \
  -H "Content-Type: application/json" \
  -d '{"username": "finance001", "password": "Pass@2024!"}'
```

### 7\. 如果需要，重启整个服务

```shell
# 重启所有服务
docker-compose down
docker-compose up -d

# 检查服务状态
docker-compose ps
docker-compose logs -f
```

-----

## 🔍 故障排查

如果遇到问题，按以下顺序检查：

### 检查容器状态

```shell
docker-compose ps
docker-compose logs backend
```

### 检查数据库连接

```shell
docker exec mr_game_ops_backend_prod python -c "
import asyncio, asyncpg
async def test():
    try:
        conn = await asyncpg.connect('postgresql://mr_admin:CHANGE_THIS_PASSWORD@postgres:5432/mr_game_ops')
        print('数据库连接成功')
        await conn.close()
    except Exception as e:
        print(f'数据库连接失败: {e}')
asyncio.run(test())
"
```

### 检查API服务

```shell
# 检查健康状态
curl http://localhost:8000/health

# 检查API文档
curl http://localhost:8000/docs
```

-----

## 🎯 预期结果

成功部署后，你应该能够：

1.  **成功登录**：使用 `finance001` / `Pass@2024!` 登录财务系统
2.  **获得Token**：收到包含JWT Token的响应
3.  **访问财务页面**：在前端页面正常登录

-----

## 💡 重要提示

1.  **确保数据库约束已修复**：这是最关键的一步
2.  **验证用户存在**：如果用户不存在，需要重新创建
3.  **检查容器重启**：确保新的代码已经生效
