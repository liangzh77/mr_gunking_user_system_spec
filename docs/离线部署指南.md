# 离线部署指南 (阿里云/网络受限环境)

**版本**: v1.0.0-mvp
**更新日期**: 2025-10-28
**适用场景**: 阿里云ECS、内网服务器等无法访问Docker Hub的环境

---

## 📋 目录

1. [场景说明](#场景说明)
2. [准备工作](#准备工作)
3. [镜像准备](#镜像准备)
4. [部署步骤](#部署步骤)
5. [验证部署](#验证部署)
6. [故障排查](#故障排查)

---

## 场景说明

### 适用场景

如果你的生产服务器遇到以下情况:

- ✅ 阿里云ECS无法访问Docker Hub
- ✅ 内网环境无法连接外网
- ✅ `docker pull` 命令失败或极慢
- ✅ `docker-compose build` 下载镜像超时

本指南提供**完全离线部署方案**。

### 部署流程概览

```
本地机器                   生产服务器
  |                            |
  | 1. 下载Docker镜像          |
  | 2. 导出为tar文件           |
  |                            |
  |----  上传tar文件  -------->|
                               |
                               | 3. 加载镜像
                               | 4. 克隆代码
                               | 5. 构建应用
                               | 6. 启动服务
                               |
```

---

## 准备工作

### 本地环境要求

- Docker已安装
- 能够访问Docker Hub
- 至少500MB磁盘空间

### 生产服务器要求

- Linux系统 (Ubuntu 20.04+, CentOS 7+)
- Docker已安装
- Docker Compose已安装
- 至少10GB磁盘空间

---

## 镜像准备

### 步骤1: 在本地下载镜像

在**本地机器**(能访问Docker Hub)上执行:

```bash
# 创建镜像目录
mkdir -p ~/docker-images
cd ~/docker-images

# 下载所有必需的基础镜像
echo "下载 PostgreSQL..."
docker pull postgres:14-alpine

echo "下载 Redis..."
docker pull redis:7-alpine

echo "下载 Python..."
docker pull python:3.12-slim

echo "下载 Node.js..."
docker pull node:18-alpine

echo "下载 Nginx..."
docker pull nginx:alpine

# 验证下载
docker images | grep -E "postgres|redis|python|node|nginx"
```

### 步骤2: 导出镜像为tar文件

```bash
cd ~/docker-images

echo "导出镜像..."

docker save postgres:14-alpine -o postgres-14-alpine.tar
docker save redis:7-alpine -o redis-7-alpine.tar
docker save python:3.12-slim -o python-3.12-slim.tar
docker save node:18-alpine -o node-18-alpine.tar
docker save nginx:alpine -o nginx-alpine.tar

# 查看导出的文件
ls -lh

# 预期输出:
# -rw-r--r-- 1 user user 104M Oct 28 15:10 postgres-14-alpine.tar
# -rw-r--r-- 1 user user  17M Oct 28 15:10 redis-7-alpine.tar
# -rw-r--r-- 1 user user  44M Oct 28 15:10 python-3.12-slim.tar
# -rw-r--r-- 1 user user  43M Oct 28 15:10 node-18-alpine.tar
# -rw-r--r-- 1 user user  22M Oct 28 15:10 nginx-alpine.tar
```

### 步骤3: 上传到生产服务器

选择一种方式上传:

**方式1: 使用scp (Linux/Mac)**

```bash
cd ~/docker-images

# 上传到生产服务器
scp *.tar root@your-server-ip:/root/docker-images/

# 或者打包后上传(减少传输次数)
tar czf docker-images.tar.gz *.tar
scp docker-images.tar.gz root@your-server-ip:/root/

# 在服务器上解压
# ssh root@your-server-ip
# mkdir -p /root/docker-images
# tar xzf docker-images.tar.gz -C /root/docker-images/
```

**方式2: 使用WinSCP/FileZilla (Windows)**

1. 打开WinSCP或FileZilla
2. 连接到生产服务器
3. 在服务器上创建目录: `/root/docker-images/`
4. 上传所有 `.tar` 文件到该目录

**方式3: 使用云服务商OSS**

```bash
# 上传到阿里云OSS
aliyun oss cp *.tar oss://your-bucket/docker-images/

# 在生产服务器下载
aliyun oss cp oss://your-bucket/docker-images/ /root/docker-images/ --recursive
```

---

## 部署步骤

### 步骤1: 验证镜像文件

在生产服务器上:

```bash
# 查看镜像文件
ls -lh /root/docker-images/

# 预期输出 (5个文件):
# -rw-r--r-- 1 root root 104M Oct 28 15:10 postgres-14-alpine.tar
# -rw-r--r-- 1 root root  17M Oct 28 15:10 redis-7-alpine.tar
# -rw-r--r-- 1 root root  44M Oct 28 15:10 python-3.12-slim.tar
# -rw-r--r-- 1 root root  43M Oct 28 15:10 node-18-alpine.tar
# -rw-r--r-- 1 root root  22M Oct 28 15:10 nginx-alpine.tar
```

### 步骤2: 克隆代码

```bash
cd /opt

# 克隆代码 (如果Git也无法访问,需要手动上传代码包)
git clone https://github.com/liangzh77/mr_gunking_user_system_spec.git

cd mr_gunking_user_system_spec

# 切换到MVP版本
git checkout v1.0.0-mvp
```

### 步骤3: 创建离线部署脚本

```bash
cd /opt/mr_gunking_user_system_spec

# 创建部署脚本
cat > deploy_offline.sh << 'DEPLOY_EOF'
#!/bin/bash
set -e

# 颜色定义
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}=========================================="
echo -e "  MR游戏运营管理系统 - 离线部署"
echo -e "==========================================${NC}"
echo ""

# ============================================================================
# 步骤1: 加载Docker镜像
# ============================================================================
echo -e "${YELLOW}[1/6] 加载Docker镜像...${NC}"
IMAGES_DIR="/root/docker-images"

if [ ! -d "$IMAGES_DIR" ]; then
    echo -e "${RED}错误: 镜像目录 $IMAGES_DIR 不存在${NC}"
    exit 1
fi

# 必需的镜像文件
REQUIRED_IMAGES=(
    "postgres-14-alpine.tar"
    "redis-7-alpine.tar"
    "python-3.12-slim.tar"
    "node-18-alpine.tar"
    "nginx-alpine.tar"
)

LOADED=0
FAILED=0

for img in "${REQUIRED_IMAGES[@]}"; do
    IMG_PATH="$IMAGES_DIR/$img"
    if [ -f "$IMG_PATH" ]; then
        echo -n "  加载: $img ... "
        if docker load -i "$IMG_PATH" > /dev/null 2>&1; then
            echo -e "${GREEN}✓${NC}"
            LOADED=$((LOADED + 1))
        else
            echo -e "${RED}✗${NC}"
            FAILED=$((FAILED + 1))
        fi
    else
        echo -e "  ${RED}✗ 文件不存在: $img${NC}"
        FAILED=$((FAILED + 1))
    fi
done

if [ $FAILED -gt 0 ]; then
    echo -e "${RED}错误: 有 $FAILED 个镜像加载失败${NC}"
    exit 1
fi

echo -e "${GREEN}✓ 成功加载 $LOADED/${#REQUIRED_IMAGES[@]} 个镜像${NC}"
echo ""

# 显示已加载的镜像
echo "已加载的镜像:"
docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | grep -E "postgres|redis|python|node|nginx|REPOSITORY"
echo ""

# ============================================================================
# 步骤2: 检查项目目录
# ============================================================================
echo -e "${YELLOW}[2/6] 检查项目环境...${NC}"

if [ ! -f "docker-compose.prod.yml" ]; then
    echo -e "${RED}错误: 未找到 docker-compose.prod.yml${NC}"
    echo "请确保在项目根目录 /opt/mr_gunking_user_system_spec 执行此脚本"
    exit 1
fi

echo -e "${GREEN}✓ 项目目录正确${NC}"
echo ""

# ============================================================================
# 步骤3: 配置环境变量
# ============================================================================
echo -e "${YELLOW}[3/6] 配置环境变量...${NC}"

if [ ! -f ".env.production" ]; then
    echo -e "${YELLOW}未找到 .env.production 配置文件${NC}"

    if [ -f "configure_env.sh" ]; then
        echo "发现自动配置脚本"
        read -p "是否运行自动配置? (y/n): " run_config
        if [ "$run_config" = "y" ]; then
            ./configure_env.sh
        else
            echo ""
            echo "请手动配置:"
            echo "  1. cp .env.production.template .env.production"
            echo "  2. nano .env.production"
            echo "  3. 修改必要的配置项"
            exit 1
        fi
    else
        echo -e "${RED}请先创建配置文件${NC}"
        echo "  1. cp .env.production.template .env.production"
        echo "  2. nano .env.production"
        exit 1
    fi
fi

echo -e "${GREEN}✓ 配置文件已就绪${NC}"
echo ""

# ============================================================================
# 步骤4: 停止旧服务
# ============================================================================
echo -e "${YELLOW}[4/6] 检查并停止旧服务...${NC}"

if docker-compose -f docker-compose.prod.yml ps -q 2>/dev/null | grep -q .; then
    echo "发现运行中的服务,正在停止..."
    docker-compose -f docker-compose.prod.yml down
    echo -e "${GREEN}✓ 旧服务已停止${NC}"
else
    echo "没有运行中的服务"
fi
echo ""

# ============================================================================
# 步骤5: 构建应用镜像
# ============================================================================
echo -e "${YELLOW}[5/6] 构建应用镜像...${NC}"
echo "这可能需要5-10分钟,请耐心等待..."
echo ""

# 设置构建参数
export BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
export VERSION="1.0.0"

# 构建后端
echo -e "${BLUE}构建后端服务...${NC}"
if docker-compose -f docker-compose.prod.yml build backend; then
    echo -e "${GREEN}✓ 后端构建成功${NC}"
else
    echo -e "${RED}✗ 后端构建失败${NC}"
    echo "请查看错误信息并修复"
    exit 1
fi
echo ""

# 构建前端
echo -e "${BLUE}构建前端服务...${NC}"
if docker-compose -f docker-compose.prod.yml build frontend; then
    echo -e "${GREEN}✓ 前端构建成功${NC}"
else
    echo -e "${RED}✗ 前端构建失败${NC}"
    echo "请查看错误信息并修复"
    exit 1
fi
echo ""

# ============================================================================
# 步骤6: 启动所有服务
# ============================================================================
echo -e "${YELLOW}[6/6] 启动服务...${NC}"

if docker-compose -f docker-compose.prod.yml up -d; then
    echo -e "${GREEN}✓ 服务启动成功${NC}"
else
    echo -e "${RED}✗ 服务启动失败${NC}"
    echo "查看日志: docker-compose -f docker-compose.prod.yml logs"
    exit 1
fi
echo ""

# 等待服务就绪
echo -e "${YELLOW}等待服务启动(30秒)...${NC}"
for i in {30..1}; do
    echo -ne "\r剩余: $i 秒  "
    sleep 1
done
echo ""
echo ""

# ============================================================================
# 显示部署结果
# ============================================================================
echo -e "${BLUE}=========================================="
echo -e "  部署完成!"
echo -e "==========================================${NC}"
echo ""

# 获取服务器IP
SERVER_IP=$(hostname -I | awk '{print $1}')

# 显示服务状态
echo -e "${YELLOW}服务状态:${NC}"
docker-compose -f docker-compose.prod.yml ps
echo ""

# 显示访问信息
echo -e "${GREEN}=========================================="
echo -e "  访问信息"
echo -e "==========================================${NC}"
echo ""
echo "前端地址:   http://$SERVER_IP"
echo "后端API:    http://$SERVER_IP:8000"
echo "健康检查:   http://$SERVER_IP:8000/health"
echo "API文档:    http://$SERVER_IP:8000/docs"
echo ""

# 测试健康检查
echo -e "${YELLOW}测试服务健康状态...${NC}"
sleep 5

if curl -s -f http://localhost:8000/health > /dev/null 2>&1; then
    HEALTH_STATUS=$(curl -s http://localhost:8000/health)
    echo -e "${GREEN}✓ 后端服务运行正常${NC}"
    echo "  $HEALTH_STATUS"
else
    echo -e "${RED}✗ 后端服务可能未就绪${NC}"
    echo "  请稍后访问或查看日志"
fi
echo ""

# 显示管理命令
echo -e "${GREEN}=========================================="
echo -e "  常用管理命令"
echo -e "==========================================${NC}"
echo ""
echo "查看所有日志:"
echo "  docker-compose -f docker-compose.prod.yml logs -f"
echo ""
echo "查看后端日志:"
echo "  docker-compose -f docker-compose.prod.yml logs -f backend"
echo ""
echo "查看前端日志:"
echo "  docker-compose -f docker-compose.prod.yml logs -f frontend"
echo ""
echo "重启服务:"
echo "  docker-compose -f docker-compose.prod.yml restart"
echo ""
echo "停止服务:"
echo "  docker-compose -f docker-compose.prod.yml down"
echo ""
echo "查看容器状态:"
echo "  docker-compose -f docker-compose.prod.yml ps"
echo ""

# 保存部署信息
DEPLOY_INFO="DEPLOY_INFO.txt"
cat > "$DEPLOY_INFO" << INFO_EOF
========================================
  MR游戏运营管理系统 - 部署信息
========================================
部署时间: $(date)
部署方式: 离线部署
服务器IP: $SERVER_IP
版本: $VERSION

访问地址:
  前端:     http://$SERVER_IP
  后端API:  http://$SERVER_IP:8000
  健康检查: http://$SERVER_IP:8000/health
  API文档:  http://$SERVER_IP:8000/docs

服务列表:
$(docker-compose -f docker-compose.prod.yml ps)

管理命令:
  查看日志: docker-compose -f docker-compose.prod.yml logs -f
  重启服务: docker-compose -f docker-compose.prod.yml restart
  停止服务: docker-compose -f docker-compose.prod.yml down
  服务状态: docker-compose -f docker-compose.prod.yml ps

配置文件:
  环境配置: .env.production
  Docker配置: docker-compose.prod.yml

数据备份:
  数据库备份: docker exec mr_game_ops_db_prod pg_dump -U mr_admin mr_game_ops > backup.sql

========================================
INFO_EOF

echo -e "${GREEN}部署信息已保存到: $DEPLOY_INFO${NC}"
echo ""

DEPLOY_EOF

# 赋予执行权限
chmod +x deploy_offline.sh

echo "离线部署脚本已创建: deploy_offline.sh"
```

### 步骤4: 运行部署脚本

```bash
cd /opt/mr_gunking_user_system_spec

# 执行部署
./deploy_offline.sh
```

部署脚本会自动完成:
1. 加载Docker镜像
2. 检查项目环境
3. 配置环境变量
4. 停止旧服务
5. 构建应用镜像
6. 启动所有服务

---

## 验证部署

### 1. 检查容器状态

```bash
cd /opt/mr_gunking_user_system_spec
docker-compose -f docker-compose.prod.yml ps
```

预期输出 (所有服务应为 "Up" 状态):
```
NAME                            STATUS         PORTS
mr_game_ops_backend_prod       Up (healthy)   0.0.0.0:8000->8000/tcp
mr_game_ops_db_prod            Up (healthy)   5432/tcp
mr_game_ops_frontend_prod      Up             0.0.0.0:80->80/tcp
mr_game_ops_redis_prod         Up (healthy)   6379/tcp
```

### 2. 测试后端健康检查

```bash
curl http://localhost:8000/health
```

预期输出:
```json
{"status":"healthy","version":"1.0.0","environment":"production"}
```

### 3. 访问前端

在浏览器中访问: `http://你的服务器IP`

### 4. 查看日志

```bash
# 查看所有服务日志
docker-compose -f docker-compose.prod.yml logs -f

# 只看后端日志
docker-compose -f docker-compose.prod.yml logs -f backend

# 只看前端日志
docker-compose -f docker-compose.prod.yml logs -f frontend

# 查看最近100行
docker-compose -f docker-compose.prod.yml logs --tail=100
```

---

## 故障排查

### 问题1: 镜像加载失败

**症状**: `docker load -i xxx.tar` 报错

**解决**:
```bash
# 检查文件完整性
md5sum /root/docker-images/*.tar

# 重新下载并上传该镜像
# 或使用 docker pull 直接在服务器上拉取
```

### 问题2: 构建失败 - 无法下载依赖

**症状**: 构建时提示 `pip install` 或 `npm install` 失败

**解决**:

后端Python依赖:
```bash
# 方案1: 配置国内镜像源
export PIP_INDEX_URL=https://pypi.tuna.tsinghua.edu.cn/simple
docker-compose -f docker-compose.prod.yml build backend

# 方案2: 准备离线依赖包
# 在本地下载依赖:
pip download -r backend/requirements.txt -d /tmp/pip-deps
# 上传到服务器并在Dockerfile中使用
```

前端npm依赖:
```bash
# 配置国内镜像源
export NPM_CONFIG_REGISTRY=https://registry.npmmirror.com
docker-compose -f docker-compose.prod.yml build frontend
```

### 问题3: 容器启动后立即退出

**检查日志**:
```bash
docker-compose -f docker-compose.prod.yml logs backend
docker-compose -f docker-compose.prod.yml logs postgres
```

**常见原因**:
1. 数据库密码配置不一致
2. 环境变量配置错误
3. 端口被占用

### 问题4: 前端无法连接后端

**检查配置**:
```bash
# 查看前端配置
grep VITE_API_BASE_URL .env.production

# 应该类似: VITE_API_BASE_URL=http://你的服务器IP/api/v1
```

**重新构建前端**:
```bash
docker-compose -f docker-compose.prod.yml build frontend
docker-compose -f docker-compose.prod.yml up -d frontend
```

### 问题5: 数据库连接失败

**检查数据库状态**:
```bash
docker exec -it mr_game_ops_db_prod psql -U mr_admin -d mr_game_ops

# 如果能进入,说明数据库正常
# 然后检查后端配置中的DATABASE_URL是否正确
```

---

## 镜像清单

### 必需镜像 (5个, ~230MB)

| 镜像 | 大小 | 用途 | Docker Tag |
|------|------|------|------------|
| postgres-14-alpine.tar | ~104MB | PostgreSQL数据库 | postgres:14-alpine |
| redis-7-alpine.tar | ~17MB | Redis缓存 | redis:7-alpine |
| python-3.12-slim.tar | ~44MB | Python运行环境(后端) | python:3.12-slim |
| node-18-alpine.tar | ~43MB | Node.js环境(前端构建) | node:18-alpine |
| nginx-alpine.tar | ~22MB | Nginx服务器(前端) | nginx:alpine |

### 可选镜像 (监控相关,可暂时不用)

| 镜像 | 大小 | 用途 |
|------|------|------|
| grafana-latest.tar | ~195MB | 监控面板 |
| prometheus-latest.tar | ~129MB | 监控系统 |

---

## 附录

### A. 完整部署时间线

| 步骤 | 预计耗时 | 说明 |
|------|---------|------|
| 下载镜像(本地) | 5-10分钟 | 取决于网络速度 |
| 导出镜像 | 2-3分钟 | |
| 上传到服务器 | 5-15分钟 | 取决于带宽 |
| 加载镜像 | 1-2分钟 | |
| 构建应用 | 5-10分钟 | |
| 启动服务 | 1-2分钟 | |
| **总计** | **20-40分钟** | |

### B. 磁盘空间需求

- 镜像tar文件: ~230MB
- 加载后镜像: ~230MB
- 构建缓存: ~500MB
- 应用镜像: ~1.5GB
- 数据库数据: ~100MB (初始)
- **建议预留**: 10GB

### C. 网络端口

| 端口 | 服务 | 访问 |
|------|------|------|
| 80 | 前端 | 对外开放 |
| 8000 | 后端API | 可选开放 |
| 5432 | PostgreSQL | 仅内部 |
| 6379 | Redis | 仅内部 |

---

**文档版本**: 1.0.0
**最后更新**: 2025-10-28
**维护者**: liangzh77
