# MR游戏运营管理系统 - 账户管理手册

## 📋 目录

- [快速开始](#快速开始)
- [管理员账户管理](#管理员账户管理)
- [财务账户管理](#财务账户管理)
- [查看所有用户](#查看所有用户)
- [安全最佳实践](#安全最佳实践)
- [常见问题](#常见问题)
- [故障排查](#故障排查)

---

## 🚀 快速开始

### 前置条件

- 服务器已部署并运行
- 能够通过 SSH 访问服务器
- Docker 容器正在运行

### 基本命令格式

所有账户管理脚本都在 backend 容器中执行：

```bash
docker exec mr_game_ops_backend_prod python /app/scripts/<脚本名>.py [参数]
```

---

## 👨‍💼 管理员账户管理

### 1. 首次创建管理员账户（仅首次部署）

**脚本**: `create_admin_simple.py`

```bash
docker exec mr_game_ops_backend_prod python /app/scripts/create_admin_simple.py
```

**默认凭据**：
- 用户名: `admin`
- 密码: `admin123`
- 角色: `super_admin`
- 权限: 所有权限

**输出示例**：
```
管理员账号创建成功！
用户名: admin
密码: admin123
角色: super_admin
```

**⚠️ 重要**: 首次部署后必须立即修改默认密码！

---

### 2. 修改管理员密码

**脚本**: `change_password.py`

#### 基本用法

```bash
docker exec mr_game_ops_backend_prod python /app/scripts/change_password.py <用户名> <新密码>
```

#### 实际示例

```bash
# 修改 admin 的密码为 MySecurePass2024!
docker exec mr_game_ops_backend_prod python /app/scripts/change_password.py admin MySecurePass2024!
```

**输出示例**：
```
密码修改成功！
用户名: admin
新密码: MySecurePass2024!
```

#### 密码要求建议

- ✅ 至少 12 个字符
- ✅ 包含大写字母 (A-Z)
- ✅ 包含小写字母 (a-z)
- ✅ 包含数字 (0-9)
- ✅ 包含特殊字符 (!@#$%^&*)
- ❌ 不要使用常见单词、生日、公司名称

**强密码示例**：
- `Admin@2024!Secure`
- `MyP@ssw0rd2024#`
- `Secure!Game2024$`

---

## 💰 财务账户管理

### 1. 创建财务用户

**脚本**: `manage_finance_user.py`

#### 基本用法

```bash
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create <用户名> <密码> <姓名> [邮箱] [手机]
```

#### 实际示例

**示例 1：完整参数**
```bash
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance001 Finance@2024! 张财务 zhang@company.com 13800138001
```

**示例 2：最少参数（邮箱和手机使用默认值）**
```bash
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance001 Finance@2024! 张财务
```

**示例 3：创建多个财务用户**
```bash
# 财务主管
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance_manager FinMgr@2024! 李主管 li@company.com 13800138002

# 财务专员
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance_staff1 FinStaff@2024! 王专员 wang@company.com 13800138003

# 财务审计
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance_audit Audit@2024! 赵审计 zhao@company.com 13800138004
```

**输出示例**：
```
财务用户创建成功！
用户名: finance001
密码: Finance@2024!
姓名: 张财务
角色: finance（财务）
权限: finance:read, finance:recharge, finance:refund, invoice:read, invoice:create, statistics:read
```

#### 财务角色权限说明

| 权限 | 说明 |
|------|------|
| `finance:read` | 查看财务信息、账户余额 |
| `finance:recharge` | 为用户充值 |
| `finance:refund` | 处理退款申请 |
| `invoice:read` | 查看发票记录 |
| `invoice:create` | 创建和开具发票 |
| `statistics:read` | 查看财务统计报表 |

**财务用户不能**：
- ❌ 创建/删除其他管理员
- ❌ 修改系统配置
- ❌ 访问技术日志
- ❌ 管理操作员账号（非财务范围）

---

### 2. 修改财务用户密码

#### 基本用法

```bash
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py password <用户名> <新密码>
```

#### 实际示例

```bash
# 修改 finance001 的密码
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py password finance001 NewFinPass2024!

# 修改财务主管的密码
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py password finance_manager NewMgrPass2024!
```

**输出示例**：
```
密码修改成功！
用户名: finance001
新密码: NewFinPass2024!
```

---

## 👥 查看所有用户

### 列出所有账户

**脚本**: `manage_finance_user.py`

```bash
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py list
```

**输出示例**：
```
当前用户列表：
----------------------------------------------------------------------------------------------------
用户名           姓名            角色            邮箱                      状态     创建时间
----------------------------------------------------------------------------------------------------
admin           系统管理员       super_admin     admin@mrgameops.com       激活     2025-10-24 07:55:34
finance_manager 李主管          finance         li@company.com            激活     2025-10-24 12:15:20
finance001      张财务          finance         zhang@company.com         激活     2025-10-24 12:30:45
finance_staff1  王专员          finance         wang@company.com          激活     2025-10-24 12:45:10
----------------------------------------------------------------------------------------------------
总计: 4 个用户
```

---

## 🔒 安全最佳实践

### 1. 密码管理

#### ✅ 推荐做法

- 首次部署后**立即**修改默认管理员密码
- 使用强密码（12+ 字符，大小写+数字+符号）
- 定期更换密码（建议每 3-6 个月）
- 不同账户使用不同密码
- 使用密码管理器保存密码

#### ❌ 避免做法

- 不要使用 `admin123`、`password`、`123456` 等弱密码
- 不要使用生日、姓名拼音等可预测密码
- 不要在多个系统使用相同密码
- 不要将密码写在记事本或邮件中
- 不要与他人共享账号

### 2. 账户管理

#### ✅ 推荐做法

```bash
# 1. 首次部署后立即修改管理员密码
docker exec mr_game_ops_backend_prod python /app/scripts/change_password.py admin YourStrongPassword2024!

# 2. 为每个财务人员创建独立账号
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance_zhang FinZhang@2024! 张三
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance_li FinLi@2024! 李四

# 3. 定期检查用户列表
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py list

# 4. 员工离职后立即修改或禁用其账号
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py password finance_zhang DisabledAccount@999!
```

#### ❌ 避免做法

- 不要多人共用一个账号
- 不要长期使用默认密码
- 不要忘记清理离职员工账号
- 不要在公共场所登录

### 3. 登录安全

- 仅在安全网络环境下登录
- 使用完毕后及时退出登录
- 不要在公共电脑上保存密码
- 定期检查登录日志

### 4. 服务器访问安全

```bash
# 1. 仅允许特定IP访问服务器（在服务器防火墙配置）
# 例如：只允许公司办公网络访问

# 2. 使用SSH密钥而不是密码登录服务器

# 3. 定期更新系统和Docker镜像
docker compose -f docker-compose.prod.yml pull
docker compose -f docker-compose.prod.yml up -d
```

---

## 📝 完整操作流程示例

### 场景 1：新系统部署后的初始化

```bash
# 步骤 1：系统已部署，创建管理员
docker exec mr_game_ops_backend_prod python /app/scripts/create_admin_simple.py

# 步骤 2：立即修改管理员密码
docker exec mr_game_ops_backend_prod python /app/scripts/change_password.py admin Admin@Secure2024!

# 步骤 3：创建财务主管账号
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance_manager FinMgr@2024! 财务主管 manager@company.com 13800138000

# 步骤 4：创建财务专员账号
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance_staff FinStaff@2024! 财务专员 staff@company.com 13800138001

# 步骤 5：验证所有账号已创建
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py list
```

### 场景 2：新员工入职

```bash
# 创建新财务员工账号
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance_newuser FinNew@2024! 新员工姓名 new@company.com 13800138888

# 验证账号创建成功
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py list

# 将用户名和初始密码告知新员工，要求首次登录后修改密码
```

### 场景 3：员工离职

```bash
# 方法 1：修改密码以禁用账号（推荐）
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py password finance_olduser DisabledAccount@999!

# 方法 2：在数据库中标记为禁用（需要连接数据库操作，暂不推荐）

# 验证用户列表
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py list
```

### 场景 4：定期密码更换

```bash
# 每季度更换一次管理员密码
docker exec mr_game_ops_backend_prod python /app/scripts/change_password.py admin NewAdminPass_Q1_2024!

# 要求所有财务人员更换密码
# 方法 1：由管理员统一更换后通知员工
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py password finance001 NewPass_Q1_2024!

# 方法 2：员工自行在系统中修改（登录后从个人中心修改）
```

### 场景 5：忘记密码

```bash
# 管理员重置用户密码
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py password <忘记密码的用户名> TemporaryPass@2024!

# 告知用户临时密码，要求立即登录并修改
```

---

## ❓ 常见问题

### Q1: 如何确认脚本文件已经在容器中？

```bash
# 查看容器中的 scripts 目录
docker exec mr_game_ops_backend_prod ls -la /app/scripts/

# 应该看到以下文件：
# create_admin_simple.py
# create_admin.py
# change_password.py
# manage_finance_user.py
# README.md
```

### Q2: 如果脚本不在容器中怎么办？

```bash
# 方法 1：从服务器拷贝到容器（快速）
cd /opt/mr_gunking_user_system_spec
docker cp backend/scripts mr_game_ops_backend_prod:/app/

# 方法 2：重新构建镜像（彻底）
docker compose -f docker-compose.prod.yml build backend
docker compose -f docker-compose.prod.yml up -d backend
```

### Q3: 创建用户时提示"用户已存在"怎么办？

```bash
# 方法 1：换一个用户名
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance002 Pass@2024! 张财务

# 方法 2：如果确实要使用该用户名，先修改现有用户密码
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py password finance001 NewPass@2024!
```

### Q4: 如何批量创建多个账号？

```bash
# 创建一个 shell 脚本
cat > create_finance_users.sh << 'EOF'
#!/bin/bash
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance001 Fin001@2024! 张三
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance002 Fin002@2024! 李四
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create finance003 Fin003@2024! 王五
EOF

# 执行脚本
chmod +x create_finance_users.sh
./create_finance_users.sh
```

### Q5: 如何验证密码修改成功？

```bash
# 方法 1：尝试在浏览器登录
# 访问 http://your-server-ip/
# 使用新密码登录

# 方法 2：查看用户列表（确认用户存在）
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py list
```

### Q6: 如何查看某个用户的详细信息？

```bash
# 目前只能查看所有用户列表
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py list

# 或者使用 grep 过滤
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py list | grep finance001
```

### Q7: 密码可以包含中文吗？

**不推荐**使用中文密码，因为：
- 可能导致编码问题
- 在某些终端环境下输入困难
- 建议使用英文、数字和符号组合

### Q8: 可以创建其他角色的账号吗（如运营、客服）？

目前脚本只支持：
- `super_admin` - 超级管理员（通过 create_admin_simple.py）
- `finance` - 财务角色（通过 manage_finance_user.py）

如需创建其他角色，需要：
1. 修改脚本添加新角色
2. 或直接在系统后台界面中创建（如果系统提供该功能）

---

## 🔧 故障排查

### 错误 1: `ModuleNotFoundError: No module named 'src'`

**原因**: 脚本路径配置问题

**解决方案**:
```bash
# 1. 确保使用最新版本的脚本
cd /opt/mr_gunking_user_system_spec
git pull origin 001-mr

# 2. 重新拷贝脚本到容器
docker cp backend/scripts mr_game_ops_backend_prod:/app/

# 3. 重试
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py list
```

### 错误 2: `can't open file '/app/scripts/xxx.py': No such file or directory`

**原因**: 脚本文件不在容器中

**解决方案**:
```bash
# 拷贝脚本到容器
docker cp backend/scripts mr_game_ops_backend_prod:/app/

# 验证文件存在
docker exec mr_game_ops_backend_prod ls -la /app/scripts/
```

### 错误 3: 数据库连接失败

**原因**: 数据库未启动或密码不正确

**解决方案**:
```bash
# 1. 检查数据库容器状态
docker compose -f docker-compose.prod.yml ps

# 2. 确认 postgres 容器状态为 healthy

# 3. 如果数据库密码已修改，需要更新脚本中的连接字符串
# 编辑脚本文件，修改 db_url
```

### 错误 4: 密码验证失败（登录时）

**可能原因**:
1. 密码输入错误（检查大小写、空格）
2. 使用了旧密码
3. 账号被禁用

**解决方案**:
```bash
# 重置密码
docker exec mr_game_ops_backend_prod python /app/scripts/change_password.py <用户名> NewPassword@2024!
```

### 错误 5: 容器未运行

**解决方案**:
```bash
# 启动所有服务
cd /opt/mr_gunking_user_system_spec
docker compose -f docker-compose.prod.yml up -d

# 等待服务启动
sleep 30

# 检查状态
docker compose -f docker-compose.prod.yml ps
```

---

## 📞 技术支持

如遇到本文档未涵盖的问题，请：

1. 检查系统日志：
   ```bash
   docker logs mr_game_ops_backend_prod --tail 100
   ```

2. 检查服务状态：
   ```bash
   docker compose -f docker-compose.prod.yml ps
   ```

3. 查看详细文档：
   ```bash
   cat /opt/mr_gunking_user_system_spec/backend/scripts/README.md
   ```

---

## 📚 附录

### 快速命令参考

```bash
# === 查看帮助 ===
cat /opt/mr_gunking_user_system_spec/backend/scripts/README.md

# === 管理员操作 ===
# 创建管理员
docker exec mr_game_ops_backend_prod python /app/scripts/create_admin_simple.py

# 修改密码
docker exec mr_game_ops_backend_prod python /app/scripts/change_password.py <用户名> <新密码>

# === 财务用户操作 ===
# 创建财务用户
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py create <用户名> <密码> <姓名>

# 修改财务用户密码
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py password <用户名> <新密码>

# 查看所有用户
docker exec mr_game_ops_backend_prod python /app/scripts/manage_finance_user.py list

# === 系统维护 ===
# 查看容器状态
docker compose -f docker-compose.prod.yml ps

# 查看日志
docker logs mr_game_ops_backend_prod

# 重启服务
docker compose -f docker-compose.prod.yml restart backend
```

---

**文档版本**: v1.0
**最后更新**: 2025-10-24
**适用系统版本**: MR游戏运营管理系统 v1.0
