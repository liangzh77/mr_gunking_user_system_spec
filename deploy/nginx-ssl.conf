# ============================================================================
# Nginx SSL 配置文件 - MR游戏运营管理系统
# 域名: mrgun.chu-jiao.com
# ============================================================================

# HTTP 服务器 - 自动重定向到 HTTPS
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name mrgun.chu-jiao.com www.mrgun.chu-jiao.com;

    # 所有 HTTP 请求重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

# HTTPS 主服务器
server {
    listen 443 ssl http2 default_server;
    listen [::]:443 ssl http2 default_server;

    server_name mrgun.chu-jiao.com www.mrgun.chu-jiao.com;

    # ==================== SSL 证书配置 ====================
    ssl_certificate /etc/ssl/certs/mrgun.chu-jiao.com.pem;
    ssl_certificate_key /etc/ssl/private/mrgun.chu-jiao.com.key;

    # SSL 安全协议配置 - 仅支持 TLS 1.3（T276）
    ssl_protocols TLSv1.3;
    # TLS 1.3 密码套件（TLS 1.3 不需要配置 ciphers，由协议自动选择）
    ssl_prefer_server_ciphers off;

    # SSL 会话缓存优化
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;

    # ==================== 安全头配置 ====================
    # HSTS - 强制 HTTPS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # 防止点击劫持
    add_header X-Frame-Options "SAMEORIGIN" always;

    # 防止 MIME 类型嗅探
    add_header X-Content-Type-Options "nosniff" always;

    # XSS 保护
    add_header X-XSS-Protection "1; mode=block" always;

    # Referrer 策略
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # CSP 策略（可根据需要调整）
    add_header Content-Security-Policy "default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';" always;

    # ==================== 日志配置 ====================
    access_log /var/log/nginx/mrgun_access.log;
    error_log /var/log/nginx/mrgun_error.log warn;

    # ==================== 客户端配置 ====================
    client_max_body_size 10M;  # 最大上传大小（发票等）
    client_body_timeout 60s;
    client_header_timeout 60s;

    # ==================== Gzip 压缩 ====================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript
               application/json application/javascript application/xml+rss
               application/rss+xml font/truetype font/opentype
               application/vnd.ms-fontobject image/svg+xml;

    # ==================== 前端静态文件（生产环境代理到frontend容器）====================
    # 前端路由支持（Vue.js 单页应用）
    location / {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ==================== 后端 API 代理 ====================
    # FastAPI 后端服务（Docker环境使用容器名）
    location /api/ {
        proxy_pass http://backend:8000;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # 超时配置（财务系统可能有长事务）
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        # 禁用缓冲（实时响应）
        proxy_buffering off;

        # 限流配置（可选）
        # limit_req zone=api burst=20 nodelay;
    }

    # ==================== 管理后台 API ====================
    location /api/v1/admin/ {
        proxy_pass http://backend:8000;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 管理后台可能有更长的超时
        proxy_read_timeout 180s;
    }

    # ==================== WebSocket 支持（如果需要）====================
    location /ws/ {
        proxy_pass http://backend:8000;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_read_timeout 86400;
    }

    # ==================== 健康检查 ====================
    location /health {
        proxy_pass http://backend:8000/health;
        access_log off;
        proxy_set_header Host $host;
    }

    # ==================== API 文档（生产环境可以关闭）====================
    location /docs {
        proxy_pass http://backend:8000/docs;
        proxy_set_header Host $host;

        # 生产环境建议添加认证或直接禁用
        # return 404;
    }

    location /redoc {
        proxy_pass http://backend:8000/redoc;
        proxy_set_header Host $host;

        # 生产环境建议添加认证或直接禁用
        # return 404;
    }

    # ==================== 静态资源（上传文件）====================
    # 用户上传的文件
    location /uploads/ {
        # 👇 修改为你实际的上传目录
        alias /opt/mr-game-ops/data/uploads/;

        expires 30d;
        add_header Cache-Control "public, immutable";

        # 安全：禁止执行脚本
        location ~* \.(php|pl|py|jsp|asp|sh|cgi)$ {
            return 403;
        }
    }

    # 发票 PDF 文件
    location /invoices/ {
        # 👇 修改为你实际的发票目录
        alias /opt/mr-game-ops/data/invoices/;

        expires 30d;
        add_header Cache-Control "public, immutable";

        # 只允许登录用户访问（需要后端验证）
        # 或添加 IP 白名单
    }

    # ==================== 静态资源缓存（生产环境代理到frontend）====================
    # CSS, JS 文件
    location ~* \.(css|js)$ {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        expires 7d;
        add_header Cache-Control "public, must-revalidate";
    }

    # 图片文件
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # 字体文件
    location ~* \.(woff|woff2|ttf|eot)$ {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # ==================== 安全配置 ====================
    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # 禁止访问备份文件
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # 禁止访问敏感文件
    location ~* \.(env|git|svn|htaccess|htpasswd)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ==================== 监控端点（仅内网访问）====================
    # Prometheus metrics（如果有）
    location /metrics {
        # 只允许本地访问
        allow 127.0.0.1;
        allow 172.16.0.0/12;  # 内网 IP 段，根据实际情况修改
        allow 172.20.0.0/16;  # Docker内网
        allow 172.21.0.0/16;  # Docker内网（生产）
        deny all;

        proxy_pass http://backend:8000/metrics;
        access_log off;
    }
}

# ============================================================================
# 监控面板配置（可选 - 仅通过内网或 VPN 访问）
# ============================================================================
# 如果需要通过公网访问监控，取消下面的注释并添加认证
#
# server {
#     listen 3001 ssl http2;
#     server_name mrgun.chu-jiao.com;
#
#     ssl_certificate /etc/ssl/certs/mrgun.chu-jiao.com.pem;
#     ssl_certificate_key /etc/ssl/private/mrgun.chu-jiao.com.key;
#     ssl_protocols TLSv1.2 TLSv1.3;
#
#     # HTTP 基础认证
#     auth_basic "Monitoring Dashboard";
#     auth_basic_user_file /etc/nginx/.htpasswd;
#
#     # Grafana
#     location / {
#         proxy_pass http://127.0.0.1:3000;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }
