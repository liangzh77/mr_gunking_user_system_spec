# 🚀 MR游戏运营管理系统 - 一键部署指南

> **适用场景**: 生产服务器网络受限，需要离线部署
> **优势**: 全自动化，一个脚本搞定所有步骤

---

## 📋 部署流程总览

```
┌─────────────────────────────────────────────────────────────────┐
│                        Windows 电脑                              │
│                                                                  │
│  步骤1: 下载Docker镜像 ──────► C:\docker-images\*.tar          │
│         (download-images-simple.bat)                            │
│                                                                  │
│  步骤2: 上传到服务器 ────────► windows-上传到服务器.bat        │
│         • 上传镜像文件                                           │
│         • 上传项目代码                                           │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Linux 服务器                              │
│                                                                  │
│  步骤3: 一键部署 ────────────► bash 一键部署脚本-服务器端.sh   │
│         自动完成:                                                │
│         ✓ 导入镜像                                               │
│         ✓ 创建目录                                               │
│         ✓ 复制文件                                               │
│         ✓ 构建应用                                               │
│         ✓ 启动服务                                               │
│         ✓ 健康检查                                               │
└─────────────────────────────────────────────────────────────────┘
```

---

## 第一步: 在Windows下载Docker镜像

### 1.1 确保Docker Desktop运行

- 打开 Docker Desktop
- 确保状态显示 "Running"

### 1.2 运行下载脚本

**方法A: 双击运行** (推荐)

```
双击运行: deploy\download-images-simple.bat
```

**方法B: 命令行运行**

```cmd
cd C:\liangz77\python_projects\github_projects\mr_gunking_user_system_spec\deploy
download-images-simple.bat
```

### 1.3 选择下载内容

脚本会询问要下载的内容:

- **选项1**: 仅核心镜像 (230 MB) - **推荐首次部署**
  - Python 3.11
  - PostgreSQL 14
  - Redis 7

- **选项2**: 核心 + 前端 (450 MB)
  - 核心镜像
  - Node 18
  - Nginx

- **选项3**: 全部含监控 (1 GB)
  - 所有上述镜像
  - Prometheus
  - Grafana

### 1.4 等待下载完成

- 文件将保存在 `C:\docker-images\`
- 下载时间取决于网速 (约5-15分钟)

---

## 第二步: 上传到服务器

### 2.1 准备服务器信息

确保你有:
- ✅ 服务器IP地址
- ✅ SSH用户名 (通常是 `root`)
- ✅ SSH密码或密钥

### 2.2 运行上传脚本

**双击运行**:

```
双击运行: deploy\windows-上传到服务器.bat
```

脚本会提示输入:
1. 服务器IP地址
2. SSH用户名 (默认: root)
3. 确认上传

### 2.3 等待上传完成

脚本会自动上传:
- ✅ Docker镜像文件 → `/root/docker-images/`
- ✅ 项目代码 → `/root/mr-game-ops-upload/`

上传时间取决于:
- 文件大小
- 网络速度
- 是否使用内网连接

**提示**: 如果上传很慢，建议使用内网IP或有线网络。

---

## 第三步: 在服务器上一键部署

### 3.1 SSH连接到服务器

**方法A: 使用Windows PowerShell/CMD**

```bash
ssh root@你的服务器IP
# 输入密码
```

**方法B: 使用PuTTY**

1. 打开PuTTY
2. 输入服务器IP
3. 点击 "Open"
4. 输入用户名和密码

### 3.2 执行一键部署脚本

连接到服务器后，执行:

```bash
bash /root/mr-game-ops-upload/deploy/一键部署脚本-服务器端.sh
```

### 3.3 等待自动部署

脚本会**全自动**完成以下操作:

```
【步骤0/8】环境检查
  ✓ 检查Docker是否安装
  ✓ 检查Docker是否运行
  ✓ 检查docker-compose

【步骤1/8】检测项目文件
  ✓ 验证backend目录
  ✓ 验证deploy配置
  ✓ 检查关键文件

【步骤2/8】导入Docker镜像
  ✓ 检测镜像文件
  ✓ 导入所有.tar文件
  ✓ 验证导入结果

【步骤3/8】创建应用目录结构
  ✓ 创建 /opt/mr-game-ops/
  ✓ 创建data、logs、config等子目录

【步骤4/8】复制应用文件
  ✓ 复制backend代码
  ✓ 复制frontend代码（如果有）
  ✓ 复制配置文件

【步骤5/8】准备Dockerfile
  ✓ 创建优化的Backend Dockerfile
  ✓ 配置阿里云镜像源（加速pip安装）

【步骤6/8】加载配置文件
  ✓ 加载.env.prod
  ✓ 验证数据库密码
  ✓ 验证Redis密码
  ✓ 验证加密密钥

【步骤7/8】构建并启动服务
  ✓ 停止旧容器
  ✓ 构建backend镜像
  ✓ 启动所有服务

【步骤8/8】健康检查
  ✓ 检查PostgreSQL
  ✓ 检查Redis
  ✓ 检查Backend API
```

**整个过程大约需要 10-15 分钟** (首次构建)

---

## 第四步: 验证部署结果

### 4.1 检查服务状态

脚本执行完成后，会自动显示:

```
╔════════════════════════════════════════════════════════════════════╗
║                    🎉 部署完成！                                   ║
╚════════════════════════════════════════════════════════════════════╝

📋 部署信息摘要
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  服务器IP:      xxx.xxx.xxx.xxx
  应用目录:      /opt/mr-game-ops
  配置文件:      /opt/mr-game-ops/.env.prod

🌐 访问地址
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  API健康检查:   http://xxx.xxx.xxx.xxx:8000/health
  API文档:       http://xxx.xxx.xxx.xxx:8000/docs
  Grafana监控:   http://xxx.xxx.xxx.xxx:3001
  Prometheus:    http://xxx.xxx.xxx.xxx:9090
```

### 4.2 测试API访问

**在服务器上测试**:

```bash
curl http://localhost:8000/health
# 期望返回: {"status":"healthy"}
```

**在浏览器中测试**:

访问: `http://你的服务器IP:8000/health`

如果看到 `{"status":"healthy"}`，说明部署成功! 🎉

### 4.3 查看API文档

访问: `http://你的服务器IP:8000/docs`

可以看到完整的API文档和在线测试界面。

---

## 第五步: 初始化系统

### 5.1 初始化数据库 (如果需要)

```bash
# 进入backend容器
docker exec -it mr_game_ops_backend_prod bash

# 运行初始化脚本
python init_database.py

# 退出容器
exit
```

### 5.2 创建管理员账户

```bash
# 进入backend容器
docker exec -it mr_game_ops_backend_prod bash

# 运行创建管理员脚本
python create_admin_simple_v2.py

# 按提示输入管理员信息
# 退出容器
exit
```

### 5.3 配置防火墙 (重要!)

**生产环境必须配置防火墙**:

```bash
# Ubuntu/Debian
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 22/tcp   # SSH，注意不要锁死自己

# CentOS/RHEL
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --reload
```

**注意**:
- 端口8000 (后端API) 建议仅内网访问
- 生产环境应使用Nginx反向代理，只开放80/443

---

## 🔧 常用管理命令

### 查看服务状态

```bash
cd /opt/mr-game-ops
docker compose -f docker-compose.prod.yml ps
```

### 查看日志

```bash
# 查看所有日志
docker compose -f /opt/mr-game-ops/docker-compose.prod.yml logs -f

# 查看后端日志
docker logs mr_game_ops_backend_prod -f

# 查看最近50行日志
docker logs mr_game_ops_backend_prod --tail=50
```

### 重启服务

```bash
# 重启所有服务
docker compose -f /opt/mr-game-ops/docker-compose.prod.yml restart

# 重启单个服务
docker compose -f /opt/mr-game-ops/docker-compose.prod.yml restart backend
```

### 停止服务

```bash
# 停止所有服务
docker compose -f /opt/mr-game-ops/docker-compose.prod.yml down

# 停止并删除数据卷 (谨慎!)
docker compose -f /opt/mr-game-ops/docker-compose.prod.yml down -v
```

### 进入容器调试

```bash
# 进入后端容器
docker exec -it mr_game_ops_backend_prod bash

# 进入数据库容器
docker exec -it mr_game_ops_db_prod bash

# 在容器内执行psql
docker exec -it mr_game_ops_db_prod psql -U mr_admin_prod -d mr_game_ops_prod
```

---

## ❓ 常见问题

### Q1: 脚本提示"Docker未安装"

**解决**:

```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com | bash

# 启动Docker
systemctl start docker
systemctl enable docker
```

### Q2: Backend构建失败，提示pip安装错误

**原因**: requirements.txt中某个包安装失败

**解决**:

1. 查看详细错误日志
2. 可能是网络问题，脚本已配置阿里云镜像源
3. 检查是否有拼写错误或版本冲突

### Q3: 服务启动后无法访问

**检查项**:

```bash
# 1. 检查容器是否运行
docker ps

# 2. 检查防火墙
ufw status

# 3. 检查端口监听
netstat -tlnp | grep 8000

# 4. 查看backend日志
docker logs mr_game_ops_backend_prod --tail=100
```

### Q4: 如何修改配置

**步骤**:

```bash
# 1. 编辑配置文件
vi /opt/mr-game-ops/.env.prod

# 2. 重新部署
cd /opt/mr-game-ops
docker compose -f docker-compose.prod.yml down
docker compose -f docker-compose.prod.yml up -d
```

### Q5: 如何备份数据

**数据库备份**:

```bash
# 创建备份
docker exec mr_game_ops_db_prod pg_dump -U mr_admin_prod mr_game_ops_prod > backup.sql

# 恢复备份
docker exec -i mr_game_ops_db_prod psql -U mr_admin_prod mr_game_ops_prod < backup.sql
```

### Q6: 如何更新代码

**步骤**:

1. 在Windows上传新代码到服务器
2. 重新运行一键部署脚本

```bash
bash /root/mr-game-ops-upload/deploy/一键部署脚本-服务器端.sh
```

脚本会自动:
- 停止旧服务
- 复制新代码
- 重新构建
- 启动服务

---

## 📁 文件结构说明

### Windows端

```
C:\liangz77\...\mr_gunking_user_system_spec\
├── backend/                              # 后端代码
├── frontend/                             # 前端代码 (可选)
└── deploy/
    ├── download-images-simple.bat        # [步骤1] 下载镜像
    ├── windows-上传到服务器.bat          # [步骤2] 上传文件
    ├── 一键部署脚本-服务器端.sh          # [步骤3] 服务器部署
    ├── docker-compose.prod.yml           # 生产环境配置
    └── .env.prod                         # 环境配置

C:\docker-images\                         # 镜像存储位置
├── python-3.11-slim.tar
├── postgres-14-alpine.tar
└── redis-7-alpine.tar
```

### 服务器端 (部署后)

```
/root/
├── docker-images/                        # 上传的镜像
│   ├── python-3.11-slim.tar
│   ├── postgres-14-alpine.tar
│   └── redis-7-alpine.tar
└── mr-game-ops-upload/                   # 上传的项目文件
    ├── backend/
    ├── frontend/
    └── deploy/

/opt/mr-game-ops/                         # 应用运行目录
├── backend/                              # 后端代码
├── frontend/                             # 前端代码
├── config/                               # 配置文件
│   ├── nginx/
│   ├── prometheus/
│   └── grafana/
├── data/                                 # 数据持久化
│   ├── postgres/                         # 数据库数据
│   ├── redis/                            # Redis数据
│   ├── uploads/                          # 上传文件
│   └── invoices/                         # 发票文件
├── logs/                                 # 日志文件
│   ├── nginx/
│   └── backend/
├── backups/                              # 备份目录
├── docker-compose.prod.yml               # Docker编排文件
└── .env.prod                             # 环境配置
```

---

## 🎯 优势对比

### 传统方式 vs 一键部署

| 项目 | 传统方式 | 一键部署脚本 |
|-----|---------|------------|
| **步骤数** | 15+ 步 | 3 步 |
| **需要手动操作** | 很多 | 极少 |
| **容易出错** | 是 | 否 |
| **需要记忆命令** | 是 | 否 |
| **文件复制** | 手动 | 自动 |
| **目录创建** | 手动 | 自动 |
| **配置验证** | 手动 | 自动 |
| **健康检查** | 手动 | 自动 |
| **适合新手** | 否 | 是 |
| **部署时间** | 30-60分钟 | 10-15分钟 |

---

## 🆘 获取帮助

如果遇到任何问题:

1. **查看日志**
   ```bash
   docker compose -f /opt/mr-game-ops/docker-compose.prod.yml logs
   ```

2. **检查服务状态**
   ```bash
   docker compose -f /opt/mr-game-ops/docker-compose.prod.yml ps
   ```

3. **查看脚本输出**
   - 脚本会显示每一步的详细信息
   - 出错时会给出具体的错误原因和解决建议

4. **重新部署**
   - 大多数问题可以通过重新运行部署脚本解决
   - 脚本是幂等的，可以安全地多次运行

---

## ⚠️ 生产环境注意事项

1. **修改默认密码**
   - 编辑 `/opt/mr-game-ops/.env.prod`
   - 修改所有包含 "CHANGE" 的配置
   - 重新部署服务

2. **配置HTTPS**
   - 申请SSL证书
   - 配置Nginx反向代理
   - 启用HTTPS访问

3. **配置防火墙**
   - 只开放必要端口 (80, 443, 22)
   - 限制数据库端口访问

4. **启用监控**
   - 访问Grafana配置监控面板
   - 设置告警规则

5. **定期备份**
   - 配置自动备份脚本
   - 测试备份恢复流程

---

**祝部署顺利！** 🚀

如有问题，请查看日志或联系技术支持。
