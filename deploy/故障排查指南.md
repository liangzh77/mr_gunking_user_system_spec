# 🔧 MR游戏运营管理系统 - 故障排查指南

## 📋 目录
1. [常用排查命令](#常用排查命令)
2. [容器启动失败](#容器启动失败)
3. [数据库连接失败](#数据库连接失败)
4. [Redis连接失败](#redis连接失败)
5. [API无法访问](#api无法访问)
6. [前端无法访问](#前端无法访问)
7. [性能问题](#性能问题)
8. [日志查看方法](#日志查看方法)

---

## 常用排查命令

### 查看所有容器状态
```bash
cd /opt/mr-game-ops
docker compose -f docker-compose.prod.yml ps
```

**正常输出示例：**
```
NAME                        STATUS
mr_game_ops_backend_prod    Up (healthy)
mr_game_ops_db_prod         Up (healthy)
mr_game_ops_redis_prod      Up (healthy)
...
```

如果看到 `Exited` 或 `Restarting`，说明容器有问题。

### 查看容器日志
```bash
# 查看所有服务日志
docker compose -f docker-compose.prod.yml logs

# 查看特定服务日志（实时）
docker compose -f docker-compose.prod.yml logs -f backend

# 查看最近100行日志
docker compose -f docker-compose.prod.yml logs --tail=100 backend
```

### 进入容器内部调试
```bash
# 进入后端容器
docker exec -it mr_game_ops_backend_prod bash

# 进入数据库容器
docker exec -it mr_game_ops_db_prod bash

# 进入后可以执行容器内的命令，例如：
# ps aux     # 查看进程
# ls -la     # 查看文件
# env        # 查看环境变量
# exit       # 退出容器
```

### 重启服务
```bash
cd /opt/mr-game-ops

# 重启所有服务
docker compose -f docker-compose.prod.yml restart

# 重启单个服务
docker compose -f docker-compose.prod.yml restart backend

# 停止所有服务
docker compose -f docker-compose.prod.yml down

# 启动所有服务
docker compose -f docker-compose.prod.yml up -d
```

---

## 容器启动失败

### 问题1: 容器反复重启

**现象：**
```bash
$ docker ps -a
NAME                        STATUS
mr_game_ops_backend_prod    Restarting (1) 5 seconds ago
```

**排查步骤：**

1. **查看容器日志**
```bash
docker logs mr_game_ops_backend_prod --tail=100
```

2. **常见错误及解决方案：**

#### 错误1: 数据库连接失败
```
sqlalchemy.exc.OperationalError: could not connect to server
```

**原因：** 数据库还没启动完成

**解决：**
```bash
# 等待30秒让数据库完全启动
sleep 30
docker compose -f docker-compose.prod.yml restart backend
```

#### 错误2: 端口已被占用
```
Error: bind: address already in use
```

**原因：** 端口被其他程序占用

**解决：**
```bash
# 查看占用端口的进程
sudo lsof -i :8000

# 杀掉占用进程
sudo kill -9 进程ID

# 或者修改docker-compose.prod.yml中的端口映射
```

#### 错误3: 内存不足
```
MemoryError: Unable to allocate
```

**原因：** 服务器内存不足

**解决：**
```bash
# 查看内存使用
free -h

# 减少worker数量，编辑.env.prod:
WORKERS=2  # 从4改为2

# 重启服务
docker compose -f docker-compose.prod.yml restart backend
```

### 问题2: 镜像构建失败

**现象：**
```
ERROR: failed to solve: process "/bin/sh -c pip install" did not complete
```

**解决：**
```bash
# 清理Docker缓存
docker system prune -a

# 重新构建（不使用缓存）
docker compose -f docker-compose.prod.yml build --no-cache

# 如果网络问题，使用国内镜像
# 在Dockerfile中添加：
# RUN pip install -i https://pypi.tuna.tsinghua.edu.cn/simple --no-cache-dir -r requirements.txt
```

---

## 数据库连接失败

### 问题1: Backend无法连接PostgreSQL

**测试数据库连接：**
```bash
# 1. 检查数据库是否运行
docker exec mr_game_ops_db_prod pg_isready -U mr_admin_prod -d mr_game_ops_prod

# 应该输出: mr_game_ops_prod:5432 - accepting connections

# 2. 尝试手动连接
docker exec -it mr_game_ops_db_prod psql -U mr_admin_prod -d mr_game_ops_prod

# 如果能连接，说明数据库本身没问题
```

**常见原因：**

1. **密码不匹配**
   - 检查 `.env.prod` 中的 `POSTGRES_PASSWORD`
   - 确保backend和postgres容器使用相同的密码

2. **网络问题**
```bash
# 检查容器网络
docker network ls
docker network inspect mr_network

# 确保backend和postgres在同一网络
```

3. **数据库未初始化**
```bash
# 查看数据库日志
docker logs mr_game_ops_db_prod

# 重新初始化数据库
docker compose -f docker-compose.prod.yml down -v
docker compose -f docker-compose.prod.yml up -d
```

### 问题2: 数据库表不存在

**现象：**
```
relation "users" does not exist
```

**解决：**
```bash
# 1. 进入backend容器
docker exec -it mr_game_ops_backend_prod bash

# 2. 运行数据库迁移（如果有alembic）
cd /app
alembic upgrade head

# 3. 或者运行初始化脚本
python backend/init_database.py

# 4. 退出容器
exit
```

---

## Redis连接失败

### 问题: Backend无法连接Redis

**测试Redis连接：**
```bash
# 获取Redis密码
source /opt/mr-game-ops/.env.prod
echo $REDIS_PASSWORD

# 测试连接
docker exec mr_game_ops_redis_prod redis-cli -a "$REDIS_PASSWORD" ping

# 应该输出: PONG
```

**常见问题：**

1. **密码错误**
```bash
# 检查.env.prod中的REDIS_PASSWORD
cat /opt/mr-game-ops/.env.prod | grep REDIS_PASSWORD

# 确保backend的环境变量正确
docker exec mr_game_ops_backend_prod env | grep REDIS
```

2. **Redis内存不足**
```bash
# 检查Redis内存使用
docker exec mr_game_ops_redis_prod redis-cli -a "$REDIS_PASSWORD" INFO memory

# 清空Redis缓存
docker exec mr_game_ops_redis_prod redis-cli -a "$REDIS_PASSWORD" FLUSHALL
```

---

## API无法访问

### 问题1: 无法访问 http://服务器IP:8000

**排查步骤：**

1. **检查backend容器状态**
```bash
docker ps | grep backend
docker logs mr_game_ops_backend_prod --tail=50
```

2. **检查端口监听**
```bash
# 在服务器上检查8000端口
sudo ss -tuln | grep 8000

# 应该看到：
# LISTEN  0  128  0.0.0.0:8000  0.0.0.0:*
```

3. **检查防火墙**
```bash
# 检查防火墙状态
sudo ufw status

# 如果8000端口被阻止，允许它
sudo ufw allow 8000/tcp
```

4. **测试本地访问**
```bash
# 在服务器上测试
curl http://localhost:8000/health

# 如果本地能访问，说明是防火墙或网络问题
# 如果本地也不能访问，说明backend有问题
```

### 问题2: API返回500错误

**查看详细错误：**
```bash
# 查看backend日志
docker logs mr_game_ops_backend_prod -f

# 常见500错误原因：
# - 数据库连接失败
# - 环境变量配置错误
# - 代码运行时错误
```

**进入容器调试：**
```bash
# 进入容器
docker exec -it mr_game_ops_backend_prod bash

# 手动启动应用看错误
cd /app
python -m uvicorn src.main:app --host 0.0.0.0 --port 8000

# 看到的错误信息会更详细
```

---

## 前端无法访问

### 问题: 前端页面空白或报错

**排查步骤：**

1. **检查前端容器**
```bash
docker logs mr_game_ops_frontend_prod --tail=50
```

2. **检查Nginx配置**
```bash
# 查看Nginx日志
docker logs mr_game_ops_nginx

# 测试Nginx配置
docker exec mr_game_ops_nginx nginx -t
```

3. **检查前端环境变量**
```bash
# 查看前端容器环境变量
docker exec mr_game_ops_frontend_prod env | grep VITE_API_BASE_URL

# 确保API地址正确
```

---

## 性能问题

### 问题: API响应慢

**诊断步骤：**

1. **查看资源使用**
```bash
# 查看容器资源使用
docker stats

# 查看系统资源
htop
free -h
df -h
```

2. **查看数据库连接数**
```bash
docker exec mr_game_ops_db_prod psql -U mr_admin_prod -d mr_game_ops_prod -c "SELECT count(*) FROM pg_stat_activity;"
```

3. **查看Redis缓存命中率**
```bash
docker exec mr_game_ops_redis_prod redis-cli -a "$REDIS_PASSWORD" INFO stats | grep keyspace
```

4. **优化建议：**
```bash
# 增加worker数量（如果CPU够用）
# 编辑.env.prod:
WORKERS=8  # 根据CPU核心数调整

# 增加数据库连接池
# 编辑backend配置

# 重启服务
docker compose -f docker-compose.prod.yml restart backend
```

---

## 日志查看方法

### 1. 实时日志流
```bash
# 查看所有服务的实时日志
cd /opt/mr-game-ops
docker compose -f docker-compose.prod.yml logs -f

# 只看backend
docker compose -f docker-compose.prod.yml logs -f backend

# 同时看多个服务
docker compose -f docker-compose.prod.yml logs -f backend postgres redis
```

### 2. 历史日志
```bash
# 查看最近100行
docker logs mr_game_ops_backend_prod --tail=100

# 查看带时间戳的日志
docker logs mr_game_ops_backend_prod --timestamps

# 查看特定时间段的日志
docker logs mr_game_ops_backend_prod --since 2024-01-01T10:00:00
docker logs mr_game_ops_backend_prod --since 1h  # 最近1小时
```

### 3. 过滤日志
```bash
# 只看错误日志
docker logs mr_game_ops_backend_prod 2>&1 | grep -i error

# 只看警告
docker logs mr_game_ops_backend_prod 2>&1 | grep -i warning

# 只看特定关键词
docker logs mr_game_ops_backend_prod 2>&1 | grep "database"
```

### 4. 导出日志
```bash
# 导出日志到文件
docker logs mr_game_ops_backend_prod > backend_logs.txt 2>&1

# 导出所有服务日志
docker compose -f docker-compose.prod.yml logs > all_logs.txt 2>&1
```

---

## 🆘 紧急恢复步骤

### 服务完全崩溃时

```bash
# 1. 停止所有服务
cd /opt/mr-game-ops
docker compose -f docker-compose.prod.yml down

# 2. 查看磁盘空间
df -h

# 3. 清理Docker（谨慎！）
docker system prune -a

# 4. 重新启动
docker compose -f docker-compose.prod.yml up -d

# 5. 查看启动日志
docker compose -f docker-compose.prod.yml logs -f
```

### 数据库损坏时

```bash
# 1. 停止服务
docker compose -f docker-compose.prod.yml down

# 2. 备份当前数据（即使损坏也要备份）
sudo cp -r /opt/mr-game-ops/data/postgres /opt/mr-game-ops/backups/postgres_corrupted_$(date +%Y%m%d)

# 3. 如果有正常备份，恢复它
# 见备份恢复章节

# 4. 如果没有备份，删除数据重新初始化
sudo rm -rf /opt/mr-game-ops/data/postgres/*
docker compose -f docker-compose.prod.yml up -d
```

---

## 📞 获取帮助

如果以上方法都无法解决问题：

1. **收集信息**
```bash
# 运行检查脚本
bash /opt/mr-game-ops/deploy/check-deployment.sh > check_result.txt

# 导出所有日志
docker compose -f docker-compose.prod.yml logs > all_logs.txt 2>&1

# 查看系统信息
uname -a > system_info.txt
free -h >> system_info.txt
df -h >> system_info.txt
```

2. **描述问题**
   - 什么时候开始出现问题？
   - 做了什么操作之前出现的？
   - 错误信息是什么？
   - 有没有修改过配置？

3. **提供日志和检查结果**
   - check_result.txt
   - all_logs.txt
   - system_info.txt

---

**记住：遇到问题不要慌，90%的问题都能通过日志找到原因！**
