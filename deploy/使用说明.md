# 🚀 MR游戏运营管理系统 - 离线部署指南

> 适用于网络受限或Docker镜像拉取失败的情况

---

## 📋 部署流程概览

```
Windows电脑                    服务器
    │                            │
    ├─ 1. 下载Docker镜像         │
    │                            │
    ├─ 2. 导出为tar文件          │
    │                            │
    ├─ 3. 上传到服务器 ─────────→ │
    │                            │
    │                            ├─ 4. 导入镜像
    │                            │
    │                            ├─ 5. 构建应用
    │                            │
    │                            └─ 6. 启动服务
```

---

## 第一步：在Windows上下载镜像

### 方法A：使用PowerShell脚本（推荐）

1. **确保Docker Desktop正在运行**
   - 打开Docker Desktop应用
   - 确保状态为"Running"

2. **以管理员身份运行PowerShell**
   - 按 `Win + X`
   - 选择"Windows PowerShell (管理员)"

3. **执行下载脚本**
   ```powershell
   cd C:\liangz77\python_projects\github_projects\mr_gunking_user_system_spec\deploy

   # 允许执行脚本（首次需要）
   Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass

   # 执行下载脚本
   .\windows-下载镜像.ps1
   ```

4. **按提示选择要下载的镜像**
   - 选项1：只下载核心镜像（约230 MB）- **推荐首次部署**
   - 选项2：核心 + 前端镜像（约450 MB）
   - 选项3：全部镜像含监控（约1 GB）

5. **等待下载完成**
   - 核心镜像大约需要5-10分钟（取决于网速）
   - 下载完成后会自动导出为tar文件
   - 文件保存在：`C:\docker-images\`

### 方法B：手动下载（如果脚本失败）

在PowerShell中手动执行：

```powershell
# 创建导出目录
mkdir C:\docker-images
cd C:\docker-images

# 下载核心镜像
docker pull python:3.11-slim
docker pull postgres:14-alpine
docker pull redis:7-alpine

# 导出为tar文件
docker save python:3.11-slim -o python-3.11-slim.tar
docker save postgres:14-alpine -o postgres-14-alpine.tar
docker save redis:7-alpine -o redis-7-alpine.tar

# 查看导出的文件
dir
```

---

## 第二步：上传镜像到服务器

### 方法A：使用SCP命令（推荐）

在PowerShell中执行：

```powershell
cd C:\docker-images

# 上传所有tar文件到服务器（替换成你的服务器IP）
scp *.tar root@你的服务器IP:/root/docker-images/
```

**注意：**
- 首次连接会提示是否信任服务器，输入 `yes`
- 需要输入服务器root密码
- 上传时间取决于文件大小和网速

### 方法B：使用WinSCP图形界面

1. **下载WinSCP**
   - 访问：https://winscp.net/
   - 下载并安装

2. **连接到服务器**
   - 协议：SFTP
   - 主机名：你的服务器IP
   - 端口：22
   - 用户名：root
   - 密码：你的服务器密码

3. **上传文件**
   - 左侧浏览到：`C:\docker-images\`
   - 右侧进入：`/root/docker-images/`
   - 拖拽所有 `.tar` 文件到右侧
   - 等待上传完成

### 方法C：使用FileZilla

1. **下载FileZilla**
   - 访问：https://filezilla-project.org/
   - 下载FileZilla Client

2. **配置连接**
   - 协议：SFTP
   - 主机：你的服务器IP
   - 用户名：root
   - 密码：你的服务器密码
   - 端口：22

3. **上传文件**
   - 操作同WinSCP

---

## 第三步：在服务器上部署

### 1. SSH连接到服务器

在Windows PowerShell中：

```bash
ssh root@你的服务器IP
```

输入密码后登录。

### 2. 上传部署脚本（如果还没上传）

如果之前没有上传过deploy目录，需要先上传：

在Windows PowerShell中（新开一个窗口）：

```powershell
cd C:\liangz77\python_projects\github_projects\mr_gunking_user_system_spec
scp -r deploy backend frontend root@你的服务器IP:/root/
```

### 3. 复制文件到应用目录

在服务器上执行：

```bash
# 确保应用目录存在
mkdir -p /opt/mr-game-ops

# 复制所有文件
cp -r /root/deploy/* /opt/mr-game-ops/
cp -r /root/backend /opt/mr-game-ops/
cp -r /root/frontend /opt/mr-game-ops/
```

### 4. 执行部署脚本

```bash
# 进入部署目录
cd /opt/mr-game-ops

# 给脚本添加执行权限
chmod +x /root/deploy/server-导入并部署.sh

# 执行部署
bash /root/deploy/server-导入并部署.sh
```

### 5. 等待部署完成

脚本会自动完成：
- ✅ 导入所有Docker镜像
- ✅ 准备配置文件
- ✅ 构建后端应用
- ✅ 启动所有服务
- ✅ 验证服务健康状态

**整个过程大约需要10-15分钟。**

---

## 第四步：验证部署

### 1. 检查服务状态

```bash
cd /opt/mr-game-ops
docker compose -f docker-compose.prod.yml ps
```

所有服务状态应该是 `Up (healthy)`。

### 2. 测试API访问

```bash
# 在服务器上测试
curl http://localhost:8000/health

# 应该返回：{"status":"healthy"}
```

### 3. 在浏览器中访问

在你的电脑浏览器中访问（替换成你的服务器IP）：

- API健康检查：`http://服务器IP:8000/health`
- API文档：`http://服务器IP:8000/docs`

如果能访问，说明部署成功！🎉

---

## 常见问题

### Q1: PowerShell提示"无法执行脚本"

**解决：**
```powershell
Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
```

### Q2: Docker Desktop未运行

**解决：**
- 打开Docker Desktop应用
- 等待状态变为"Running"
- 重新执行脚本

### Q3: 上传速度很慢

**解决：**
- 使用有线网络而非WiFi
- 选择网络较好的时间段上传
- 如果有内网，确保使用内网IP上传

### Q4: 服务器上导入镜像失败

**检查：**
```bash
# 检查tar文件是否完整
cd /root/docker-images
ls -lh *.tar

# 手动尝试导入单个镜像
docker load -i python-3.11-slim.tar
```

### Q5: Backend容器启动失败

**查看日志：**
```bash
docker logs mr_game_ops_backend_prod --tail=100
```

**常见原因：**
- requirements.txt中的某个包安装失败
- 代码有语法错误
- 环境变量配置错误

---

## 🔧 后续操作

### 初始化数据库

```bash
# 进入backend容器
docker exec -it mr_game_ops_backend_prod bash

# 运行初始化脚本
cd /app
python init_database.py

# 退出容器
exit
```

### 创建管理员账户

```bash
# 进入backend容器
docker exec -it mr_game_ops_backend_prod bash

# 运行创建管理员脚本
cd /app
python create_admin_simple_v2.py

# 按提示输入管理员信息
# 退出容器
exit
```

### 配置HTTPS（可选）

如果有域名，可以配置SSL证书：

```bash
cd /opt/mr-game-ops
bash /root/deploy/03-setup-ssl.sh 你的域名.com
```

---

## 📝 文件清单

确保以下文件都已正确放置：

```
服务器上的文件结构：

/root/
├── docker-images/              # 镜像文件目录
│   ├── python-3.11-slim.tar
│   ├── postgres-14-alpine.tar
│   └── redis-7-alpine.tar
│
└── deploy/
    └── server-导入并部署.sh    # 部署脚本

/opt/mr-game-ops/               # 应用目录
├── backend/                    # 后端代码
├── frontend/                   # 前端代码（可选）
├── docker-compose.prod.yml     # Docker编排文件
├── .env.prod                   # 环境配置
└── .env                        # 实际使用的配置
```

---

## 🆘 获取帮助

如果遇到问题：

1. **查看日志**
   ```bash
   docker compose -f /opt/mr-game-ops/docker-compose.prod.yml logs
   ```

2. **查看特定服务日志**
   ```bash
   docker logs mr_game_ops_backend_prod --tail=100
   ```

3. **检查服务状态**
   ```bash
   docker compose -f /opt/mr-game-ops/docker-compose.prod.yml ps
   ```

4. **重启服务**
   ```bash
   docker compose -f /opt/mr-game-ops/docker-compose.prod.yml restart
   ```

---

**祝部署顺利！** 🚀
