# 🚀 MR游戏运营管理系统 - 生产环境部署操作手册

> **重要提示：** 请按顺序完成每一步，不要跳过任何步骤！

---

## 📝 准备清单（开始前必读）

在开始部署之前，确保你已经准备好：

- [ ] Ubuntu 24.04 LTS服务器（最低4GB内存、20GB硬盘）
- [ ] 服务器的root账号和密码
- [ ] 域名（如果需要HTTPS）
- [ ] 域名已解析到服务器IP
- [ ] 能够通过SSH连接到服务器

---

## 第一部分：在你的Windows电脑上操作

### 步骤1: 生成强密码

在Windows上打开浏览器，访问：https://www.random.org/strings/

**生成以下密码（每个都要记录下来）：**

| 用途 | 长度 | 你的密码（填写） |
|------|------|------------------|
| 数据库密码 | 20字符 | ________________ |
| Redis密码 | 20字符 | ________________ |
| 加密密钥 | 32字符 | ________________ |
| JWT密钥 | 64字符 | ________________ |
| Grafana密码 | 16字符 | ________________ |

**配置项：**
- 你的域名: ________________
- 服务器IP: ________________

### 步骤2: 修改配置文件

1. 打开文件：
   ```
   C:\liangz77\python_projects\github_projects\mr_gunking_user_system_spec\deploy\.env.prod
   ```

2. 用记事本打开，修改以下内容：

```bash
# 把下面的内容改成你刚才记录的密码
POSTGRES_PASSWORD=你的数据库密码
REDIS_PASSWORD=你的Redis密码
ENCRYPTION_KEY=你的加密密钥（32字符）
JWT_SECRET_KEY=你的JWT密钥（64字符）
CORS_ORIGINS=https://你的域名.com,https://www.你的域名.com
API_BASE_URL=https://你的域名.com/api/v1
GRAFANA_PASSWORD=你的Grafana密码
```

3. **保存文件（Ctrl+S）**

### 步骤3: 上传文件到服务器

1. 打开Windows命令提示符（CMD）或PowerShell

2. 执行以下命令（把`你的服务器IP`换成实际IP）：

```bash
# 进入项目目录
cd C:\liangz77\python_projects\github_projects\mr_gunking_user_system_spec

# 上传整个项目到服务器
scp -r deploy backend frontend root@你的服务器IP:/root/
```

3. 输入服务器密码，等待上传完成（可能需要5-10分钟）

---

## 第二部分：在服务器上操作

### 步骤4: 连接到服务器

**Windows用户使用PowerShell或CMD：**
```bash
ssh root@你的服务器IP
```

输入密码，看到 `root@服务器名:~#` 说明登录成功。

### 步骤5: 给脚本添加执行权限

```bash
cd /root/deploy
chmod +x *.sh
```

### 步骤6: 运行一键部署脚本

```bash
bash deploy-production.sh
```

**这个脚本会自动完成：**
- ✅ 检查系统环境
- ✅ 更新系统
- ✅ 安装Docker
- ✅ 创建目录结构
- ✅ 配置防火墙
- ✅ 构建和启动所有服务
- ✅ 配置自动备份

**需要等待：10-15分钟**

如果看到最后显示：
```
╔════════════════════════════════════════════════════════════════════╗
║                    🎉 部署成功完成！                               ║
╚════════════════════════════════════════════════════════════════════╝
```

说明部署成功！

### 步骤7: 验证部署

```bash
cd /root/deploy
bash check-deployment.sh
```

检查是否所有服务都显示 `✓ 正常`

---

## 第三部分：初始化和测试

### 步骤8: 初始化数据库

```bash
# 进入后端容器
docker exec -it mr_game_ops_backend_prod bash

# 如果有数据库迁移文件，运行：
cd /app
alembic upgrade head

# 或者运行初始化脚本
python init_database.py

# 退出容器
exit
```

### 步骤9: 创建管理员账户

```bash
# 进入后端容器
docker exec -it mr_game_ops_backend_prod bash

# 运行创建管理员脚本
cd /app
python create_admin_simple_v2.py

# 按提示输入管理员信息
# 退出容器
exit
```

### 步骤10: 测试访问

在浏览器中访问以下地址（把`你的服务器IP`换成实际IP）：

| 服务 | 地址 | 说明 |
|------|------|------|
| API健康检查 | `http://你的服务器IP:8000/health` | 应该显示 `{"status":"healthy"}` |
| API文档 | `http://你的服务器IP:8000/docs` | 显示Swagger文档 |
| Grafana监控 | `http://你的服务器IP:3001` | 用户名admin，密码见配置文件 |

**如果全部能访问，恭喜你部署成功！** 🎉

---

## 第四部分：配置HTTPS（可选但强烈推荐）

### 步骤11: 确认域名解析

在浏览器中访问：`http://你的域名.com`

如果能访问，说明域名解析正常。

### 步骤12: 配置SSL证书

```bash
cd /root/deploy
bash 03-setup-ssl.sh 你的域名.com
```

等待脚本执行完成，会自动申请Let's Encrypt免费证书。

### 步骤13: 验证HTTPS

访问：`https://你的域名.com/health`

如果能访问且浏览器显示安全锁标志，说明HTTPS配置成功。

---

## 🎓 日常管理命令（记住这些）

### 查看服务状态
```bash
cd /opt/mr-game-ops
docker compose -f docker-compose.yml ps
```

### 查看日志
```bash
# 查看所有日志
docker compose -f docker-compose.yml logs

# 查看后端日志（实时）
docker compose -f docker-compose.yml logs -f backend

# 查看最近100行日志
docker compose -f docker-compose.yml logs --tail=100 backend
```

### 重启服务
```bash
cd /opt/mr-game-ops

# 重启所有服务
docker compose -f docker-compose.yml restart

# 重启单个服务
docker compose -f docker-compose.yml restart backend
```

### 停止服务
```bash
cd /opt/mr-game-ops
docker compose -f docker-compose.yml down
```

### 启动服务
```bash
cd /opt/mr-game-ops
docker compose -f docker-compose.yml up -d
```

### 手动备份
```bash
/opt/mr-game-ops/scripts/backup.sh
```

### 查看备份
```bash
ls -lh /opt/mr-game-ops/backups/
```

---

## ❌ 常见问题快速解决

### 问题1: 容器启动失败

```bash
# 查看具体哪个容器有问题
docker ps -a

# 查看失败容器的日志（把容器名换成实际的）
docker logs 容器名

# 重新启动
cd /opt/mr-game-ops
docker compose -f docker-compose.yml restart
```

### 问题2: 无法访问API

```bash
# 检查防火墙
sudo ufw status

# 检查端口是否监听
sudo ss -tuln | grep 8000

# 检查后端日志
docker logs mr_game_ops_backend_prod --tail=50
```

### 问题3: 数据库连接失败

```bash
# 测试数据库
docker exec mr_game_ops_db_prod pg_isready -U mr_admin_prod -d mr_game_ops_prod

# 查看数据库日志
docker logs mr_game_ops_db_prod --tail=50

# 重启数据库
docker compose -f docker-compose.yml restart postgres
```

### 问题4: 系统运行缓慢

```bash
# 查看资源使用
docker stats

# 查看系统资源
htop
free -h

# 重启所有服务
cd /opt/mr-game-ops
docker compose -f docker-compose.yml restart
```

---

## 📚 更多帮助

- **详细故障排查：** 查看 `故障排查指南.md`
- **运行检查脚本：** `bash /root/deploy/check-deployment.sh`
- **查看完整README：** `cat /root/deploy/README.md`

---

## ✅ 部署成功检查清单

部署完成后，确认以下所有项都是 ✓：

- [ ] 所有Docker容器状态为 `Up (healthy)`
- [ ] 可以访问 `http://服务器IP:8000/health`
- [ ] 可以访问 `http://服务器IP:8000/docs`
- [ ] 可以访问 Grafana监控面板
- [ ] 数据库可以正常连接
- [ ] Redis可以正常连接
- [ ] 创建了管理员账户
- [ ] 自动备份已配置（执行 `crontab -l` 查看）
- [ ] （可选）HTTPS证书已配置

---

## 🎯 下一步

部署成功后，你可以：

1. 登录系统，创建运营账号
2. 配置游戏站点
3. 测试各项功能
4. 设置监控告警
5. 制定备份恢复计划

---

**🎉 恭喜你完成部署！有问题随时查看故障排查指南。**

**记住：日志是你最好的朋友！遇到问题先看日志。**
