# 🚀 前端部署指南

## 📋 已完成的配置

### ✅ 1. Frontend Dockerfile (frontend/Dockerfile.prod)
- 多阶段构建优化
- 使用淘宝npm镜像加速
- Nginx alpine镜像（轻量级）
- 健康检查配置

### ✅ 2. Nginx配置
**Frontend内部nginx** (frontend/nginx.conf):
- Gzip压缩
- 静态资源缓存
- Vue Router history模式支持
- 安全头配置

**外层nginx反向代理** (deploy/config/nginx/nginx.http.conf):
- `/api/` → Backend服务
- `/` → Frontend服务
- 速率限制
- 健康检查端点

### ✅ 3. Docker Compose配置
- frontend服务已添加
- nginx反向代理已配置
- 健康检查和日志配置完善

---

## 🚀 部署步骤

### 步骤1: 上传前端代码到服务器

**在Windows PowerShell中执行**:

```powershell
# 使用之前的上传脚本
cd C:\liangz77\python_projects\github_projects\mr_gunking_user_system_spec\deploy
.\上传到服务器.ps1
```

### 步骤2: 在服务器上准备nginx配置

```bash
# SSH到服务器
ssh root@121.41.231.69

# 复制HTTP版nginx配置（不需要SSL证书）
cd /opt/mr-game-ops
cp config/nginx/nginx.http.conf config/nginx/nginx.conf

# 或者使用符号链接
ln -sf /opt/mr-game-ops/config/nginx/nginx.http.conf /opt/mr-game-ops/config/nginx/nginx.conf
```

### 步骤3: 构建frontend镜像

```bash
cd /opt/mr-game-ops

# 构建frontend镜像（需要5-10分钟，首次构建会下载依赖）
docker compose -f docker-compose.yml build frontend
```

**预期输出**:
```
[+] Building 300.5s (12/12) FINISHED
 => [builder 1/6] FROM node:18-alpine
 => [builder 2/6] RUN npm config set registry...
 => [builder 3/6] COPY package*.json ./
 => [builder 4/6] RUN npm ci
 => [builder 5/6] COPY . .
 => [builder 6/6] RUN npm run build
 => [stage-1 1/2] COPY nginx.conf /etc/nginx/conf.d/default.conf
 => [stage-1 2/2] COPY --from=builder /app/dist /usr/share/nginx/html
```

### 步骤4: 启动所有服务

```bash
# 启动所有服务（包括frontend和nginx）
docker compose -f docker-compose.yml up -d

# 查看服务状态
docker compose -f docker-compose.yml ps
```

**预期输出**:
```
NAME                         IMAGE                      STATUS
mr_game_ops_backend_prod     mr-game-ops-backend        Up (healthy)
mr_game_ops_db_prod          postgres:14-alpine         Up (healthy)
mr_game_ops_frontend_prod    mr-game-ops-frontend       Up (healthy)
mr_game_ops_grafana          grafana/grafana:latest     Up
mr_game_ops_nginx            nginx:alpine               Up
mr_game_ops_prometheus       prom/prometheus:latest     Up
mr_game_ops_redis_prod       redis:7-alpine             Up (healthy)
```

### 步骤5: 验证部署

```bash
# 1. 检查frontend容器
docker logs mr_game_ops_frontend_prod --tail=20

# 2. 检查nginx容器
docker logs mr_game_ops_nginx --tail=20

# 3. 测试frontend健康检查
curl http://localhost/health

# 4. 测试API代理
curl http://localhost/api/health  # 应该返回backend的健康检查
```

---

## 🌐 访问地址

部署成功后，可以通过以下地址访问：

### 生产环境访问
- **前端登录页面**: `http://121.41.231.69/`
- **API接口**: `http://121.41.231.69/api/`
- **健康检查**: `http://121.41.231.69/health`

### 监控和管理
- **Grafana**: `http://121.41.231.69:3001`
- **Prometheus**: `http://121.41.231.69:9090`

---

## 🔧 常见问题排查

### 问题1: Frontend容器启动失败

**查看日志**:
```bash
docker logs mr_game_ops_frontend_prod --tail=100
```

**可能原因**:
- npm依赖安装失败
- 构建过程出错
- nginx配置错误

**解决方法**:
```bash
# 重新构建
docker compose -f docker-compose.yml build --no-cache frontend
docker compose -f docker-compose.yml up -d frontend
```

### 问题2: Nginx无法启动

**查看日志**:
```bash
docker logs mr_game_ops_nginx --tail=100
```

**可能原因**:
- nginx配置语法错误
- 配置文件路径不正确
- 端口被占用

**解决方法**:
```bash
# 测试nginx配置
docker exec mr_game_ops_nginx nginx -t

# 如果配置有误，修复后重启
docker compose -f docker-compose.yml restart nginx
```

### 问题3: 前端页面显示404或无法加载

**检查步骤**:
```bash
# 1. 确认frontend容器运行正常
docker ps | grep frontend

# 2. 进入frontend容器检查dist目录
docker exec -it mr_game_ops_frontend_prod ls -la /usr/share/nginx/html

# 3. 检查nginx配置
docker exec -it mr_game_ops_nginx cat /etc/nginx/nginx.conf
```

**解决方法**:
```bash
# 检查nginx配置是否正确
cat /opt/mr-game-ops/config/nginx/nginx.conf | grep "frontend"

# 应该看到：
# upstream frontend {
#     server frontend:80;
# }
```

### 问题4: API请求失败（CORS错误）

**检查backend的CORS配置**:
```bash
# 查看.env.prod中的CORS配置
cat /opt/mr-game-ops/.env.prod | grep CORS

# 应该包含前端的地址
# CORS_ORIGINS=http://121.41.231.69,http://localhost
```

**修改配置**:
```bash
# 编辑.env.prod
vi /opt/mr-game-ops/.env.prod

# 修改CORS_ORIGINS
CORS_ORIGINS=http://121.41.231.69,http://localhost,http://127.0.0.1

# 重启backend
docker compose -f docker-compose.yml restart backend
```

---

## 📊 监控和日志

### 查看实时日志

```bash
# 所有服务日志
docker compose -f /opt/mr-game-ops/docker-compose.yml logs -f

# 只看frontend
docker logs mr_game_ops_frontend_prod -f

# 只看nginx
docker logs mr_game_ops_nginx -f
```

### 查看访问日志

```bash
# Nginx访问日志
docker exec mr_game_ops_nginx tail -f /var/log/nginx/access.log

# Nginx错误日志
docker exec mr_game_ops_nginx tail -f /var/log/nginx/error.log
```

---

## 🔄 更新前端代码

### 方法1: 完整更新

```bash
# 1. 在Windows上修改代码后重新上传
# 使用上传脚本上传

# 2. 在服务器上重新构建
cd /opt/mr-game-ops
docker compose -f docker-compose.yml build frontend
docker compose -f docker-compose.yml up -d frontend
```

### 方法2: 热更新（开发环境）

如果需要频繁修改，可以临时挂载源代码目录：

```yaml
# docker-compose.dev.yml
frontend:
  volumes:
    - ./frontend:/app
  command: npm run dev
```

---

## 🔒 安全建议

### 1. 启用HTTPS（推荐）

```bash
# 使用HTTPS版本的nginx配置
cd /opt/mr-game-ops
cp config/nginx/nginx.conf config/nginx/nginx.http.conf.backup
# 上传SSL证书到 /opt/mr-game-ops/config/nginx/ssl/
# 修改nginx.conf中的域名和证书路径
docker compose -f docker-compose.yml restart nginx
```

### 2. 关闭不必要的端口

```bash
# 关闭8000端口（backend直接访问）
# 编辑docker-compose.yml，删除backend的ports配置
# 重启服务
docker compose -f docker-compose.yml down
docker compose -f docker-compose.yml up -d
```

### 3. 配置防火墙

```bash
# 只开放必要端口
ufw allow 80/tcp   # HTTP
ufw allow 443/tcp  # HTTPS
ufw allow 22/tcp   # SSH

# 删除8000端口（如果之前开放了）
ufw delete allow 8000/tcp
```

---

## ✅ 部署检查清单

- [ ] Frontend代码已上传到服务器
- [ ] Nginx配置文件已复制到正确位置
- [ ] Frontend镜像构建成功
- [ ] 所有服务状态为 "Up (healthy)"
- [ ] 可以访问 `http://服务器IP/`
- [ ] API请求正常（`http://服务器IP/api/health`）
- [ ] 静态资源加载正常（JS、CSS、图片）
- [ ] 登录功能测试通过
- [ ] 监控面板可访问（Grafana、Prometheus）

---

## 🆘 获取帮助

如果遇到问题：

1. **查看日志**: `docker logs <容器名> --tail=100`
2. **检查容器状态**: `docker ps -a`
3. **测试网络连接**: `docker exec <容器名> ping frontend`
4. **查看nginx配置**: `docker exec mr_game_ops_nginx nginx -T`

---

**祝部署顺利！** 🎉
