# ğŸš€ å‰ç«¯éƒ¨ç½²æŒ‡å—

## ğŸ“‹ å·²å®Œæˆçš„é…ç½®

### âœ… 1. Frontend Dockerfile (frontend/Dockerfile.prod)
- å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–
- ä½¿ç”¨æ·˜å®npmé•œåƒåŠ é€Ÿ
- Nginx alpineé•œåƒï¼ˆè½»é‡çº§ï¼‰
- å¥åº·æ£€æŸ¥é…ç½®

### âœ… 2. Nginxé…ç½®
**Frontendå†…éƒ¨nginx** (frontend/nginx.conf):
- Gzipå‹ç¼©
- é™æ€èµ„æºç¼“å­˜
- Vue Router historyæ¨¡å¼æ”¯æŒ
- å®‰å…¨å¤´é…ç½®

**å¤–å±‚nginxåå‘ä»£ç†** (deploy/config/nginx/nginx.http.conf):
- `/api/` â†’ BackendæœåŠ¡
- `/` â†’ FrontendæœåŠ¡
- é€Ÿç‡é™åˆ¶
- å¥åº·æ£€æŸ¥ç«¯ç‚¹

### âœ… 3. Docker Composeé…ç½®
- frontendæœåŠ¡å·²æ·»åŠ 
- nginxåå‘ä»£ç†å·²é…ç½®
- å¥åº·æ£€æŸ¥å’Œæ—¥å¿—é…ç½®å®Œå–„

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1: ä¸Šä¼ å‰ç«¯ä»£ç åˆ°æœåŠ¡å™¨

**åœ¨Windows PowerShellä¸­æ‰§è¡Œ**:

```powershell
# ä½¿ç”¨ä¹‹å‰çš„ä¸Šä¼ è„šæœ¬
cd C:\liangz77\python_projects\github_projects\mr_gunking_user_system_spec\deploy
.\ä¸Šä¼ åˆ°æœåŠ¡å™¨.ps1
```

### æ­¥éª¤2: åœ¨æœåŠ¡å™¨ä¸Šå‡†å¤‡nginxé…ç½®

```bash
# SSHåˆ°æœåŠ¡å™¨
ssh root@121.41.231.69

# å¤åˆ¶HTTPç‰ˆnginxé…ç½®ï¼ˆä¸éœ€è¦SSLè¯ä¹¦ï¼‰
cd /opt/mr-game-ops
cp config/nginx/nginx.http.conf config/nginx/nginx.conf

# æˆ–è€…ä½¿ç”¨ç¬¦å·é“¾æ¥
ln -sf /opt/mr-game-ops/config/nginx/nginx.http.conf /opt/mr-game-ops/config/nginx/nginx.conf
```

### æ­¥éª¤3: æ„å»ºfrontendé•œåƒ

```bash
cd /opt/mr-game-ops

# æ„å»ºfrontendé•œåƒï¼ˆéœ€è¦5-10åˆ†é’Ÿï¼Œé¦–æ¬¡æ„å»ºä¼šä¸‹è½½ä¾èµ–ï¼‰
docker compose build frontend
```

**é¢„æœŸè¾“å‡º**:
```
[+] Building 300.5s (12/12) FINISHED
 => [builder 1/6] FROM node:18-alpine
 => [builder 2/6] RUN npm config set registry...
 => [builder 3/6] COPY package*.json ./
 => [builder 4/6] RUN npm ci
 => [builder 5/6] COPY . .
 => [builder 6/6] RUN npm run build
 => [stage-1 1/2] COPY nginx.conf /etc/nginx/conf.d/default.conf
 => [stage-1 2/2] COPY --from=builder /app/dist /usr/share/nginx/html
```

### æ­¥éª¤4: å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåŒ…æ‹¬frontendå’Œnginxï¼‰
docker compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker compose ps
```

**é¢„æœŸè¾“å‡º**:
```
NAME                         IMAGE                      STATUS
mr_game_ops_backend_prod     mr-game-ops-backend        Up (healthy)
mr_game_ops_db_prod          postgres:14-alpine         Up (healthy)
mr_game_ops_frontend_prod    mr-game-ops-frontend       Up (healthy)
mr_game_ops_grafana          grafana/grafana:latest     Up
mr_game_ops_nginx            nginx:alpine               Up
mr_game_ops_prometheus       prom/prometheus:latest     Up
mr_game_ops_redis_prod       redis:7-alpine             Up (healthy)
```

### æ­¥éª¤5: éªŒè¯éƒ¨ç½²

```bash
# 1. æ£€æŸ¥frontendå®¹å™¨
docker logs mr_game_ops_frontend_prod --tail=20

# 2. æ£€æŸ¥nginxå®¹å™¨
docker logs mr_game_ops_nginx --tail=20

# 3. æµ‹è¯•frontendå¥åº·æ£€æŸ¥
curl http://localhost/health

# 4. æµ‹è¯•APIä»£ç†
curl http://localhost/api/health  # åº”è¯¥è¿”å›backendçš„å¥åº·æ£€æŸ¥
```

---

## ğŸŒ è®¿é—®åœ°å€

éƒ¨ç½²æˆåŠŸåï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®ï¼š

### ç”Ÿäº§ç¯å¢ƒè®¿é—®
- **å‰ç«¯ç™»å½•é¡µé¢**: `http://121.41.231.69/`
- **APIæ¥å£**: `http://121.41.231.69/api/`
- **å¥åº·æ£€æŸ¥**: `http://121.41.231.69/health`

### ç›‘æ§å’Œç®¡ç†
- **Grafana**: `http://121.41.231.69:3001`
- **Prometheus**: `http://121.41.231.69:9090`

---

## ğŸ”§ å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: Frontendå®¹å™¨å¯åŠ¨å¤±è´¥

**æŸ¥çœ‹æ—¥å¿—**:
```bash
docker logs mr_game_ops_frontend_prod --tail=100
```

**å¯èƒ½åŸå› **:
- npmä¾èµ–å®‰è£…å¤±è´¥
- æ„å»ºè¿‡ç¨‹å‡ºé”™
- nginxé…ç½®é”™è¯¯

**è§£å†³æ–¹æ³•**:
```bash
# é‡æ–°æ„å»º
docker compose build --no-cache frontend
docker compose up -d frontend
```

### é—®é¢˜2: Nginxæ— æ³•å¯åŠ¨

**æŸ¥çœ‹æ—¥å¿—**:
```bash
docker logs mr_game_ops_nginx --tail=100
```

**å¯èƒ½åŸå› **:
- nginxé…ç½®è¯­æ³•é”™è¯¯
- é…ç½®æ–‡ä»¶è·¯å¾„ä¸æ­£ç¡®
- ç«¯å£è¢«å ç”¨

**è§£å†³æ–¹æ³•**:
```bash
# æµ‹è¯•nginxé…ç½®
docker exec mr_game_ops_nginx nginx -t

# å¦‚æœé…ç½®æœ‰è¯¯ï¼Œä¿®å¤åé‡å¯
docker compose restart nginx
```

### é—®é¢˜3: å‰ç«¯é¡µé¢æ˜¾ç¤º404æˆ–æ— æ³•åŠ è½½

**æ£€æŸ¥æ­¥éª¤**:
```bash
# 1. ç¡®è®¤frontendå®¹å™¨è¿è¡Œæ­£å¸¸
docker ps | grep frontend

# 2. è¿›å…¥frontendå®¹å™¨æ£€æŸ¥distç›®å½•
docker exec -it mr_game_ops_frontend_prod ls -la /usr/share/nginx/html

# 3. æ£€æŸ¥nginxé…ç½®
docker exec -it mr_game_ops_nginx cat /etc/nginx/nginx.conf
```

**è§£å†³æ–¹æ³•**:
```bash
# æ£€æŸ¥nginxé…ç½®æ˜¯å¦æ­£ç¡®
cat /opt/mr-game-ops/config/nginx/nginx.conf | grep "frontend"

# åº”è¯¥çœ‹åˆ°ï¼š
# upstream frontend {
#     server frontend:80;
# }
```

### é—®é¢˜4: APIè¯·æ±‚å¤±è´¥ï¼ˆCORSé”™è¯¯ï¼‰

**æ£€æŸ¥backendçš„CORSé…ç½®**:
```bash
# æŸ¥çœ‹.env.prodä¸­çš„CORSé…ç½®
cat /opt/mr-game-ops/.env.prod | grep CORS

# åº”è¯¥åŒ…å«å‰ç«¯çš„åœ°å€
# CORS_ORIGINS=http://121.41.231.69,http://localhost
```

**ä¿®æ”¹é…ç½®**:
```bash
# ç¼–è¾‘.env.prod
vi /opt/mr-game-ops/.env.prod

# ä¿®æ”¹CORS_ORIGINS
CORS_ORIGINS=http://121.41.231.69,http://localhost,http://127.0.0.1

# é‡å¯backend
docker compose restart backend
```

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æŸ¥çœ‹å®æ—¶æ—¥å¿—

```bash
# æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker compose -f /opt/mr-game-ops/docker-compose.yml logs -f

# åªçœ‹frontend
docker logs mr_game_ops_frontend_prod -f

# åªçœ‹nginx
docker logs mr_game_ops_nginx -f
```

### æŸ¥çœ‹è®¿é—®æ—¥å¿—

```bash
# Nginxè®¿é—®æ—¥å¿—
docker exec mr_game_ops_nginx tail -f /var/log/nginx/access.log

# Nginxé”™è¯¯æ—¥å¿—
docker exec mr_game_ops_nginx tail -f /var/log/nginx/error.log
```

---

## ğŸ”„ æ›´æ–°å‰ç«¯ä»£ç 

### æ–¹æ³•1: å®Œæ•´æ›´æ–°

```bash
# 1. åœ¨Windowsä¸Šä¿®æ”¹ä»£ç åé‡æ–°ä¸Šä¼ 
# ä½¿ç”¨ä¸Šä¼ è„šæœ¬ä¸Šä¼ 

# 2. åœ¨æœåŠ¡å™¨ä¸Šé‡æ–°æ„å»º
cd /opt/mr-game-ops
docker compose build frontend
docker compose up -d frontend
```

### æ–¹æ³•2: çƒ­æ›´æ–°ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

å¦‚æœéœ€è¦é¢‘ç¹ä¿®æ”¹ï¼Œå¯ä»¥ä¸´æ—¶æŒ‚è½½æºä»£ç ç›®å½•ï¼š

```yaml
# docker-compose.dev.yml
frontend:
  volumes:
    - ./frontend:/app
  command: npm run dev
```

---

## ğŸ”’ å®‰å…¨å»ºè®®

### 1. å¯ç”¨HTTPSï¼ˆæ¨èï¼‰

```bash
# ä½¿ç”¨HTTPSç‰ˆæœ¬çš„nginxé…ç½®
cd /opt/mr-game-ops
cp config/nginx/nginx.conf config/nginx/nginx.http.conf.backup
# ä¸Šä¼ SSLè¯ä¹¦åˆ° /opt/mr-game-ops/config/nginx/ssl/
# ä¿®æ”¹nginx.confä¸­çš„åŸŸåå’Œè¯ä¹¦è·¯å¾„
docker compose restart nginx
```

### 2. å…³é—­ä¸å¿…è¦çš„ç«¯å£

```bash
# å…³é—­8000ç«¯å£ï¼ˆbackendç›´æ¥è®¿é—®ï¼‰
# ç¼–è¾‘docker-compose.ymlï¼Œåˆ é™¤backendçš„portsé…ç½®
# é‡å¯æœåŠ¡
docker compose down
docker compose up -d
```

### 3. é…ç½®é˜²ç«å¢™

```bash
# åªå¼€æ”¾å¿…è¦ç«¯å£
ufw allow 80/tcp   # HTTP
ufw allow 443/tcp  # HTTPS
ufw allow 22/tcp   # SSH

# åˆ é™¤8000ç«¯å£ï¼ˆå¦‚æœä¹‹å‰å¼€æ”¾äº†ï¼‰
ufw delete allow 8000/tcp
```

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] Frontendä»£ç å·²ä¸Šä¼ åˆ°æœåŠ¡å™¨
- [ ] Nginxé…ç½®æ–‡ä»¶å·²å¤åˆ¶åˆ°æ­£ç¡®ä½ç½®
- [ ] Frontendé•œåƒæ„å»ºæˆåŠŸ
- [ ] æ‰€æœ‰æœåŠ¡çŠ¶æ€ä¸º "Up (healthy)"
- [ ] å¯ä»¥è®¿é—® `http://æœåŠ¡å™¨IP/`
- [ ] APIè¯·æ±‚æ­£å¸¸ï¼ˆ`http://æœåŠ¡å™¨IP/api/health`ï¼‰
- [ ] é™æ€èµ„æºåŠ è½½æ­£å¸¸ï¼ˆJSã€CSSã€å›¾ç‰‡ï¼‰
- [ ] ç™»å½•åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] ç›‘æ§é¢æ¿å¯è®¿é—®ï¼ˆGrafanaã€Prometheusï¼‰

---

## ğŸ†˜ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹æ—¥å¿—**: `docker logs <å®¹å™¨å> --tail=100`
2. **æ£€æŸ¥å®¹å™¨çŠ¶æ€**: `docker ps -a`
3. **æµ‹è¯•ç½‘ç»œè¿æ¥**: `docker exec <å®¹å™¨å> ping frontend`
4. **æŸ¥çœ‹nginxé…ç½®**: `docker exec mr_game_ops_nginx nginx -T`

---

**ç¥éƒ¨ç½²é¡ºåˆ©ï¼** ğŸ‰
