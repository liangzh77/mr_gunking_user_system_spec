# ============================================================================
# Nginx SSL é…ç½®æ–‡ä»¶ - MRæ¸¸æˆè¿è¥ç®¡ç†ç³»ç»Ÿ
# åŸŸå: mrgun.chu-jiao.com
# ============================================================================

# HTTP æœåŠ¡å™¨ - è‡ªåŠ¨é‡å®šå‘åˆ° HTTPS
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name localhost mrgun.chu-jiao.com www.mrgun.chu-jiao.com;

    # æ‰€æœ‰ HTTP è¯·æ±‚é‡å®šå‘åˆ° HTTPS
    return 301 https://$server_name$request_uri;
}

# HTTPS ä¸»æœåŠ¡å™¨
server {
    listen 443 ssl http2 default_server;
    listen [::]:443 ssl http2 default_server;

    server_name localhost mrgun.chu-jiao.com www.mrgun.chu-jiao.com;

    # ==================== SSL è¯ä¹¦é…ç½® ====================
    # å¼€å‘ç¯å¢ƒä½¿ç”¨localhostè‡ªç­¾åè¯ä¹¦
    ssl_certificate /etc/ssl/certs/localhost.crt;
    ssl_certificate_key /etc/ssl/private/localhost.key;

    # SSL å®‰å…¨åè®®é…ç½® - å¼€å‘ç¯å¢ƒå…è®¸ TLS 1.2 + 1.3
    ssl_protocols TLSv1.2 TLSv1.3;
    # TLS 1.2 å¯†ç å¥—ä»¶é…ç½®
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;

    # SSL ä¼šè¯ç¼“å­˜ä¼˜åŒ–
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;

    # ==================== å®‰å…¨å¤´é…ç½® ====================
    # HSTS - å¼ºåˆ¶ HTTPS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # é˜²æ­¢ç‚¹å‡»åŠ«æŒ
    add_header X-Frame-Options "SAMEORIGIN" always;

    # é˜²æ­¢ MIME ç±»å‹å—…æ¢
    add_header X-Content-Type-Options "nosniff" always;

    # XSS ä¿æŠ¤
    add_header X-XSS-Protection "1; mode=block" always;

    # Referrer ç­–ç•¥
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # CSP ç­–ç•¥ - å¼€å‘ç¯å¢ƒå…è®¸CDNç”¨äºSwagger UIå’Œlocalhost APIè¿æ¥
    # æ³¨æ„ï¼šä¸ä½¿ç”¨alwayså‚æ•°ï¼Œå…è®¸åç«¯è¦†ç›–æ­¤CSPï¼ˆåç«¯æœ‰æ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼‰
    add_header Content-Security-Policy "default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; font-src 'self' data: https://cdn.jsdelivr.net; img-src 'self' data: blob: https:; connect-src 'self' https: http://localhost http://127.0.0.1;";

    # ==================== æ—¥å¿—é…ç½® ====================
    access_log /var/log/nginx/mrgun_access.log;
    error_log /var/log/nginx/mrgun_error.log warn;

    # ==================== å®¢æˆ·ç«¯é…ç½® ====================
    client_max_body_size 10M;  # æœ€å¤§ä¸Šä¼ å¤§å°ï¼ˆå‘ç¥¨ç­‰ï¼‰
    client_body_timeout 60s;
    client_header_timeout 60s;

    # ==================== Gzip å‹ç¼© ====================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript
               application/json application/javascript application/xml+rss
               application/rss+xml font/truetype font/opentype
               application/vnd.ms-fontobject image/svg+xml;

    # ==================== å‰ç«¯é™æ€æ–‡ä»¶ï¼ˆå¼€å‘ç¯å¢ƒä»£ç†åˆ°frontendå®¹å™¨ï¼‰====================
    # ==================== Adminå’ŒFinance API ====================
    # Admin APIè·¯ç”±
    location /admin/api/ {
        proxy_pass http://backend:8000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        proxy_buffering off;
    }

    # Finance APIè·¯ç”±
    location /finance/api/ {
        proxy_pass http://backend:8000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        proxy_buffering off;
    }

    # å‰ç«¯è·¯ç”±æ”¯æŒï¼ˆVue.js å•é¡µåº”ç”¨ï¼‰
    location / {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ==================== åç«¯ API ä»£ç† ====================
    # FastAPI åç«¯æœåŠ¡ï¼ˆDockerç¯å¢ƒä½¿ç”¨å®¹å™¨åï¼‰
    # ä¿æŒè·¯å¾„ä¸å˜ï¼Œç›´æ¥è½¬å‘åˆ°åç«¯
    location /api/ {
        proxy_pass http://backend:8000/api/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # è¶…æ—¶é…ç½®ï¼ˆè´¢åŠ¡ç³»ç»Ÿå¯èƒ½æœ‰é•¿äº‹åŠ¡ï¼‰
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        # ç¦ç”¨ç¼“å†²ï¼ˆå®æ—¶å“åº”ï¼‰
        proxy_buffering off;

        # é™æµé…ç½®ï¼ˆå¯é€‰ï¼‰
        # limit_req zone=api burst=20 nodelay;
    }

    # ==================== ç®¡ç†åå° API ====================
    location /api/v1/admin/ {
        proxy_pass http://backend:8000;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # ç®¡ç†åå°å¯èƒ½æœ‰æ›´é•¿çš„è¶…æ—¶
        proxy_read_timeout 180s;
    }

    # ==================== WebSocket æ”¯æŒï¼ˆå¦‚æœéœ€è¦ï¼‰====================
    location /ws/ {
        proxy_pass http://backend:8000;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_read_timeout 86400;
    }

    # ==================== å¥åº·æ£€æŸ¥ ====================
    location /health {
        proxy_pass http://backend:8000/health;
        access_log off;
        proxy_set_header Host $host;
    }

    # ==================== API æ–‡æ¡£ï¼ˆç”Ÿäº§ç¯å¢ƒå¯ä»¥å…³é—­ï¼‰====================
    location /docs {
        proxy_pass http://backend:8000/docs;
        proxy_set_header Host $host;

        # ç”Ÿäº§ç¯å¢ƒå»ºè®®æ·»åŠ è®¤è¯æˆ–ç›´æ¥ç¦ç”¨
        # return 404;
    }

    location /redoc {
        proxy_pass http://backend:8000/redoc;
        proxy_set_header Host $host;

        # ç”Ÿäº§ç¯å¢ƒå»ºè®®æ·»åŠ è®¤è¯æˆ–ç›´æ¥ç¦ç”¨
        # return 404;
    }

    # ==================== é™æ€èµ„æºï¼ˆä¸Šä¼ æ–‡ä»¶ï¼‰====================
    # ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ - ä»£ç†åˆ°backendå®¹å™¨
    # ä½¿ç”¨ ^~ ä¿®é¥°ç¬¦é˜»æ­¢åç»­æ­£åˆ™åŒ¹é…
    location ^~ /uploads/ {
        proxy_pass http://backend:8000/uploads/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # ç¼“å­˜è®¾ç½®
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # å‘ç¥¨ PDF æ–‡ä»¶
    location /invoices/ {
        # ğŸ‘‡ ä¿®æ”¹ä¸ºä½ å®é™…çš„å‘ç¥¨ç›®å½•
        alias /opt/mr-game-ops/data/invoices/;

        expires 30d;
        add_header Cache-Control "public, immutable";

        # åªå…è®¸ç™»å½•ç”¨æˆ·è®¿é—®ï¼ˆéœ€è¦åç«¯éªŒè¯ï¼‰
        # æˆ–æ·»åŠ  IP ç™½åå•
    }

    # ==================== é™æ€èµ„æºç¼“å­˜ï¼ˆå¼€å‘ç¯å¢ƒä»£ç†åˆ°frontendï¼‰====================
    # CSS, JS æ–‡ä»¶
    location ~* \.(css|js)$ {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        expires 7d;
        add_header Cache-Control "public, must-revalidate";
    }

    # å›¾ç‰‡æ–‡ä»¶
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # å­—ä½“æ–‡ä»¶
    location ~* \.(woff|woff2|ttf|eot)$ {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # ==================== å®‰å…¨é…ç½® ====================
    # ç¦æ­¢è®¿é—®éšè—æ–‡ä»¶
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ç¦æ­¢è®¿é—®å¤‡ä»½æ–‡ä»¶
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ç¦æ­¢è®¿é—®æ•æ„Ÿæ–‡ä»¶
    location ~* \.(env|git|svn|htaccess|htpasswd)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ==================== ç›‘æ§ç«¯ç‚¹ï¼ˆä»…å†…ç½‘è®¿é—®ï¼‰====================
    # Prometheus metricsï¼ˆå¦‚æœæœ‰ï¼‰
    location /metrics {
        # åªå…è®¸æœ¬åœ°è®¿é—®
        allow 127.0.0.1;
        allow 172.16.0.0/12;  # å†…ç½‘ IP æ®µï¼Œæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹
        allow 172.20.0.0/16;  # Dockerå†…ç½‘
        allow 172.21.0.0/16;  # Dockerå†…ç½‘ï¼ˆç”Ÿäº§ï¼‰
        deny all;

        proxy_pass http://backend:8000/metrics;
        access_log off;
    }
}

# ============================================================================
# ç›‘æ§é¢æ¿é…ç½®ï¼ˆå¯é€‰ - ä»…é€šè¿‡å†…ç½‘æˆ– VPN è®¿é—®ï¼‰
# ============================================================================
# å¦‚æœéœ€è¦é€šè¿‡å…¬ç½‘è®¿é—®ç›‘æ§ï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Šå¹¶æ·»åŠ è®¤è¯
#
# server {
#     listen 3001 ssl http2;
#     server_name mrgun.chu-jiao.com;
#
#     ssl_certificate /etc/ssl/certs/mrgun.chu-jiao.com.pem;
#     ssl_certificate_key /etc/ssl/private/mrgun.chu-jiao.com.key;
#     ssl_protocols TLSv1.2 TLSv1.3;
#
#     # HTTP åŸºç¡€è®¤è¯
#     auth_basic "Monitoring Dashboard";
#     auth_basic_user_file /etc/nginx/.htpasswd;
#
#     # Grafana
#     location / {
#         proxy_pass http://127.0.0.1:3000;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }
