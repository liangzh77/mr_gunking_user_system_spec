# Feature Specification: MR游戏运营管理系统

**Feature Branch**: `001-mr`
**Created**: 2025-10-10
**Status**: Draft
**Input**: User description: "MR游戏运营管理系统 - 游戏授权计费平台"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 游戏授权与实时计费 (Priority: P1)

运营商在现场部署头显Server，当玩家启动MR游戏时，系统自动验证运营商授权、检查余额、按玩家数量扣费并返回授权令牌，确保只有付费后游戏才能启动。

**Why this priority**: 这是系统的核心价值 - 没有授权和计费，整个商业模式无法运转。所有其他功能都依赖于这个基础能力。

**Independent Test**: 部署一个头显Server，配置运营商凭证，启动任意游戏，验证扣费成功且游戏可启动；余额不足时游戏启动失败并显示明确错误。

**Acceptance Scenarios**:

1. **Given** 运营商账户余额充足且已授权"太空探险"应用，**When** 头显Server请求启动5人游戏（单价10元），**Then** 系统扣费50元并返回授权Token，游戏成功启动
2. **Given** 运营商账户余额仅剩30元，**When** 头显Server请求启动5人游戏（需50元），**Then** 系统拒绝授权并返回"余额不足"错误，游戏无法启动
3. **Given** 运营商未授权"太空探险"应用，**When** 头显Server请求启动游戏，**Then** 系统拒绝授权并返回"应用未授权"错误
4. **Given** 游戏要求2-8人，**When** 请求启动1人或9人游戏，**Then** 系统拒绝授权并返回"玩家数量超出范围"错误
5. **Given** 同一会话ID已成功授权，**When** 重复发送相同请求，**Then** 系统返回已存在的授权信息，不重复扣费

---

### User Story 2 - 运营商账户与财务管理 (Priority: P1)

运营商可以注册账户、在线充值、查看实时余额、查看交易记录（充值/消费），并在需要时申请退款（仅退当前余额）和开具发票。

**Why this priority**: 运营商必须能够管理资金才能使用系统。充值是扣费的前提，财务透明度是信任的基础。

**Independent Test**: 创建运营商账户，通过微信/支付宝充值100元，启动游戏消费50元，查看余额为50元，申请退款并通过审核后余额归零。

**Acceptance Scenarios**:

1. **Given** 新用户访问系统，**When** 填写用户名、姓名、电话、邮箱并提交，**Then** 账户创建成功，自动生成64位API Key，余额为0
2. **Given** 运营商登录系统，**When** 选择充值100元并完成微信支付，**Then** 账户余额增加100元，交易记录显示充值明细
3. **Given** 运营商已消费50元（余额剩50元），**When** 申请退款，**Then** 财务人员审核通过后系统退还50元，余额清零，账户仍可正常使用
4. **Given** 运营商账户有充值记录，**When** 申请开具发票，**Then** 系统生成电子发票并提供下载链接
5. **Given** 充值过程中支付平台返回失败，**When** 系统接收回调，**Then** 账户余额不变，充值记录标记为"失败"

---

### User Story 3 - 运营点与应用授权管理 (Priority: P2)

运营商可以创建多个运营点（例如不同门店），为每个运营点配置头显Server关联关系，并查看已授权的应用列表（含价格、玩家数范围），以及申请新应用的使用权限。

**Why this priority**: 运营商通常有多个线下门店，需要分别管理。应用授权是游戏启动的前置条件，必须由管理员批准。

**Independent Test**: 创建两个运营点"北京门店"和"上海门店"，为北京门店的头显Server配置凭证，查看已授权应用列表显示"太空探险"（10元/人，2-8人），申请新应用"星际战争"并等待审核。

**Acceptance Scenarios**:

1. **Given** 运营商登录系统，**When** 创建运营点"北京门店"（地址：北京朝阳区），**Then** 运营点创建成功，可在列表中查看
2. **Given** 运营点已创建，**When** 头显Server首次配置时输入运营商ID和API Key并选择"北京门店"，**Then** 验证成功并保存配置到本地
3. **Given** 管理员已授权"太空探险"应用，**When** 运营商查看已授权应用，**Then** 列表显示"太空探险"（单价10元/人，2-8人，永久授权）
4. **Given** 运营商需要新应用，**When** 提交"星际战争"应用授权申请并填写原因，**Then** 申请提交成功，状态为"待审核"
5. **Given** 运营点不再使用，**When** 运营商删除运营点，**Then** 运营点标记为已删除（逻辑删除），历史数据保留

---

### User Story 4 - 使用记录与多维度统计 (Priority: P2)

运营商可以查看每次游戏的详细记录（时间、运营点、应用、玩家数、单价、总费用），并通过可视化图表查看消费趋势（按日/周/月、按应用、按运营点），支持数据导出。

**Why this priority**: 运营商需要了解经营数据（哪个门店最赚钱、哪个游戏最受欢迎）以优化业务策略。

**Independent Test**: 在两个运营点分别启动不同游戏，查看使用记录显示两条明细，查看按运营点统计图表显示各自消费额，导出Excel报表包含所有数据。

**Acceptance Scenarios**:

1. **Given** 运营商已消费3次游戏，**When** 查看使用记录，**Then** 显示3条记录（每条含游戏时间、运营点、应用名、玩家数、单价、总费用）
2. **Given** 运营商在"北京门店"玩"太空探险"5次，"上海门店"玩"星际战争"3次，**When** 查看按运营点统计，**Then** 柱状图显示北京门店消费额 > 上海门店
3. **Given** 运营商本月消费10次，**When** 选择"本月"时间维度，**Then** 折线图显示每日消费趋势
4. **Given** 运营商需要对账，**When** 导出消费记录，**Then** 下载Excel文件包含所有交易明细
5. **Given** 运营商查看"太空探险"应用统计，**When** 点击应用筛选，**Then** 显示总场次、总玩家人次、平均每场玩家数、总消费金额

---

### User Story 5 - 管理员权限与应用配置 (Priority: P2)

系统管理员可以创建运营商账户、为运营商授权应用使用权限、配置应用价格（单人价格）、设置玩家数量范围（最小/最大值），并管理运营商API Key（查看、强制重置）。

**Why this priority**: 管理员控制系统资源分配和定价策略，是系统运营的中枢。没有管理员操作，运营商无法获得应用授权。

**Independent Test**: 管理员登录后台，创建运营商账户，为其授权"太空探险"应用并设置单价10元、玩家范围2-8人，查看该运营商API Key，强制重置后旧Key失效。

**Acceptance Scenarios**:

1. **Given** 管理员登录系统，**When** 创建新运营商账户（填写姓名、电话、邮箱），**Then** 账户创建成功并自动生成API Key，分类默认为"普通客户"
2. **Given** 运营商申请"太空探险"应用授权，**When** 管理员审批通过并设置单价10元、玩家范围2-8人、永久授权，**Then** 运营商可立即使用该应用
3. **Given** 应用价格需要调整，**When** 管理员将"太空探险"单价从10元改为12元，**Then** 新价格立即生效（新游戏按12元计费），历史记录保持10元
4. **Given** 运营商API Key泄露，**When** 管理员强制重置API Key，**Then** 生成新的64位密钥，旧密钥立即失效，运营商需重新配置头显Server
5. **Given** 大客户需要VIP服务，**When** 管理员将客户分类从"普通客户"改为"VIP客户"，**Then** 客户标记更新，可用于后续财务分析

---

### User Story 6 - 财务后台与审计 (Priority: P3)

财务人员可以查看整体收入概览（今日充值/消费/退款/净收入）、分析大客户消费情况（TOP客户收入占比）、审核退款申请（查看运营商总充值/总消费/当前余额）、生成日/周/月财务报表并导出，所有操作记录审计日志。

**Why this priority**: 财务透明和审计合规是企业运营的必要条件，但不影响核心业务流程，可后置实现。

**Independent Test**: 财务人员登录后台，查看今日收入仪表盘显示充值1000元、消费500元、净收入500元，查看TOP5客户列表，审核一笔退款申请并通过，导出本月财务报表PDF，查看审计日志显示所有操作记录。

**Acceptance Scenarios**:

1. **Given** 财务人员登录系统，**When** 查看财务仪表盘，**Then** 显示今日充值总额、消费总额、退款总额、净收入，以及本月趋势折线图
2. **Given** 系统有50个运营商，**When** 查看大客户分析，**Then** 按总消费额降序显示TOP10客户，标注VIP标记，显示消费占比
3. **Given** 运营商申请退款100元，**When** 财务人员审核时查看详情，**Then** 显示该运营商总充值500元、总消费400元、当前余额100元，审核通过后余额清零
4. **Given** 财务人员需要生成报表，**When** 选择"本月报表"并导出PDF，**Then** 下载文件包含收入统计、大客户数据、使用统计三部分
5. **Given** 财务人员审核退款，**When** 操作完成后查看审计日志，**Then** 记录显示"退款审核通过 - 运营商ID: xxx - 金额: 100元 - IP: xxx.xxx.xxx.xxx"

---

### User Story 7 - 数据统计人员全局报表 (Priority: P3)

数据统计人员可以查看全局运营数据（所有运营商的使用情况），按运营者/运营点/应用/时间段多维度交叉分析，生成统计报表并导出，包括玩家数量分布统计。

**Why this priority**: 用于战略决策和产品优化，但不影响日常运营，优先级较低。

**Independent Test**: 数据统计人员登录，查看按应用统计报表显示"太空探险"总场次100次、总玩家人次450人、平均每场4.5人，筛选"北京区域运营点"显示该区域消费趋势，导出CSV报表。

**Acceptance Scenarios**:

1. **Given** 数据统计人员登录，**When** 查看全局统计仪表盘，**Then** 显示总运营商数、总游戏场次、总玩家人次、总收入
2. **Given** 需要分析应用受欢迎程度，**When** 按应用统计，**Then** 显示每个应用的场次、玩家人次、平均玩家数、总消费额排行
3. **Given** 需要分析玩家数量偏好，**When** 查看玩家数量分布统计，**Then** 显示2人游戏占比、3-4人占比、5-8人占比的饼图
4. **Given** 需要对比不同运营点表现，**When** 选择多个运营点并按时间查看，**Then** 显示多条折线对比图
5. **Given** 需要导出数据给管理层，**When** 导出CSV报表，**Then** 下载文件包含所有维度的汇总数据

---

### User Story 8 - 消息通知与系统公告 (Priority: P3)

运营商可以接收系统通知（应用价格调整、余额不足提醒、授权到期提醒），查看消息列表（已读/未读状态），查看历史公告记录。

**Why this priority**: 改善用户体验和信息及时性,但不影响核心功能，可最后实现。

**Independent Test**: 管理员发布"太空探险"价格上调公告，运营商登录后看到未读消息提醒，点击查看详情后标记为已读，查看历史消息列表显示所有公告。

**Acceptance Scenarios**:

1. **Given** 管理员发布系统公告"春节假期运营时间调整"，**When** 运营商登录，**Then** 消息中心显示1条未读消息
2. **Given** 运营商余额低于100元，**When** 系统检测到低余额，**Then** 自动发送"余额不足"提醒消息
3. **Given** 应用价格调整，**When** 管理员保存新价格，**Then** 所有授权该应用的运营商收到"价格调整通知"
4. **Given** 运营商有5条未读消息，**When** 点击查看其中1条，**Then** 该消息标记为已读，未读数变为4
5. **Given** 运营商需要查看历史公告，**When** 查看消息历史，**Then** 按时间倒序显示所有消息，区分已读/未读状态

---

### Edge Cases

- **并发授权冲突**: 同一运营商的两个运营点同时请求授权，余额仅够支付一次游戏，如何处理？（使用数据库行级锁，先到先得，后者返回余额不足）
- **支付回调延迟**: 运营商完成支付但回调延迟5分钟到达，期间运营商看到余额未更新，如何处理？（显示"充值处理中"状态，超时5分钟自动查询支付平台）
- **退款审核期间消费**: 财务人员审核退款时运营商又消费50元，可退余额变化，如何处理？（审核通过时重新计算当前余额并扣除，不退历史余额）
- **API Key泄露后恶意扣费**: 运营商API Key被盗用，恶意启动大量游戏导致余额耗尽，如何处理？（实施频率限制，单运营商每分钟最多授权10次，异常IP检测并锁定账户）
- **游戏中途崩溃**: 游戏启动并扣费后，运行5分钟时头显Server崩溃，运营商是否可以退费？（不退费，启动时一次性扣费模式，崩溃风险由运营商承担）
- **应用价格调整时机**: 管理员调价时有游戏正在进行授权请求，如何确定使用旧价还是新价？（授权请求时获取当时价格并锁定，请求完成前不受调价影响）
- **逻辑删除的数据查询**: 运营商注销后历史数据如何展示给管理员？（管理员查询时默认不显示已注销账户，需手动勾选"包含已注销"选项）
- **重复会话ID冲突**: 不同运营商的头显Server生成相同会话ID，如何避免冲突？（会话ID必须包含运营商ID前缀，格式: {operatorId}_{timestamp}_{random}）

---

## Requirements *(mandatory)*

### Functional Requirements

#### 账户与身份管理

- **FR-001**: 系统必须允许新用户注册运营商账户（必填：用户名、真实姓名/公司名、联系电话、邮箱）
- **FR-002**: 系统必须在账户创建时自动生成64位随机API Key用于头显Server身份认证
- **FR-003**: 系统必须支持运营商登录/退出功能，会话保持30天（可配置）
- **FR-004**: 系统必须支持运营商手动重新生成API Key，旧Key立即失效
- **FR-005**: 系统必须支持账户注销（逻辑删除），注销后无法登录但数据永久保留供分析
- **FR-006**: 系统必须为运营商分配客户分类（VIP/普通/试用），支持管理员调整

#### 财务管理

- **FR-007**: 系统必须支持在线充值（微信支付、支付宝），充值成功后实时更新账户余额
- **FR-008**: 系统必须在充值失败时自动回滚事务，账户余额不变
- **FR-009**: 系统必须记录所有交易流水（类型：充值/消费，金额、时间、关联资源）
- **FR-010**: 系统必须支持运营商申请退款，仅退还当前账户余额（已消费金额不退）
- **FR-011**: 系统必须在财务人员审核退款时重新计算可退余额（防止审核期间有新消费）
- **FR-012**: 系统必须支持运营商申请电子发票，财务审核通过后生成PDF下载链接
- **FR-013**: 系统必须在余额低于设定阈值（默认100元）时发送余额不足提醒

#### 游戏授权与计费

- **FR-014**: 系统必须验证头显Server提交的API Key有效性（64位字符匹配）
- **FR-015**: 系统必须验证运营商对请求应用的授权状态（是否已授权、是否过期）
- **FR-016**: 系统必须验证请求的玩家数量在应用允许范围内（minPlayers ≤ playerCount ≤ maxPlayers）
- **FR-017**: 系统必须按公式计算费用：总费用 = 玩家数量 × 应用单人价格
- **FR-018**: 系统必须在余额充足时扣费并返回授权Token（UUID格式）
- **FR-019**: 系统必须在余额不足时拒绝授权并返回错误码及明确错误信息
- **FR-020**: 系统必须使用会话ID（sessionId）防止重复扣费，相同会话ID重复请求返回已授权信息
- **FR-021**: 系统必须在授权成功时创建使用记录（时间、运营点、应用、玩家数、单价、总费用、会话ID）
- **FR-022**: 系统必须使用数据库事务确保扣费和授权记录的原子性（要么都成功，要么都回滚）
- **FR-023**: 系统必须在授权请求时锁定运营商账户余额（行级锁），防止并发扣费冲突

#### 运营点管理

- **FR-024**: 系统必须允许运营商创建运营点（必填：名称、地址）
- **FR-025**: 系统必须允许运营商编辑运营点信息（名称、地址）
- **FR-026**: 系统必须支持运营点逻辑删除，删除后历史数据保留但不可再使用
- **FR-027**: 系统必须允许头显Server配置关联运营点（验证API Key后选择运营点并保存到本地配置）

#### 应用授权管理

- **FR-028**: 系统必须允许管理员创建应用（必填：应用名称、单人价格、最小玩家数、最大玩家数）
- **FR-029**: 系统必须允许管理员为运营商授权应用（选择运营商、应用、设置授权有效期：永久/指定日期）
- **FR-030**: 系统必须允许运营商查看已授权应用列表（含单价、玩家数范围、授权有效期）
- **FR-031**: 系统必须允许运营商申请新应用授权（填写申请原因），状态为"待审核"
- **FR-032**: 系统必须允许管理员审批应用授权申请（通过/拒绝），通过后立即生效
- **FR-033**: 系统必须允许管理员调整应用价格，新价格立即生效但不影响历史记录中的旧价格

#### 使用记录与统计

- **FR-034**: 系统必须记录每次游戏的使用明细（游戏时间、运营点、应用、玩家数、单价、总费用、游戏时长）
- **FR-035**: 系统必须提供使用记录查询功能（支持按时间、运营点、应用筛选）
- **FR-036**: 系统必须提供消费统计图表（折线图、柱状图），支持日/周/月时间维度
- **FR-037**: 系统必须提供按应用统计（总场次、总玩家人次、平均玩家数、总消费额）
- **FR-038**: 系统必须提供按运营点统计（各运营点的场次、玩家人次、消费额）
- **FR-039**: 系统必须支持导出使用记录和统计报表（Excel/CSV格式）

#### 后台管理

- **FR-040**: 系统必须支持系统管理员创建运营商账户并分配初始客户分类
- **FR-041**: 系统必须允许管理员查看运营商API Key并支持强制重置
- **FR-042**: 系统必须支持财务人员独立登录（不同于运营商账号），权限包括查看财务数据、审核退款/发票
- **FR-043**: 系统必须为财务人员提供财务仪表盘（今日充值/消费/退款/净收入、本月趋势图）
- **FR-044**: 系统必须为财务人员提供大客户分析（按消费额排序、TOP10客户、VIP标记、收入占比）
- **FR-045**: 系统必须为财务人员提供日/周/月财务报表生成功能（PDF/Excel导出）
- **FR-046**: 系统必须记录财务人员所有操作的审计日志（操作类型、目标资源、详情、IP地址）
- **FR-047**: 系统必须支持数据统计人员查看全局运营数据（所有运营商的使用情况）
- **FR-048**: 系统必须支持多维度交叉分析（运营者×应用、运营点×时间、应用×玩家数分布）

#### 消息通知

- **FR-049**: 系统必须在应用价格调整时向所有授权该应用的运营商发送通知
- **FR-050**: 系统必须在运营商余额不足时发送提醒消息
- **FR-051**: 系统必须支持管理员发布系统公告（全体运营商可见）
- **FR-052**: 系统必须为运营商提供消息中心（显示未读数、已读/未读状态、历史记录）

#### 安全与合规

- **FR-053**: 系统必须使用HTTPS（TLS 1.3）加密所有外部API通信
- **FR-054**: 系统必须对敏感数据（API Key、支付信息）进行AES-256加密存储
- **FR-055**: 系统必须实施请求频率限制（单运营商每分钟最多10次授权请求）
- **FR-056**: 系统必须检测异常IP访问（短时间内多次失败或超频率请求），自动锁定账户
- **FR-057**: 系统必须记录所有授权请求的审计日志（运营商ID、运营点、应用、玩家数、结果、时间、IP）

### Key Entities

- **运营商账户（Operator Account）**: 使用系统的付费客户，包含用户名、姓名/公司名、电话、邮箱、API Key、余额、客户分类（VIP/普通/试用）、注销状态
- **运营点（Operation Site）**: 运营商的线下门店或业务单元，包含名称、地址、关联运营商、删除状态
- **应用（Application）**: 可授权的MR游戏，包含应用名称、单人价格、最小玩家数、最大玩家数、创建时间
- **运营者应用授权（Operator App Authorization）**: 运营商与应用的多对多授权关系，包含运营商ID、应用ID、授权有效期（永久/指定日期）、授权时间
- **使用记录（Usage Record）**: 每局游戏的记录，包含游戏时间、运营点、应用、玩家数、单人价格（快照）、总费用、会话ID、游戏时长
- **交易记录（Transaction Record）**: 充值和消费流水，包含类型（充值/消费）、金额、时间、关联使用记录ID（消费时）、支付渠道（充值时）
- **发票记录（Invoice Record）**: 开票申请和历史，包含申请运营商、申请金额、申请时间、审核状态、发票文件链接
- **退款记录（Refund Record）**: 退款申请和处理，包含申请运营商、申请金额、实际退款金额、申请时间、审核状态、审核人（财务账号ID）、审核时间
- **财务账号（Finance Account）**: 财务人员独立账号，包含用户名、姓名、电话、角色（专员/经理/审计）、权限配置（JSON：canReviewRefund, canExportReport等）
- **财务操作记录（Finance Operation Log）**: 财务人员操作审计，包含财务账号ID、操作类型、目标资源ID、操作详情、IP地址、时间
- **消息通知（Message Notification）**: 系统消息和公告，包含标题、内容、发送时间、接收运营商（全体/特定），已读状态
- **API Key使用记录（API Key Usage Log）**: 头显Server授权请求日志，包含API Key、运营点、应用、请求结果、时间、IP地址

### Assumptions

- **支付平台回调时效**: 假设微信/支付宝支付回调正常在30秒内到达，超时5分钟后系统主动查询支付平台确认结果
- **游戏时长记录**: 假设头显Server在游戏结束时上报游戏时长（可选），如未上报则使用系统当前时间 - 授权时间作为估算
- **API Key生成算法**: 使用密码学安全的随机数生成器（如Python的secrets模块或Node.js的crypto模块）
- **会话ID格式**: {operatorId}_{timestamp}_{random16位} 确保全局唯一性
- **授权Token有效期**: Token无实际有效期限制，仅作为游戏启动凭证，头显Server本地验证即可
- **余额不足阈值**: 默认100元，后续可通过配置文件调整
- **财务报表生成时机**: 日报每日凌晨1点自动生成，周报每周一凌晨生成，月报每月1日凌晨生成
- **逻辑删除保留期**: 已删除数据永久保留，不物理删除（合规要求）
- **并发授权上限**: 单运营商同时最多10个并发授权请求，超过则排队等待
- **价格调整生效时间**: 立即生效，无缓冲期，运营商通过消息通知提前告知
- **客户分类判定标准**: 月消费≥10000元自动标记为VIP，<1000元为普通，0消费为试用

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 运营商从注册到首次游戏授权成功的完整流程在10分钟内完成（包括充值、应用授权申请审批、头显Server配置）
- **SC-002**: 游戏授权请求的响应时间在99%情况下低于2秒
- **SC-003**: 系统支持单运营商同时启动10个游戏（不同运营点）时无授权冲突或扣费错误
- **SC-004**: 充值成功率达到99.5%（排除用户主动取消或支付平台故障）
- **SC-005**: 退款审核流程从申请到完成平均耗时低于24小时
- **SC-006**: 财务报表生成时间在5分钟内完成（包含全年数据）
- **SC-007**: 运营商可在3次点击内查看到任意维度的统计图表（运营点/应用/时间）
- **SC-008**: 系统检测到API Key异常使用（盗用）并锁定账户的响应时间低于1分钟
- **SC-009**: 使用记录和交易记录导出功能支持10万条数据在30秒内完成Excel生成
- **SC-010**: 消息通知在事件发生后30秒内推送到运营商消息中心
- **SC-011**: 系统可用性达到99.5%（每月停机时间不超过3.6小时）
- **SC-012**: 并发扣费冲突（同一运营商同时授权）的数据一致性准确率100%（无重复扣费或遗漏扣费）
