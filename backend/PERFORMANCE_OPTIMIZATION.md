# 性能优化记录

## T275: API 响应时间优化

### 优化 1: 降低 bcrypt rounds (2025-10-18)

**问题诊断:**
- 管理员登录 API P95 响应时间: 281.62ms
- NFR-001 要求: P95 < 100ms
- 主要瓶颈: bcrypt 密码验证（rounds=12 约需 250ms/次）

**优化方案:**
将 bcrypt rounds 从 12 降低到 10

**安全性评估:**
- OWASP 推荐最小值: rounds ≥ 10
- rounds=10 仍然提供足够的安全性
- 2^10 = 1024 次迭代，足以防止暴力破解

**实施变更:**
- 文件: `backend/src/core/utils/password.py`
- 修改: `bcrypt__rounds=12` → `bcrypt__rounds=10`

**性能测试结果:**

| 测试运行 | P95 (before) | P95 (after) | 改进 |
|---------|-------------|-------------|------|
| Run 1   | 281.62ms    | 99.43ms     | -64.7% |
| Run 2   | 281.62ms    | 154.69ms    | -45.1% |
| 平均    | 281.62ms    | ~127ms      | -54.9% |

**结论:**
- ✅ 显著改善性能（平均提升 ~55%）
- ⚠️ P95 在 99-155ms 之间波动，接近但不稳定达标 NFR-001
- 📌 需要额外优化来稳定达标

---

### 优化 2: 数据库索引 (计划中)

**目标:**
为 `admin_accounts.username` 和 `operator_accounts.username` 添加索引

**当前状态:**
- 已创建迁移文件: `20251018_1347_10567dfc9d13_add_index_on_username_fields.py`
- ⚠️ 测试环境使用 SQLite，无法应用 PostgreSQL 迁移
- 需要在生产环境（PostgreSQL）中应用

**预期效果:**
- SELECT by username 查询: O(n) → O(log n)
- 预计节省 5-10ms

---

### 优化 3: 异步更新 last_login (待实施)

**问题:**
每次登录都同步更新 `last_login_at` 和 `last_login_ip`，需要等待 commit

**优化方案:**
将 last_login 更新改为异步/后台任务，不阻塞登录响应

**预期效果:**
- 节省 10-20ms
- 提升用户体验

---

## 下一步行动

1. ✅ 提交 bcrypt rounds 优化
2. ⏭️ 在生产环境应用数据库索引迁移
3. ⏭️ 实施异步 last_login 更新
4. ⏭️ T273: 优化其他数据库查询
5. ⏭️ T274: 实现 Redis 缓存

---

## 性能基线对比

### 管理员登录 API

| 指标 | 初始基线 | 优化后 (rounds=10) | 目标 (NFR-001) |
|-----|---------|-------------------|---------------|
| 平均 | 276.66ms | ~100ms | < 100ms |
| P50  | 275.54ms | ~94ms  | < 100ms |
| P95  | 281.62ms | ~127ms | **< 100ms** |
| P99  | 344.73ms | ~165ms | < 100ms |

**当前状态:** 🟡 接近达标，需要额外优化来稳定满足 NFR-001
